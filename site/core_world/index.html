<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>第一、世界和客户端 - 交通仿真文档</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u7b2c\u4e00\u3001\u4e16\u754c\u548c\u5ba2\u6237\u7aef";
        var mkdocs_page_input_path = "core_world.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 交通仿真文档
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">主页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">交通仿真文档</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">第一、世界和客户端</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/core_world.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">第一、世界和客户端</h1>
<p>客户端和世界是 Carla 的两个基本要素，是操作仿真及其参与者的必要抽象。 </p>
<p>本教程从定义这些元素的基础知识和创建，到描述它们的可能性。如果阅读过程中出现任何疑问或问题，<a href="https://github.com/carla-simulator/carla/discussions/">Carla 论坛</a> 可以为您解决。</p>
<ul>
<li><a href="#the-client"><strong>客户端</strong></a>  <ul>
<li><a href="#client-creation">客户端创建</a>  </li>
<li><a href="#world-connection">世界连接</a>  </li>
<li><a href="#other-client-utilities">其他客户端实用程序</a>  </li>
</ul>
</li>
<li><a href="#the-world"><strong>世界</strong></a>  <ul>
<li><a href="#actors">参与者</a>  </li>
<li><a href="#weather">天气</a>  </li>
<li><a href="#lights">灯光</a>  </li>
<li><a href="#debugging">调试</a>  </li>
<li><a href="#world-snapshots">世界快照</a>  </li>
<li><a href="#world-settings">世界设置</a>  </li>
</ul>
</li>
</ul>
<hr />
<h2 id="_2">客户端</h2>
<p>客户端是 Carla 架构中的主要元素之一。它们连接到服务器、检索信息并更改命令。这是通过脚本完成的。客户端识别自己的身份，并连接到世界，然后进行仿真操作。</p>
<p>除此之外，客户还可以访问高级 Carla 模块、功能并应用命令批处理。本节仅介绍命令批处理。这些对于诸如生成大量参与者之类的基本事情很有用。其余功能更加复杂，将在 <strong>高级步骤</strong> 中各自的页面中进行解决。 </p>
<p>查看 Python API 参考中的 <a href="../python_api/#carla.Client"><strong>carla.Client</strong></a> 以了解该类的特定方法和变量。</p>
<h3 id="_3">客户端创建</h3>
<p>需要两件事。标识它的 <strong>IP</strong> 地址以及与服务器通信的 <strong>两个 TCP 端口</strong> 。可选的第三个参数设置工作线程的数量。默认情况下，该值设置为全部 (<code>0</code>)。Python API 参考中的<a href="../python_api/#carla.Client.__init__">carla.Client</a> 包含一个片段，显示如何在运行脚本时将这些解析为参数。</p>
<pre><code class="language-py">client = carla.Client('localhost', 2000)
</code></pre>
<p>默认情况下，Carla 使用本地主机 IP 和端口 2000 进行连接，但这些可以随意更改。在本例中，第二个端口始终为<code>n+1</code>,2001。</p>
<p>创建客户端后，设置其 <strong>time-out</strong> 。这限制了所有网络操作，以便这些操作不会永远阻止客户端。如果连接失败，将返回错误。</p>
<pre><code class="language-py">client.set_timeout(10.0) # 秒
</code></pre>
<p>可以连接许多客户端，因为一次运行多个脚本是很常见的。在具有高级 Carla 功能（例如交通管理器）的多客户端方案中工作，必然会使通信更加复杂。</p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>客户端和服务器有不同的<code>libcarla</code>模块。如果版本不同，可能会出现问题。这可以使用<code>get_client_version()</code>和<code>get_server_version()</code>方法进行检查。</p>
</div>
<h3 id="_4">世界连接</h3>
<p>客户端可以相当轻松地连接和检索当前世界。</p>
<pre><code class="language-py">world = client.get_world()
</code></pre>
<p>客户端还可以获得可用地图列表来更改当前地图。这将销毁当前的世界并创造一个新的世界。</p>
<pre><code class="language-py">print(client.get_available_maps())
...
world = client.load_world('Town01')
# client.reload_world() 创建一个相同地图世界的新实例。
</code></pre>
<p>每个世界对象都有一个 <code>id</code> 或世代。每当客户端调用 <code>load_world()</code> 或 <code>reload_world()</code> 时，前一个被销毁。一个新的世代是从头开始创建的。在此过程中虚幻引擎不会重新启动。</p>
<h3 id="_5">使用命令</h3>
<p><strong>命令</strong> 是一些最常见的 Carla 方法的改编，可以批量应用。例如，<a href="../python_api/#command.SetAutopilot">command.SetAutopilot</a> 相当于<a href="../python_api/#command.SetAutopilot">command.SetAutopilot</a> ，启用车辆的自动驾驶功能。但是，使用<a href="../python_api/#carla.Client.apply_batch">Client.apply_batch</a> 或<a href="../python_api/#carla.Client.apply_batch_sync">Client.apply_batch_sync()</a> 方法，可以在一个仿真步骤中应用一系列命令。这对于通常应用于数百个元素的方法来说变得非常有用。</p>
<p>以下示例使用批处理一次性销毁一系列车辆。</p>
<pre><code class="language-py">client.apply_batch([carla.command.DestroyActor(x) for x in vehicles_list])
</code></pre>
<p>Python API 参考的 <a href="../python_api/#command.ApplyAngularVelocity">最新部分</a> 列出了所有可用的命令。</p>
<h3 id="_6">其他客户端实用程序</h3>
<p>客户端对象的主要目的是获取或改变世界，并应用命令。但是，它还提供对一些附加功能的访问。 </p>
<ul>
<li><strong>交通管理器。</strong> 该模块负责每辆设置为自动驾驶的车辆以重建城市交通。</li>
<li><strong><a href="../adv_recorder/">记录器</a>.</strong> 允许重新进行以前的仿真。使用 <a href="./#world-snapshots">快照</a> 总结每帧的仿真状态。</li>
</ul>
<hr />
<h2 id="_7">世界</h2>
<p>仿真的主要标尺。它的实例应该由客户端检索。它不包含世界本身的模型，这是 <a href="../core_map/">Map</a> 类的一部分。相反，大多数信息和常规设置可以从此类访问。</p>
<ul>
<li>仿真中的参与者和观察者。</li>
<li>蓝图库。</li>
<li>地图。</li>
<li>仿真设置。</li>
<li>快照。</li>
<li>天气和灯光管理器。</li>
</ul>
<p>它的一些最重要的方法是 <em>getters</em> ，精确地检索这些元素的信息或实例。查看 <a href="../python_api/#carla.World">carla.World</a> 了解更多信息。</p>
<h3 id="_8">参与者</h3>
<p>世界上有不同的与参与者相关的方法，允许不同的功能。</p>
<ul>
<li>生成参与者（但不销毁他们）。</li>
<li>获得场景中的每一位参与者，或者找到一个特定的参与者</li>
<li>访问蓝图库。  </li>
<li>访问观察参与者、仿真的视角。 </li>
<li>检索适合生成参与者的随机位置。</li>
</ul>
<p>生成将在 <a href="../core_actors/">第二部分、参与者和蓝图</a> 。需要对蓝图库、属性等有一定的了解。</p>
<h3 id="_9">天气</h3>
<p>天气本身并不是一个类，而是一组可从世界获取的参数。参数化包括太阳方向、云量、风、雾等等。辅助类<a href="../python_api/#carla.WeatherParameters">carla.WeatherParameters</a> 用于定义自定义天气。</p>
<pre><code class="language-py">weather = carla.WeatherParameters(
    cloudiness=80.0,
    precipitation=30.0,
    sun_altitude_angle=70.0)

world.set_weather(weather)

print(world.get_weather())
</code></pre>
<p>有一些天气预设可以直接应用于世界。这些列在<a href="../python_api/#carla.WeatherParameters">carla.WeatherParameters</a> 中并可作为枚举访问。 </p>
<pre><code class="language-py">world.set_weather(carla.WeatherParameters.WetCloudySunset)
</code></pre>
<p>还可以使用 Carla 提供的两个脚本来自定义天气。</p>
<ul>
<li><strong><code>environment.py</code></strong> <em>(在 <code>PythonAPI/util</code> 目录下)</em> — 提供对天气和光照参数的访问，以便可以实时更改这些参数。</li>
</ul>
<details>
<summary> <b>environment.py</b>  中的可选参数 </summary>


<pre><code class="language-sh">  -h, --help            show this help message and exit
  --host H              IP of the host server (default: 127.0.0.1)
  -p P, --port P        TCP port to listen to (default: 2000)
  --sun SUN             Sun position presets [sunset | day | night]
  --weather WEATHER     Weather condition presets [clear | overcast | rain]
  --altitude A, -alt A  Sun altitude [-90.0, 90.0]
  --azimuth A, -azm A   Sun azimuth [0.0, 360.0]
  --clouds C, -c C      Clouds amount [0.0, 100.0]
  --rain R, -r R        Rain amount [0.0, 100.0]
  --puddles Pd, -pd Pd  Puddles amount [0.0, 100.0]
  --wind W, -w W        Wind intensity [0.0, 100.0]
  --fog F, -f F         Fog intensity [0.0, 100.0]
  --fogdist Fd, -fd Fd  Fog Distance [0.0, inf)
  --wetness Wet, -wet Wet
                        Wetness intensity [0.0, 100.0]
</code></pre>

</details>
<p><br></p>
<ul>
<li><strong><code>dynamic_weather.py</code></strong> <em>(在 <code>PythonAPI/examples</code> 目录下)</em> — 启用开发人员为每张 Carla 地图准备的特定天气周期。</li>
</ul>
<details>
<summary> <b>dynamic_weather.py</b> 中的可选参数 </summary>


<pre><code class="language-sh">  -h, --help            show this help message and exit
  --host H              IP of the host server (default: 127.0.0.1)
  -p P, --port P        TCP port to listen to (default: 2000)
  -s FACTOR, --speed FACTOR
                        rate at which the weather changes (default: 1.0)
</code></pre>

</details>
<p><br></p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>天气的变化不会影响物理。它们只是相机传感器可以捕获的视觉效果。</p>
</div>
<p><strong>当 sun_altitude_angle &lt; 0 时，夜间模式开始</strong>，这被认为是日落。这是灯光变得特别重要的时候。</p>
<h3 id="_10">灯光</h3>
<ul>
<li>当仿真进入夜间模式时， <strong>路灯</strong> 会自动打开。灯光由地图开发人员放置，并可作为 <a href="../python_api/#carla.Light"><strong>carla.Light</strong></a> 对象访问。颜色和强度等属性可以随意更改。<a href="../python_api/#carla.LightState"><strong>carla.LightState</strong></a> 类型的变量 <strong>light_state</strong> 允许在一次调用中设置所有这些。 路灯使用其类型为 <a href="../python_api/#carla.LightState"><strong>carla.LightState</strong></a> 的属性 <strong>light_state</strong> 进行分类。这允许将灯分类为路灯、建筑物灯...可以检索 [<strong>carla.LightManager</strong>] 的实例来在一次调用中处理一组灯。</li>
</ul>
<pre><code class="language-py"># 获得灯光管理器和灯光
lmanager = world.get_lightmanager()
mylights = lmanager.get_all_lights()

# 定制一个特定的灯光
light01 = mylights[0]
light01.turn_on()
light01.set_intensity(100.0)
state01 = carla.LightState(200.0,red,carla.LightGroup.Building,True)
light01.set_light_state(state01)

# 定制一组灯
my_lights = lmanager.get_light_group(carla.LightGroup.Building)
lmanager.turn_on(my_lights)
lmanager.set_color(my_lights,carla.Color(255,0,0))
lmanager.set_intensities(my_lights,list_of_intensities)
</code></pre>
<ul>
<li><strong>车灯</strong> 必须由用户打开/关闭。每辆车都有一组在<a href="../python_api/#carla.VehicleLightState"><strong>carla.VehicleLightState</strong></a> 中列出的灯。到目前为止，并非所有车辆都集成了车灯。以下是截至撰写本文时可用的列表。<ul>
<li><strong>自行车。</strong> 它们都有前后示廓灯。</li>
<li><strong>摩托车。</strong> 雅马哈和哈雷戴维森型号。</li>
<li><strong>汽车。</strong> 奥迪 TT、雪佛兰、道奇（警车）、钰创、林肯、野马、特斯拉3S、大众T2以及即将到来的 Carla 新客人。  </li>
</ul>
</li>
</ul>
<p>可以使用 <a href="../python_api/#carla.Vehicle.get_light_state">carla.Vehicle.get_light_state</a> 和 <a href="#python_api.md#carla.Vehicle.set_light_state">carla.Vehicle.set_light_state</a> 方法随时检索和更新车辆的灯光。它们使用二进制运算来自定义灯光设置。</p>
<pre><code class="language-py"># 打开位置灯
current_lights = carla.VehicleLightState.NONE
current_lights |= carla.VehicleLightState.Position
vehicle.set_light_state(current_lights)
</code></pre>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>还可以使用天气 <code>environment.py</code> 部分中描述的实时设置灯光。</p>
</div>
<h3 id="_11">调试</h3>
<p>世界对象有一个 <a href="../python_api/#carla.DebugHelper">carla.DebugHelper</a> 对象作为公共属性。它允许在仿真过程中绘制不同的形状。这些用于跟踪正在发生的事件。以下示例将在参与者的位置和旋转处绘制一个红色框。</p>
<pre><code class="language-py">debug = world.debug
debug.draw_box(carla.BoundingBox(actor_snapshot.get_transform().location,carla.Vector3D(0.5,0.5,2)),actor_snapshot.get_transform().rotation, 0.05, carla.Color(255,0,0,0),0)
</code></pre>
<p>此示例在 <a href="../python_api/#carla.DebugHelper.draw_box">carla.DebugHelper</a> 的片段中进行了扩展，展示了如何为世界快照中的每个参与者绘制方框。</p>
<h3 id="_12">世界快照</h3>
<p>包含仿真中每个参与者在单个帧中的状态。一种带有时间参考的静态世界图像。即使在异步模式下，信息也来自相同的仿真步骤。</p>
<pre><code class="language-py"># 检索当前帧的世界快照。
world_snapshot = world.get_snapshot()
</code></pre>
<p><a href="../python_api/#carla.WorldSnapshot">carla.WorldSnapshot</a> 包含 <a href="../python_api/#carla.Timestamp">carla.Timestamp</a> 和 <a href="../python_api/#carla.ActorSnapshot">carla.ActorSnapshot</a> 列表。可以使用参与者 <code>id</code> 的搜索参与者快照。快照列出了其中出现的参与者 <code>id</code>。</p>
<pre><code class="language-py">timestamp = world_snapshot.timestamp # 获取时间参考

for actor_snapshot in world_snapshot: # 获取参与者和快照信息
    actual_actor = world.get_actor(actor_snapshot.id)
    actor_snapshot.get_transform()
    actor_snapshot.get_velocity()
    actor_snapshot.get_angular_velocity()
    actor_snapshot.get_acceleration()  

actor_snapshot = world_snapshot.find(actual_actor.id) # 获得参与者快照
</code></pre>
<h3 id="_13">世界设置</h3>
<p>世界可以使用一些高级的仿真配置。这些决定了渲染条件、仿真时间步长以及客户端和服务器之间的同步。它们可以从辅助类<a href="../python_api/#carla.WorldSettings">carla.WorldSettings</a> 访问。 </p>
<p>目前，默认的 Carla 以最佳图形质量、可变时间步长和异步方式运行。要进一步深入了解此问题，请查看 <strong>高级步骤</strong> 部分。有关 <a href="../adv_synchrony_timestep/">同步、时间步长</a> 以及 <a href="../adv_rendering_options/">渲染选项</a> 的页面可能是一个很好的起点。</p>
<hr />
<p>这是对世界和客户端对象的包装。下一步将仔细研究参与者和蓝图，为仿真赋予生命。</p>
<p>继续阅读以了解更多信息。请访问论坛，发表在阅读过程中想到的任何疑问或建议。</p>
<div text-align: center>
<div class="build-buttons">
<p>
<a href="https://github.com/carla-simulator/carla/discussions/" target="_blank" class="btn btn-neutral" title="CARLA forum">
Carla 论坛</a>
</p>
</div>
<div class="build-buttons">
<p>
<a href="../core_actors" target="_blank" class="btn btn-neutral" title="2nd. Actors and blueprints">
第二、参与者和蓝图</a>
</p>
</div>
</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../extra.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
