<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>在 Windows 上进行 Carla 的调试 - 交通仿真文档</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u5728 Windows \u4e0a\u8fdb\u884c Carla \u7684\u8c03\u8bd5";
        var mkdocs_page_input_path = "tuto_D_windows_debug.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 交通仿真文档
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">主页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">交通仿真文档</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">在 Windows 上进行 Carla 的调试</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/tuto_D_windows_debug.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="windows-carla">在 Windows 上进行 Carla 的调试</h1>
<p>程序调用流程：Python、libcarla.cp37-win_amd64.pyd、LibCarla、CarlaUE4。</p>
<h2 id="carla">虚幻引擎Carla插件的调试</h2>
<ol>
<li>进入目录<code>carla/Unreal/CarlaUE4/</code>，右键文件<code>CarlaUE4.uproject</code>，选择运行<code>Generate Visual Studio project files</code>，在当前目录中将会生成VS的工程文件，双击打开<code>CarlaUE4.sln</code>。</li>
</ol>
<p><img alt="" src="../img/tuto_D_windows_debug/generate_vs_project_files.png" /></p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>如果右键菜单中未出现<code>Generate Visual Studio project files</code>选项，则到虚幻引擎的目录中运双击执行<code>engine\Engine\Binaries\Win64\UnrealVersionSelector.exe</code>，将虚幻引擎软件注册到系统中。</p>
</div>
<ol>
<li>（调试数字孪生工具）在<code>解决方案</code>中展开<code>Games-&gt;CarlaUE4</code>，在想要查看的源代码行的最左侧单击增加断点（比如：<code>CarlaUE4-&gt;Plugins-&gt;CarlaTools-&gt;Source-&gt;CarlaTools-&gt;Private</code>的<code>OpenDriveToMap.cpp</code>的<code>GenerateTileStandalone()</code>），在菜单运行<code>调试(D)-&gt;开始调试(S)</code>，程序将在断点出暂停。通过<code>调式(D)-&gt;窗口(W)-&gt;监视(W)-&gt;监视 1</code>打开变量监视窗口，查看变量值是否异常。</li>
</ol>
<p><img alt="" src="../img/tuto_D_windows_debug/debug_project.png" /></p>
<ul>
<li>调试<strong>Carla服务端</strong>：断点打在<code>Carla/Game/CarlaEngine.cpp</code>的第87行，然后开始调式，在虚幻编辑器中点击<code>运行</code>则会在断点处停止。
<img alt="" src="img/tuto_D_windows_debug/debug_carla_server.png" /></li>
</ul>
<p>配置管理器包括：</p>
<ul>
<li>
<p><strong>Debug</strong>: 游戏和引擎全都可以调试，无优化，速度慢，没有Editor相关代码功能，资源需要Cook。</p>
</li>
<li>
<p><strong>Debug Editor</strong>：游戏和引擎全部可以调试，无优化，可以使用Editor相关代码功能，资源不需要Cook，可直接启动编辑器。（用<code>generate_traffic.py</code>调试会崩溃，<code>manual_control.py</code>可以）</p>
</li>
<li>
<p><strong>DebugGame</strong>：游戏代码可调试无优化，Editor相关代码功能不可使用，引擎不可调试，资源需要Cook。</p>
</li>
<li>
<p><strong>DebugGame Editor</strong>：游戏代码可调试无优化，可以使用Editor相关代码功能，引擎不可调试，资源不需要Cook。</p>
</li>
<li>
<p><strong>Development</strong>：游戏、编辑器、引擎都不可调试，Editor相关代码功能不可使用，资源需要Cook。</p>
</li>
<li>
<p><strong>Development Editor</strong>：游戏、编辑器、引擎都不可调试，Editor相关代码功能可使用，资源不需要Cook。（默认）</p>
</li>
<li>
<p><strong>Shipping</strong>：发行版，极致优化，估计调试信息都没了。</p>
</li>
<li>
<p><strong>Test</strong>：包含额外的测试代码。</p>
</li>
</ul>
<h2 id="libcarla">调试LibCarla</h2>
<p><strong>客户端</strong>向服务端调用实现的功能。
* 脚本<code>BuildLibCarla.bat</code>调用<code>cmake</code>命令进行构建：</p>
<pre><code class="language-shell">cmake -G %GENERATOR% %PLATFORM%^
  -DCMAKE_BUILD_TYPE=Server^
  -DCMAKE_CXX_FLAGS_RELEASE=&quot;/MD /MP&quot;^
  -DCMAKE_INSTALL_PREFIX=&quot;%LIBCARLA_SERVER_INSTALL_PATH:\=/%&quot;^
  &quot;%ROOT_PATH%&quot;
</code></pre>
<p>其中，<code>-G</code>表示指定编译器版本（<code>set GENERATOR="Visual Studio 16 2019"</code>、<code>set PLATFORM=-A x64</code>）；</p>
<p><code>-DCMAKE_BUILD_TYPE</code>的可选项包括：<code>Client</code>, <code>Server</code>, <code>Pytorch</code>, <code>ros2</code>；
<code>-D CMAKE_BUILD_TYPE="Debug"</code>可选值包括：<code>Debug</code>, <code>Release</code>, <code>RelWithDebInfo</code>, <code>MinSizeRel</code>。</p>
<p><code>CMAKE_CXX_FLAGS_RELEASE</code>设置编译类型 Release 时的编译选项；</p>
<ul>
<li>调用以下命令在 <code>Build</code> 目录下生成<code>Makefile</code>文件：</li>
</ul>
<pre><code class="language-shell">cmake --build . --config Release --target install | findstr /V &quot;Up-to-date:&quot;
</code></pre>
<ol>
<li>
<p>使用VS打开<code>Build\libcarla-visualstudio\CARLA.sln</code>。使用命令<code>make client</code>打开的就是<code>LibCarla\cmake\client\CMakeLists.txt</code>对应的项目。（使用<code>make server</code>打开的则是<code>LibCarla\cmake\server\CMakeLists.txt</code>对应的项目）
<img alt="" src="img/tuto_D_windows_debug/open_libcarla_proj.png" />
（<code>Build</code>目录下还包括<code>osm2odr-visualstudio/SUMO.sln</code>的VS工程）。</p>
</li>
<li>
<p>右键<code>carla_client_debug</code>将其<code>设为启动项目</code>。</p>
</li>
<li>
<p>附着到 Python 程序启动调试后，出现<code>当前不会命中断点 还没有为该文档加载任何符号</code>的警告。<a href="https://blog.csdn.net/u010821666/article/details/78512900">解决</a> </p>
</li>
</ol>
<p>在<code>BuildLibCarla.bat</code>中，将 <code>--config</code>参数从<code>Release</code>修改为<code>Debug</code>。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
<p>在vs2019中生成<code>carla_client_debug</code>的解决方案时出现<code>fatal error C1189: #error :  "Incompatible build options"</code>错误，因为 <a href="https://www.twblogs.net/a/5ef976a7fa148015395f1c5e/?lang=zh-cn">在不指定调试运行时的情况下使用/RTC选项将导致链接器错误</a> ，则需要将“项目属性 --&gt; C++ --&gt; 基本运行时检查” 改为 <code>默认值</code>，然后重新生成解决方案。</p>
</div>
<h3 id="python">Python 扩展模块</h3>
<p>LibCarla编译后生成<code>Python37/Lib/site-packages/carla/libcarla.cp37-win_amd64.pyd</code>给Python进行调用。为了提高运行速度，将当前目录中的<code>__init__.py</code>和<code>command.py</code>编译为<code>__pycache__</code>目录中的 <code>byte code(字节码)</code>。</p>
<h2 id="pythonapi">PythonAPI</h2>
<p>boost_python库所在的目录为：<code>carla\Build\boost-1.80.0-install\lib\libboost_python37-vc142-mt-x64-1_80.lib</code>，<code>mt-x64</code>之间带有<code>gd</code>的是对应的调试版本。示例参考 <a href="../demo/boost_python/">链接</a> 。</p>
<p>列出所有可用的命令：</p>
<pre><code class="language-shell">python setup.py --help-commands
</code></pre>
<p>构建命令：</p>
<pre><code class="language-shell">python setup.py build
</code></pre>
<h2 id="_1">其他</h2>
<h3 id="vs2019-carlaue4-cmake">VS2019 打开 CarlaUE4 的 Cmake 工程</h3>
<p>windows操作系统下通过vs2019打开并编译carla：</p>
<ol>
<li>开Carla的CMake项目（参考<a href="https://www.jb51.net/article/180463.htm">CMake 入门教程</a> ）：</li>
</ol>
<p>从 VS 的菜单中选择 <code>File--&gt;Open--&gt;CMake</code>, 在对话框中找到 Carla 所在的本地文件夹（包含CMakeLists），选择CMakeLists.txt文件，打开，Visual studio 会自动加载此仓库，解析 <code>CMakeLists.txt</code> 文件，并提取其配置和变量信息。解析完成（需要等会儿或者重启）会从<code>解决方案资源管理器</code>中看到<code>.cpp</code>文件。</p>
<ol>
<li>修改配置：</li>
</ol>
<p>点击<code>x64-Debug</code>下拉菜单中的<code>管理配置</code>，并在弹出的界面点击<code>编辑JSON</code>（该过程在工程根目录下生成<code>CMakeSettings.json</code>），将所需要构建的类型改为想编译的类型，比如<code>Client</code>。</p>
<ol>
<li>生成：</li>
</ol>
<p>点击菜单栏<code>生成</code>-<code>全部生成</code>或<code>部分生成</code>即可。</p>
<h3 id="_2">导入崩溃问题</h3>
<ol>
<li>例如，导入测试链接：</li>
</ol>
<pre><code class="language-text">小地图：
https://overpass-api.de/api/map?bbox=112.9088,28.2221,112.9172,28.2290
大地图：
https://overpass-api.de/api/map?bbox=112.8553,28.1931,112.9396,28.2504
金醴高速：
https://overpass-api.de/api/map?bbox=113.5293,27.6893,113.5516,27.7074
</code></pre>
<ol>
<li><code>CarlaUE4-&gt;Plugins-&gt;CarlaTools-&gt;Source-&gt;CarlaTools-&gt;Private</code>的<code>OpenDriveToMap.cpp</code>463行<code>GenerateTileStandalone()</code> ，然后调用<code>ExecuteTileCommandlet()</code> : </li>
</ol>
<p>UCommandlet是 Unreal Engine 中用于实现命令行操作的基类。它允许开发者创建自定义的命令行命令，并在引擎启动时执行这些命令。这个类主要用于扩展引擎功能，提供自定义的命令行工具。</p>
<ol>
<li>ExecuteTileCommandlet() 调用的是<code>carla\Unreal\CarlaUE4\Plugins\CarlaTools\Intermediate\Build\Win64\UE4Editor\Inc\CarlaTools\OpenDriveToMap.gen.cpp</code>（反射文件gen）194行的</li>
</ol>
<pre><code class="language-shell">static FName NAME_UOpenDriveToMap_ExecuteTileCommandlet = FName(TEXT(&quot;ExecuteTileCommandlet&quot;));
void UOpenDriveToMap::ExecuteTileCommandlet()
{
    ProcessEvent(FindFunctionChecked(NAME_UOpenDriveToMap_ExecuteTileCommandlet),NULL);
}
</code></pre>
<ul>
<li>找到名为“ExecuteTileCommandlet”的<code>UFunction</code>对象；</li>
<li>执行“ProcessEvent”函数，然后从全局函数映射表找到对应的函数指针执行（利用函数名调用UFUNCTION函数）。</li>
</ul>
<p><a href="https://neil3d.github.io/unreal/bp_in_depth.html">蓝图的字节码</a> ：在<code>engine\Engine\Source\Runtime\CoreUObject\Public\UObject\Script.h</code>这个文件中有一个<code>enum EExprToken</code>，这个枚举就是蓝图的字节码定义。引擎中使用一个全局查找表，把上述字节码映射到函数指针。在运行时，从一个字节码数组中逐个取出字节码，并查找函数指针，进行调用，也就完成了所谓的“字节码解释执行”的过程。</p>
<p>改为</p>
<pre><code class="language-shell">void UOpenDriveToMap::GenerateTileStandalone(){
  UE_LOG(LogCarlaToolsMapGenerator, Log, TEXT(&quot;UOpenDriveToMap::GenerateTileStandalone Function called&quot;));

  // ExecuteTileCommandlet();
  GenerateTile();

  UEditorLoadingAndSavingUtils::SaveDirtyPackages(true, true);
  UEditorLevelLibrary::SaveCurrentLevel();

}
</code></pre>
<p>注意：大地图也只能生成一小片地图。</p>
<p>报错信息：</p>
<pre><code class="language-text">D:\work\workspace\engine/Engine/Binanes\Win64\UE4Editor ../../../../carla/Unreal/CaraUE4/CaraUE4.uproject -run=GenerateTileCommandlet &quot; &quot; -FilePath= ../../../../carla/Unreal/CarlaUE4/Content/Custo
[2024.04.30-06.58.10:090][ 0]LogInit: Executing Class /Script/CarlaTools.GenerateTileCommandlet
[2024.04.30-06.58.10:090][ 0]LogOutputDevice: Warning:

(0 frames)
</code></pre>
<p>崩溃日志：</p>
<pre><code class="language-text">LoginId:bc22576a452b36c1831fe8942b55e57a
EpicAccountId:77cf3795af004e58a037e9c9d4a5aa0d

Assertion failed: Pair != nullptr [File:D:\work\workspace\engine\Engine\Source\Runtime\Core\Public\Containers/Map.h] [Line: 621]

UE4Editor_Core!AssertFailedImplV() [D:\work\workspace\engine\Engine\Source\Runtime\Core\Private\Misc\AssertionMacros.cpp:104]
UE4Editor_Core!FDebug::CheckVerifyFailedImpl() [D:\work\workspace\engine\Engine\Source\Runtime\Core\Private\Misc\AssertionMacros.cpp:461]
UE4Editor_CarlaTools!UGenerateTileCommandlet::Main() [D:\work\workspace\carla\Unreal\CarlaUE4\Plugins\CarlaTools\Source\CarlaTools\Private\Commandlet\GenerateTileCommandlet.cpp:75]
UE4Editor!FEngineLoop::PreInitPostStartupScreen() [D:\work\workspace\engine\Engine\Source\Runtime\Launch\Private\LaunchEngineLoop.cpp:3369]
UE4Editor!GuardedMain() [D:\work\workspace\engine\Engine\Source\Runtime\Launch\Private\Launch.cpp:127]
UE4Editor!GuardedMainWrapper() [D:\work\workspace\engine\Engine\Source\Runtime\Launch\Private\Windows\LaunchWindows.cpp:137]
UE4Editor!WinMain() [D:\work\workspace\engine\Engine\Source\Runtime\Launch\Private\Windows\LaunchWindows.cpp:268]
UE4Editor!__scrt_common_main_seh() [d:\agent\_work\2\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288]
kernel32
ntdll
</code></pre>
<p>可知：<code>OpenDriveMap-&gt;FilePath = ParamsMap["FilePath"];</code>报的错，应该是路径下.xodr文件不存在。</p>
<p>崩溃日志位于：<code>engine\Engine\Binaries\Win64\CommandletParameters.txt</code>
找到的命令行运行参数为：</p>
<pre><code class="language-text"> -run=GenerateTileCommandlet &quot; &quot; - F i l e P a t h = . . / . . / . . / . . / c a r l a / U n r e a l / C a r l a U E 4 / C o n t e n t / C u s t o m M a p s / t e s t _ 3 7 / O p e n D r i v e / t e s t _ 3 7 . x o d r &quot; &quot; - B a s e L e v e l N a m e = / G a m e / C u s t o m M a p s / t e s t _ 3 7 / t e s t _ 3 7 &quot; &quot; - G e o C o o r d s X = 2 7 . 6 8 9 3 0 1 &quot; &quot; - G e o C o o r d s Y = 1 1 3 . 5 2 9 2 9 7 &quot; &quot; - C T i l e X = 4 &quot; &quot; - C T i l e Y = 0 &quot; &quot; - A l l o w C o m m a n d l e t R e n d e r i n g
</code></pre>
<p>参数多了很多空格</p>
<p>正确应该为：</p>
<pre><code class="language-shell">D:\work\workspace\engine\Engine\Binaries\Win64\UE4Editor ../../../../carla/Unreal/CarlaUE4/CarlaUE4.uproject -run=GenerateTileCommandlet -FilePath=../../../../carla/Unreal/CarlaUE4/Content/CustomMaps/test_37/OpenDrive/test_37.xodr -BaseLevelName=/Game/CustomMaps/test_37/test_37 -GeoCoordsX=27.689301 -GeoCoordsY=113.529297 -CTileX=4 -CTileY=0 -AllowCommandletRendering

D:\work\workspace\engine\Engine\Binaries\Win64\UE4Editor-Cmd D:/work/workspace/carla/Unreal/CarlaUE4/CarlaUE4.uproject -run=GenerateTileCommandlet -FilePath=D:/work/workspace/carla/Unreal/CarlaUE4/Content/CustomMaps/test_37/OpenDrive/test_37.xodr -BaseLevelName=/Game/CustomMaps/test_37/test_37 -GeoCoordsX=27.689301 -GeoCoordsY=113.529297 -CTileX=4 -CTileY=0 -AllowCommandletRendering
</code></pre>
<p>直接命令行运行报错（必须确保不是Commandlet启动，而必须是Editor启动）：</p>
<pre><code class="language-text">LogWindows: Error: Assertion failed: !IsRunningCommandlet() [File:D:/work/workspace/engine/Engine/Plugins/Developer/RenderDocPlugin/Source/RenderDocPlugin/Private/SRenderDocPluginEditorExtension.cpp] [Line: 107]
</code></pre>
<h3 id="vs-ue"><a href="https://ue5wiki.com/wiki/14373/">VS 调试 UE 项目</a></h3>
<ul>
<li>变量已被优化掉，因而不可用。    </li>
</ul>
<p>VS菜单中选择<code>DebugGammingEditor</code>，然后开始调试，就可以添加要监视的项。</p>
<h3 id="_3">问题</h3>
<p>崩溃于<code>engine\Engine\Source\Runtime\CoreUObject\Private\UObject\ScriptCore.cpp</code>1990行<code>Function-&gt;Invoke(this, NewStack, ReturnValueAddress);</code>
弹出报错信息框：</p>
<pre><code class="language-text">Failed to open descriptor file ./../../../carla/Unreal/CarlaUE4/CarlaUE4.uproject
</code></pre>
<ul>
<li><a href="http://www.piaoyi.org/c-sharp/Visual-Studio-2019-Intellisense.html">VS跳转代码太慢</a> </li>
</ul>
<h3 id="_4">依赖</h3>
<h4 id="boost-1800">boost-1.80.0</h4>
<p><a href="https://blog.csdn.net/ASCE_Python/article/details/105595218">Python封装C++库调试</a> 。</p>
<h3 id="_5">发布</h3>
<p>包含所有软件依赖，双击<code>launch.bat</code>启动软件。</p>
<h4 id="vs2019">VS2019社区版安装</h4>
<p>解压安装包：</p>
<pre><code class="language-shell">7z x filename.zip -o.
</code></pre>
<p>新电脑运行<code>NativeDesktop.exe</code>出现<code>此版本的Windows不支持此产品，请尝试升级Windows。</code></p>
<h3 id="_6">技巧</h3>
<ul>
<li>进行函数跳转时，vs一致出现<code>正在进行IntelliSense</code>：</li>
</ul>
<p>选择“工具”菜单栏下的“选项”按钮打开选项页面，找到 文本编辑器-&gt;C/C++-&gt;高级,在右侧的禁用IntelliSense中改为True</p>
<ul>
<li><a href="https://blog.csdn.net/tomwillow/article/details/118387681">检查符号是否加载</a> </li>
</ul>
<p>启动调式并在断点停下，然后“调试 - 窗口 - 模块”打开模块窗口。
找到第三方dll的名字，看“符号文件”一栏是空的。说明这个dll的符号文件没有加载。
把.pdb和.dll放在一起。再次调试。可以看到符号文件已经加载了。</p>
<ul>
<li>日志记录</li>
</ul>
<p><code>UE_LOG</code>函数记录的日志位于<code>carla\Unreal\CarlaUE4\Saved\Logs\CarlaUE4.log</code>文件中。</p>
<h3 id="_7">学习</h3>
<ul>
<li><a href="../tuto_D_bat/">bat脚本</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../extra.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
