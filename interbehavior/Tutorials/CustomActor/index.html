<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>DReyeVR custom actors - 代理模拟器</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "DReyeVR custom actors";
        var mkdocs_page_input_path = "interbehavior/Tutorials/CustomActor.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> 代理模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">代理模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">DReyeVR custom actors</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/interbehavior/Tutorials/CustomActor.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="dreyevr-custom-actors">DReyeVR custom actors</h1>
<h2 id="what">What?</h2>
<p>We are often interested in spawning arbitrary "AR-like" (Augmented reality) elements in the simulator at runtime that can be completely recorded and reenacted without hassle. </p>
<h3 id="example-3d-bounding-boxes">Example: 3D Bounding Boxes</h3>
<ul>
<li>With a translucent (Opacity &lt; 1) material we can simply create an elongated Cube actor and overlay it over any extent as a simple BBOX indicator.<ul>
<li>We can have the actor track the extent, so it can follow a vehicle/pedestrian/anything and not interfere with physics at all (physics simulation is disabled).</li>
<li>Psst! this is actually already mostly implemented (but disabled) in the code, check out the <a href="./#bounding-box-example">example at the bottom</a></li>
</ul>
</li>
</ul>
<h3 id="example-gaze-lines">Example: Gaze lines</h3>
<ul>
<li>If you want to draw the eye gaze rays in realtime (without using <code>DrawDebugLine</code>, which is editor-only), you can simply use an elongated cube as a "ray" from the user gaze origin to the world-space gaze target.</li>
</ul>
<h3 id="example-debug-trails">Example: Debug trails</h3>
<ul>
<li>Similar to the debug path in Carla, spawning a trail of dynamic spheres can be useful to draw AR-like guidelines in the world and help direct drivers through the map.</li>
</ul>
<h2 id="why">Why?</h2>
<ol>
<li>Having each "CustomActor" be its own entity (not necessarily tied to the EgoVehicle/EgoSensor) allows it to be recorded with the CARLA recorder easily and without modifying the core DReyeVR data. This is important when we want to change the API of the recorder (which happens quite often) but don't want to lose data from previous experiments that have data recordings (in binary format) that we can't modify easily.</li>
<li>Abstracting the "CustomActor"s gives us plenty of flexibility for manipulating the actors in the simulator at runtime and allows for new interesting scenarios to be performed easily without worry of recording/replay.</li>
</ol>
<h1 id="usage">Usage</h1>
<p>Using these CustomActors is designed to be straightforward and cooperate with UE4/Carla's notion of <a href="https://docs.unrealengine.com/5.0/en-US/API/Runtime/Engine/GameFramework/AActor/">AActors</a>. You can see how we define all the core data for these actors (and what gets recorded/replayed) in <a href="../../Carla/Sensor/DReyeVRData.h"><code>DReyeVRData.h</code></a><code>::CustomActorData</code></p>
<p>We have several basic 3D shapes ready for simple CustomActor usage. Theoretically you can use any static mesh. To access these types (or add your own) you should check out the references in <a href="../../Carla/Actor/DReyeVRCustomActor.h"><code>DReyeVRCustomActor.h</code></a>:
<div class="highlight"><pre><span></span><code><span class="cp">#define MAT_OPAQUE &quot;Material&#39;/Game/DReyeVR/Custom/OpaqueParamMaterial.OpaqueParamMaterial&#39;&quot;</span>
<span class="cp">#define MAT_TRANSLUCENT &quot;Material&#39;/Game/DReyeVR/Custom/TranslucentParamMaterial.TranslucentParamMaterial&#39;&quot;</span>
<span class="cp">#define SM_SPHERE &quot;StaticMesh&#39;/Engine/BasicShapes/Sphere.Sphere&#39;&quot;</span>
<span class="cp">#define SM_CUBE &quot;StaticMesh&#39;/Engine/BasicShapes/Cube.Cube&#39;&quot;</span>
<span class="cp">#define SM_CONE &quot;StaticMesh&#39;/Engine/BasicShapes/Cone.Cone&#39;&quot;</span>

<span class="c1">// add a new string literal here</span>
<span class="cp">#define SM_CUSTOM_MESH &quot;StaticMesh&#39;/Path/To/Your/StaticMesh.StaticMesh&#39;&quot;</span>
</code></pre></div></p>
<h2 id="spawn-a-custom-actor">Spawn a custom actor</h2>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Carla/Actor/DReyeVRCustomActor.h&quot;</span>
<span class="p">...</span>
<span class="c1">// example parameters, you can change these to whavever you&#39;d like</span>
<span class="n">FString</span><span class="w"> </span><span class="n">PathToSM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SM_CUBE</span><span class="p">;</span>
<span class="n">FString</span><span class="w"> </span><span class="n">PathToMat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAT_TRANSLUCENT</span><span class="p">;</span>
<span class="n">FString</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;NewActorName&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// every actor needs a unique name!</span>
<span class="n">UWorld</span><span class="w"> </span><span class="o">*</span><span class="n">World</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">();</span>
<span class="n">ADReyeVRCustomActor</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADReyeVRCustomActor</span><span class="o">::</span><span class="n">CreateNew</span><span class="p">(</span><span class="n">PathToSM</span><span class="p">,</span><span class="w"> </span><span class="n">PathToMaterial</span><span class="p">,</span><span class="w"> </span><span class="n">World</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="p">);</span>
</code></pre></div>
<p>Implementation wise, the custom actors are all managed by a "global" table (<code>static std::unordered_map&lt;std::string, class ADReyeVRCustomActor *&gt;</code>) that indexes the actors by their <code>Name</code> therefore it is critical that they all have unique names. This is often easy to do when spawning many since UE4 <code>AActor</code>s themselves have unique names enumerated by their spawn order. To further understand how we use the global table, check out <code>ADReyeVRCustomActor::ActiveCustomActors</code> in <a href="../../Carla/Actor/DReyeVRCustomActor.h"><code>DReyevRCustomActor.h</code></a></p>
<h2 id="activatedeactivate-a-custom-actor">Activate/deactivate a custom actor</h2>
<p>To activate (see in the world) simply run
<div class="highlight"><pre><span></span><code><span class="n">A</span><span class="o">-&gt;</span><span class="n">Activate</span><span class="p">();</span>
</code></pre></div>
This will ensure every tick of this actor will be recorded with the Carla recorder. </p>
<p>Similarly, to deactivate the actor (disable visibility, recording, and tick function) do:
<div class="highlight"><pre><span></span><code><span class="n">A</span><span class="o">-&gt;</span><span class="n">Deactivate</span><span class="p">();</span>
</code></pre></div></p>
<p>You can check whether or not an actor is "active" with <code>A-&gt;IsActive()</code>. While true (the actor is active) the actor will automatically be recorded in the CARLA recorder which will allow replaying without hassle. </p>
<h2 id="update-a-custom-actor">Update a custom actor</h2>
<p>These methods come from the UE4 <code>AActor</code> base class, which our class inherits from and extends. 
<div class="highlight"><pre><span></span><code><span class="c1">// resize the actor</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">SetActorScale3D</span><span class="p">(</span><span class="n">FVector</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">));</span>

<span class="c1">// move the actor</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">SetActorLocation</span><span class="p">(</span><span class="n">FVector</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="c1">// rotate the actor</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">SetActorRotation</span><span class="p">(</span><span class="n">FRotator</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></p>
<p>Assuming you are using one of the param-materials we provide for you, you can also modify the material parameters and have them take effect in realtime:
<div class="highlight"><pre><span></span><code><span class="c1">// change vector properties</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">BaseColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLinearColor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// RGBA</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">Emissive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FLinearColor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// RGBA</span>

<span class="c1">// change scalar properties</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">Metallic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.f</span><span class="p">;</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">Specular</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0.15f</span><span class="p">;</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">Roughness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.f</span><span class="p">;</span>
<span class="n">A</span><span class="o">-&gt;</span><span class="n">MaterialParams</span><span class="p">.</span><span class="n">Anisotropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
</code></pre></div></p>
<p>Note that in order to use the <code>Opacity</code> property, the material needs to have a translucent blend mode. So far we only have two material types, opaque and translucent, each with their own set of available properties as follows:
| OpaqueParamMaterial | TranslucentParamMaterial |
| --- | --- |
| <img alt="OpaqueMaterial" src="../../Figures/Actor/OpaqueParamMaterial.jpg" /> | <img alt="OpaqueMaterial" src="../../Figures/Actor/TranslucentParamMaterial.jpg" /> |</p>
<h2 id="bounding-box-example">Bounding Box Example</h2>
<p>As an example of the CustomActor bounding boxes in action, checkout <a href="../../DReyeVR/LevelScript.cpp"><code>LevelScript.cpp::DrawBBoxes</code></a> where some simple logic for drawing translucent bounding boxes is held (coloured based on distance to EgoVehicle). To enable this function, you'll need to manually enable it by removing the <code>#if 0</code> and corresponding <code>#endif</code> around the function body.</p>
<p>Here is what it might look like in action:</p>
<p><img alt="BboxExample" src="../../Figures/Actor/Bbox.jpg" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../../js/umlconvert.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
