<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>如何添加您自己的 EgoVehicle - 人车模拟</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u5982\u4f55\u6dfb\u52a0\u60a8\u81ea\u5df1\u7684 EgoVehicle";
        var mkdocs_page_input_path = "interbehavior/Tutorials/CustomEgo.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> 人车模拟
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">人车模拟</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">如何添加您自己的 EgoVehicle</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/doc/edit/master/docs/interbehavior/Tutorials/CustomEgo.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="egovehicle">如何添加您自己的 EgoVehicle</h1>
<p>本指南介绍如何从现有的 Carla 车辆添加您自己的自定义 EgoVehicle，然后您可以在 DReyeVR 中使用。展示将<strong>救护车</strong>添加为新的 DReyeVR EgoVehicle 所需的最少步骤。</p>
<h2 id="_1">先决条件</h2>
<ul>
<li>您应该已经安装 DReyeVR 并正常运行</li>
<li>如果您想修改新车辆的静态网格，您可能应该查看 <a href="../Model/">Model.md</a>：<ul>
<li>例如，创建高多边形镜像网格</li>
<li>例如，拆下方向盘用作动态道具（随动画移动）</li>
</ul>
</li>
</ul>
<h2 id="1">1. 选择要添加的车辆</h2>
<ol>
<li>由于 DReyeVR EgoVehicle 是 <code>ACarlaWheeledVehicle</code> 的子实例，因此您应该使用 Carla 车辆作为所需车辆的基类。在本教程中，我们将使用救护车作为示例，但任何 Carla 车辆都可以。<ul>
<li>针对车辆 <code>XYZ</code></li>
<li>蓝图文件位于 <code>Unreal/CarlaUE4/Content/Carla/Blueprints/Vehicles/XYZ/BP_XYZ.uasset</code></li>
<li>静态网格文件位于 <code>Unreal/CarlaUE4/Content/Carla/Static/Vehicles/XWheeled/XYZ/</code></li>
</ul>
</li>
<li>一旦您决定了车辆，就通过复制（在虚幻编辑器中）蓝图文件来创建此结构。<ul>
<li>对您想要添加的任何其他网格组件执行相同操作。</li>
<li>您需要让文件结构与现有的 EgoVehicles 相匹配：
<div class="highlight"><pre><span></span><code>CarlaUE4/Content/DReyeVR/
├── EgoVehicle
│   ├── Extra
│   ├── Jeep
│   ├── Mustang66
│   ├── Ambulance # &lt;-- 你的新 EgoVehicle
│   ├── TeslaM3   # &lt;-- DReyeVR 中默认的车
│   └── Vespa
...
</code></pre></div></li>
<li>在您的 <code>XYZ/</code> 文件夹中，您需要复制新的 BP_XYZ 资源（从编辑器执行此操作以便可以更新缓存路径）并在此处创建您可能需要的任何其他文件夹（例如，<code>Mesh</code>、<code>Mirrors</code>、<code>SteeringWheel</code>、<code>Tires</code> 是几个示例）。 </li>
<li>
<p>最好在编辑器中执行这些资产文件修改。您可以通过单击并拖动将文件从内容浏览器复制到其他文件夹，以获取此弹出窗口： </p>
<p><img alt="CopyHere" src="../../Figures/EgoVehicle/CopyHere.jpg" /></p>
</li>
</ul>
</li>
</ol>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>如果您想编辑车辆网格，这里就是您要进行的操作。您可能希望在 <code>Static</code> 目录中构建现有的静态网格。</p>
<h2 id="2">2. 重新定义车辆蓝图</h2>
<p>（为了本教程的目的，我们假设 <code>XYZ=Ambulance</code>）</p>
<ol>
<li>
<p>打开刚从内容浏览器复制的 <code>Content/DReyeVR/EgoVehicle/Ambulance/BP_Ambulance</code> 资源</p>
</li>
<li>
<p>选择 <code>Class Defaults</code>，然后在右上角（<code>Class Options</code>）中选择<code>Parent Class</code>，并搜索 <code>EgoVehicle</code> 进行重新父级设置（如下图所示）。这有效地将蓝图的基类从 <code>BaseVehiclePawn</code>（Carla 默认）重新组织为 <code>EgoVehicle</code>（DReyeVR C++ 类，仍然继承自 BaseVehiclePawn）。</p>
<ul>
<li>
<p>将会弹出有关数据丢失的警告，您应该继续（这纯粹是附加的）。</p>
</li>
<li>
<p><strong>注意</strong> 如果蓝图损坏，您应该首先尝试重新回到 <code>BaseVehiclePawn</code>（原始父级），然后再回到 DReyeVR <code>EgoVehicle</code>。</p>
</li>
<li>
<p><img alt="EditClass" src="../../Figures/EgoVehicle/EditClassSettings.jpg" /></p>
<ul>
<li>演示类设置按钮，用于编辑此BP的类实例</li>
</ul>
</li>
<li>
<p><img alt="Reparent" src="../../Figures/EgoVehicle/Reparent.jpg" /></p>
<ul>
<li>演示重新父级按钮，选择下拉菜单并搜索兼容的类以使用 <code>BaseVehiclePawn</code>s（Carla）或 <code>EgoVehicle</code>（DReyeVR）重新父级。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>现在，从技术上讲，这辆车是 DReyeVR EgoVehicle！</p>
</li>
</ol>
<h2 id="3">3. 添加新的配置文件和代码</h2>
<p>现在，要使用 DReyeVR 实际注册这个新蓝图并使其可供生成，您需要在代码中添加两位： </p>
<ol>
<li>将新车辆的名称（例如，我们继承的 BP_Ambulance 蓝图的<code>"Ambulance"</code>）添加到 <a href="https://github.com/OpenHUTB/carla/blob/OpenHUTB/Unreal/CarlaUE4/Source/CarlaUE4/DReyeVR/DReyeVRFactory.h"><code>DReyeVRFactory.h</code></a> 中的可用 EgoVehicles 列表中。
    <div class="highlight"><pre><span></span><code><span class="c1">// place the names of all your new custom EgoVehicle types here:</span>
<span class="c1">/// IMPORTANT: make sure these match the ConfigFile AND Blueprint!!</span>
<span class="c1">// We expect Config/EgoVehicle/XYZ.ini and Content/DReyeVR/EgoVehicles/XYZ/BP_XYZ.uasset</span>
<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehicleTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;TeslaM3&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// Tesla Model 3 (Default)</span>
<span class="w">    </span><span class="s">&quot;Mustang66&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Mustang66</span>
<span class="w">    </span><span class="s">&quot;Jeep&quot;</span><span class="p">,</span><span class="w">      </span><span class="c1">// JeepWranglerRubicon</span>
<span class="w">    </span><span class="s">&quot;Vespa&quot;</span><span class="w">      </span><span class="c1">// Vespa (2WheeledVehicles)</span>
<span class="w">    </span><span class="s">&quot;Ambulance&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// &lt;-- the new vehicle! (for this tutorial)</span>
<span class="w">    </span><span class="c1">// add more here</span>
<span class="p">};</span>
</code></pre></div></li>
<li>添加一个新的配置文件（到 <code>Unreal/CarlaUE4/Config/EgoVehicles/</code>），用于参数化此车辆。这允许 DReyeVR 知道将相机根位置（驾驶员座位）、镜子、方向盘等东西放在哪里，并且此 <a href="https://github.com/OpenHUTB/carla/blob/OpenHUTB/Unreal/CarlaUE4/Source/CarlaUE4/DReyeVR/ConfigFile.h"><code>ConfigFile</code></a> 可以扩展以支持许多运行时组合。<ul>
<li>您需要确保配置文件的名称与您的新 EgoVehicle 完全相同（这是它们的读取方式）。我们建议复制现有配置文件（默认为 <code>TeslaM3.ini</code> 并重命名如下）：
    <div class="highlight"><pre><span></span><code>CarlaUE4/Config/
├── ...
├── DReyeVRConfig.ini
├── ...
├── EgoVehicles/
│   ├── Jeep.ini
│   ├── Mustang66.ini
│   ├── Ambulance.ini # &lt;-- your new file!
│   ├── TeslaM3.ini
│   └── Vespa.ini
├── ...
...
</code></pre></div></li>
<li>然后，您可能需要编辑此文件的一些内容，以匹配可以从编辑器中获取的 EgoVehicle 规范。例如，下图显示我们要将 VRCameraRoot（头部位置）移动到 (<code>108, -40, 158</code>)。 <ul>
<li><img alt="CameraRepos" src="../../Figures/EgoVehicle/CameraReposition.jpg" /></li>
<li>您可能还希望将仪表板元素移动到适合您喜好的位置。 </li>
</ul>
</li>
<li><strong>重要</strong> 您还需要为蓝图（组件列表中的 <code>BP_Ambulance</code>）启用<code>Start with Tick Enabled</code>，因为默认情况下，它们对于 Carla 车辆是禁用的：<ul>
<li><img alt="ActorTick" src="../../Figures/EgoVehicle/ActorTick.jpg" /></li>
</ul>
</li>
<li>
<p>您还应该注意到，SteeringWheel 和 Mirrors 等资产没有分配任何静态网格。您可以通过单击组件（在左侧层次结构上）并分配新的静态网格（在右侧详细信息窗格上）来访问它们。这会直接在蓝图文件中烘焙资产，因此只需执行一次即可。</p>
<table>
<thead>
<tr>
<th>示例：Mirrors</th>
<th>示例：Steering wheel</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="Mirrors" src="../../Figures/EgoVehicle/SM_Mirror.jpg" /></td>
<td><img alt="Wheel" src="../../Figures/EgoVehicle/SM_Wheel.jpg" /></td>
</tr>
<tr>
<td>- 现在，打开刚刚创建的 <code>Ambulance.ini</code> 文件，并开始更新字段（主要是转换）以匹配您关心的参数。重要的是，对于<code>[Blueprint]::Path</code> 条目，您可以通过右键单击内容查看器中的蓝图并选择<code>Copy Reference</code>来获取此路径。</td>
<td></td>
</tr>
<tr>
<td>- <img alt="CopyRef" src="../../Figures/EgoVehicle/CopyRef.jpg" /></td>
<td></td>
</tr>
<tr>
<td>- 请注意，变换的编码如下</td>
<td></td>
</tr>
<tr>
<td><div class="highlight"><pre><span></span><code><span class="c1"># Format: Location XYZ in CM | Rotation Roll/Pitch/Yaw in Degrees | Scale XYZ percent (1=100%)</span>
<span class="na">ExampleTransform</span><span class="o">=</span><span class="s">(X=0.0, Y=0.0, Z=3.0 | R=-45, P=90.0, Y=0 | X=1, Y=1, Z=1)</span>
</code></pre></div></td>
<td></td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ol>
<h2 id="4-dreyevr">4. 将新车辆设置为 DReyeVR 默认车辆</h2>
<p>在 <code>DReyeVRConfig.ini</code> 通用配置文件（用于非车辆特定参数）中，您应该设置默认生成的车辆。这将采用车辆的名称，在本例中为救护车<code>Ambulance</code>。 </p>
<div class="highlight"><pre><span></span><code><span class="k">[EgoVehicle]</span>
<span class="na">VehicleType</span><span class="o">=</span><span class="s">&quot;Ambulance&quot;</span>
</code></pre></div>
<p>就这样！现在您应该能够重新启动 <code>make launch</code> 了，当您按下 Play 时，您将开始使用新的 EgoVehicle。</p>
<h2 id="4">4. [可选] 创建新动画</h2>
<p>有时，尤其是在修改 blender 中的网格并将其导出/导入回虚幻引擎时，原始动画资源可能会有些混乱，无法正常工作。如果轮胎（和方向盘，如果您添加了方向盘）在 EgoVehicle 移动时没有转动，您就会知道动画是否失败。</p>
<p>请参阅 <a href="https://carla.readthedocs.io/en/latest/tuto_A_add_vehicle/#import-and-configure-the-vehicle">此处</a> 的 Carla 相应文档。</p>
<p>!!! 注意 截至测试，这仅适用于 4WheeledVehicles。2WheeledVehicles 更为复杂，本教程未涉及。</p>
<h3 id="carladreyevr">为 Carla/DReyeVR 创建新动画蓝图的步骤</h3>
<p>1.在 Ambulance/Mesh 目录中创建一个新的动画蓝图（如果有的话，否则在 <code>Ambulance</code> 内创建一个新的文件夹 <code>Mesh/</code>）。
<img alt="CreateAnim" src="../../Figures/EgoVehicle/CreateAnim.jpg" /></p>
<p>2.确保动画网格的父级设置为 <code>VehicleAnimInstance</code>，并且预览骨架设置为新车辆的骨架网格（例如 <code>SK_Ambulance_Skeleton</code>） 
<a href="../../Figures/EgoVehicle/CreateAnimBP.jpg">CreateAnimBP</a></p>
<p>3.将新资产命名为 <code>Anim_Ambulance</code> 并打开它。打开右下角的 AnimationGraph，如下所示：
<img alt="AnimGraph" src="../../Figures/EgoVehicle/AnimGraph.jpg" /></p>
<p>4.打开另一个附近的动画蓝图（例如 <code>Content/DReyeVR/EgoVehicle/TeslaM3/Mesh/Animation_model3</code>）并打开其 AnimationGraph 以复制连接到 Output Pose 的前三个蓝图节点，如下所示：
<img alt="CopyAnim" src="../../Figures/EgoVehicle/CopyAnim.jpg" /></p>
<p>5.然后，返回 <code>Anim_Ambulance</code>，粘贴刚刚复制的三个节点并将它们连接到输出姿势(Output Pose)： 
<img alt="PasteAnim" src="../../Figures/EgoVehicle/PasteAnim.jpg" /></p>
<p>6.最后，返回车辆蓝图（BP_Ambulance）并在组件部分选择网格，然后在（右侧）详细信息面板中将动画类更改为新的 <code>Anim_Ambulance</code>，如下所示：
<img alt="AssignAnim" src="../../Figures/EgoVehicle/AssignAnim.jpg" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../../js/umlconvert.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
