<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Content authoring large maps - 人车模拟器</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Content authoring large maps";
        var mkdocs_page_input_path = "content_authoring_large_maps.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Content authoring large maps</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/content_authoring_large_maps.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="carla"><a href="https://carla.readthedocs.io/en/latest/content_authoring_large_maps/">为 Carla 创建大地图</a></h1>
<p>Carla 中大地图（如城镇 11 和 12）的操作方式与标准地图（如城镇 10）不同。地图被划分为图块，即地图的细分，通常大小设置为约 1 至 2 公里。这些图块划分了地图，以便仅将需要的地图部分加载到图形内存中以进行高效渲染。不需要的图块保持休眠状态并准备在需要时加载。通常，会加载自我车辆位置中的图块旁边的图块，但如果需要，可以加载更多图块。当 Carla 启动时，可以在设置中修改此行为。</p>
<h1 id="roadrunner">在 RoadRunner 中创建大地图</h1>
<p>RoadRunner 是推荐用于创建要导入 Carla 的大地图的软件。本指南概述了如何使用 RoadRunner 创建大地图以及如何在虚幻引擎编辑器中导入和处理大地图。</p>
<ul>
<li><a href="#build-a-large-map-in-roadrunner"><strong>在 RoadRunner 中构建大地图</strong></a></li>
<li><a href="#export-a-large-map-in-roadrunner"><strong>在 RoadRunner 中导出大地图</strong></a></li>
<li><a href="#import-a-large-map-into-carla"><strong>将大地图导入 Carla</strong></a><ul>
<li><a href="#files-and-folders">文件和文件夹</a></li>
<li><a href="#create-the-json-description-optional">创建 JSON 描述（可选）</a></li>
<li><a href="#making-the-import">进行导入</a></li>
</ul>
</li>
<li><a href="#handling-a-large-map-in-the-unreal-editor"><strong>在虚幻编辑器中处理大地图</strong></a></li>
<li><a href="#package-a-large-map"><strong>打包一张大地图</strong></a></li>
</ul>
<hr />
<h2 id="roadrunner_1">在 RoadRunner 中构建大地图</h2>
<p>如何在 RoadRunner 中构建复杂地图的具体细节超出了本指南的范围，但是，<a href="https://www.mathworks.com/support/search.html?fq=asset_type_name:video%20category:roadrunner/index&amp;page=1&amp;s_tid=CRUX_topnav">RoadRunner 文档</a>中提供了视频教程。从表面上看，在 RoadRunner 中构建大地图与构建标准地图基本相同，只是比例更大。差异主要在于地图的导出方式。</p>
<p><img alt="roadrunner_draw" src="../img/tuto_content_authoring_maps/large_map_roadrunner.png" /></p>
<p>这里我们创建了一张大约 1.2 公里大小的大地图。当我们导出它时，它会被分割成图块，我们将选择 700m 的图块大小，因此地图应该分割成大约 4 个图块。</p>
<p>如果您正在构建带有高程的大地图，建议的地图最大尺寸为 20x20 km<sup>2</sup>。大于此大小的地图可能会导致 RoadRunner 在导出时崩溃。</p>
<hr />
<h2 id="roadrunner_2">在 RoadRunner 中导出大地图</h2>
<p>以下是从 RoadRunner 导出自定义大地图的基本指南。</p>
<p>通过单击世界设置工具（<a href="https://www.mathworks.com/help/roadrunner/ref/worldsettingstool.html"><em>World settings tool</em></a> ）并拖动蓝色边界框的边缘以包含要导出的整个区域，确保选择导出完整地图。准备好后，单击“应用世界更改”（ <em>Apply World Changes</em> ）。</p>
<p><img alt="roadrunner_workspace" src="../img/tuto_content_authoring_maps/roadrunner_workspace.png" /></p>
<p>使用场景导出预览工具有助于了解如何将地图划分为图块以供导出。调整“平铺选项”（<em>Tiling Options</em>）菜单中的“平铺大小”（<em>Tile Size</em>）参数，找到适合您地图的平铺大小，按“刷新场景”（<em>Refresh Scene</em>）查看调整的影响。</p>
<p><img alt="roadrunner_scene_preview" src="../img/tuto_content_authoring_maps/rr_scene_export_preview.png" /></p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p><strong>Tile size</strong>: 您使用的图块大小是一个判断调用，以确保地图在 Carla 中使用时能够有效工作。如果您的地图包含密集的 3D 资源（例如建筑物和植被），您可能会受益于较小的图块大小，以防止加载不必要的资源。但是，这可能会增加构建地图所需工作的复杂性。Carla 引擎支持的最大瓦片尺寸为 2 公里，我们建议瓦片尺寸为 1 公里左右。</p>
</div>
<p>当您准备好导出时：</p>
<p><strong>1.</strong> 导出 <code>.fbx</code> 几何文件：</p>
<ul>
<li>在主工具栏中，选择 <code>File</code> -&gt; <code>Export</code> -&gt; <code>Firebox (.fbx)</code></li>
</ul>
<p><strong>2.</strong> 在弹出的窗口中：</p>
<blockquote>
<ul>
<li>检查以下选项：<ul>
<li><em>通过分段分割</em>（<em>Split by Segmentation</em>）: 通过语义分割来划分网格并改进行人导航。</li>
<li><em>二维纹理的力量</em>（<em>Power of Two Texture Dimensions</em>）: 提高性能。</li>
<li><em>嵌入纹理</em>（<em>Embed Textures</em>）: 确保纹理嵌入到网格中。</li>
<li><em>导出到图块</em>（<em>Export to Tiles</em>）: 选择图块的大小。Carla 可以使用的最大尺寸为 2000 x 2000。</li>
<li><em>导出单个图块</em>（<em>Export Individual Tiles</em>）: 生成在 Carla 中流式传输大地图所需的单个图块。</li>
</ul>
</li>
</ul>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p><img alt="export_large_map_fbx" src="../img/tuto_content_authoring_maps/rr_export.png" /></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p><strong>3.</strong> 导出 <code>.xodr</code> OpenDrive 地图文件：</p>
<ul>
<li>在主工具栏中，选择 <code>File</code> -&gt; <code>Export</code> -&gt; <code>OpendDRIVE (.xodr)</code></li>
</ul>
<p>在您选择导出的文件夹中，您现在将有几个新文件，一个 <code>.xodr</code> 文件和几个 <code>.fbx</code> 文件：</p>
<p><img alt="export_large_map_fbx" src="../img/tuto_content_authoring_maps/large_map_export.png" /></p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>确保 <code>.xodr</code> 和 <code>.fbx</code> 文件具有相同的名称根。</p>
</div>
<p>现在您已经在 Roadrunner 中创建了大地图，您可以将其导入 Carla 中。RoadRunner 创建的文件应转移到用于构建 Carla 的根目录的 <code>Import</code> 目录内。</p>
<hr />
<h1 id="carla_1">将大地图导入 Carla</h1>
<p>RoadRunner 中生成的大地图可以导入到 Carla 的源代码构建中，并打包在 Carla 独立包中分发和使用。该过程与标准地图非常相似，只是添加了图块和批量导入的特定术语。</p>
<h2 id="_1">文件和文件夹</h2>
<p>所有要导入的文件应放置在 Carla 根目录的 <code>Import</code> 文件夹中。这些文件应包括：</p>
<ul>
<li>多个 <code>.fbx</code> 文件中的地图网格代表地图的不同图块。</li>
<li>OpenDRIVE 定义位于单个<code>.xodr</code>文件中。</li>
</ul>
<div class="admonition 警告">
<p class="admonition-title">警告</p>
<p>您不能同时导入大地图和标准地图。</p>
</div>
<p>地图图块的命名约定非常重要。每个地图图块应根据以下约定命名：</p>
<div class="highlight"><pre><span></span><code>&lt;mapName&gt;_Tile_&lt;x-coordinate&gt;_&lt;y-coordinate&gt;.fbx
</code></pre></div>
<p>默认情况下，RoadRunner 应符合此命名约定，但在准备导入 Carla 之前值得仔细检查，因为此阶段引起的问题稍后修复起来可能会很乏味。最终地图中的图块将如下图所示排列：</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p><img src="img/tuto_content_authoring_maps/large_map_tiles.png" width="70%"></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>生成的<code>Import</code>文件夹中包含一个包含由四个图块组成的大地图的包，其结构应类似于以下结构：</p>
<div class="highlight"><pre><span></span><code>Import
│
└──<span class="w"> </span>Package01
<span class="w">  </span>├──<span class="w"> </span>Package01.json
<span class="w">  </span>├──<span class="w"> </span>LargeMap_Tile_0_0.fbx
<span class="w">  </span>├──<span class="w"> </span>LargeMap_Tile_0_1.fbx
<span class="w">  </span>├──<span class="w"> </span>LargeMap_Tile_1_0.fbx
<span class="w">  </span>├──<span class="w"> </span>LargeMap_Tile_1_1.fbx
<span class="w">  </span>└──<span class="w"> </span>LargeMap.xodr
</code></pre></div>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p><code>package.json</code>文件并不是绝对必要的。如果未创建 <code>package.json</code> 文件，自动导入过程将创建一个。package.json在下一节中了解有关构建自己 <code>package.json</code> 的结构的更多信息。</p>
</div>
<hr />
<h2 id="json">创建 JSON 描述（可选）</h2>
<p><code>.json</code>描述是在导入过程中自动创建的，但也可以选择手动创建描述。现有<code>.json</code>描述将覆盖导入过程中作为参数传递的任何值。</p>
<p>该<code>.json</code>文件应创建在包的根文件夹中。文件名将是包分发名称。文件的内容描述了 <strong>地图</strong> 和 <strong>道具</strong> 的 JSON 数组，其中包含每个地图和道具的基本信息。</p>
<p><strong>Maps</strong> 需要以下参数：</p>
<ul>
<li><strong>name:</strong> 地图的名称。这必须与和<code>.fbx</code>和<code>.xodr</code>文件相同.xodr。</li>
<li><strong>xodr:</strong> <code>.xodr</code> 文件的路径</li>
<li><strong>use_carla_materials:</strong> 如果为 <strong>True</strong>，地图将使用 Carla 材质。否则，它将使用 RoadRunner 材料。</li>
<li><strong>tile_size:</strong> 图块的大小。默认值为 2000 (2kmx2km)。</li>
<li><strong>tiles:</strong> 组成整个地图的 <code>.fbx</code> tile文件的列表。</li>
</ul>
<p><strong>Props</strong> 属于本教程的一部分。请参阅 <a href="../tuto_A_add_props/">本</a> 教程了解如何添加新道具。</p>
<p>生成的<code>.json</code>文件应类似于以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;maps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;LargeMap&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;xodr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./LargeMap.xodr&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;use_carla_materials&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tile_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">700</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tiles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span>
<span class="w">        </span><span class="s2">&quot;./LargeMap_Tile_0_0.fbx&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;./LargeMap_Tile_0_1.fbx&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;./LargeMap_Tile_1_0.fbx&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;./LargeMap_Tile_1_1.fbx&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;props&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="_2">进行导入</h2>
<p>将所有文件放入该<code>Import</code>文件夹后，在根 Carla 文件夹中运行以下命令：</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>import
</code></pre></div>
<p>根据您的系统，虚幻引擎可能会消耗太多内存而无法一次导入所有文件。您可以通过运行以下命令选择批量导入文件：</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>import<span class="w"> </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">&quot;--batch-size=200&quot;</span>
</code></pre></div>
<p>该<code>make import</code>命令还存在两个标志：</p>
<ul>
<li><code>--package=&lt;package_name&gt;</code> 指定包的名称。默认情况下，此项设置为<code>map_package</code>。两个包不能具有相同的名称，因此使用默认值将导致后续导入时出错。<strong>强烈建议更改包的名称</strong>。通过运行以下命令来使用此标志：</li>
</ul>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>import<span class="w">  </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">&quot;--package=&lt;package_name&gt;&quot;</span>
</code></pre></div>
<ul>
<li><code>--no-carla-materials</code> 指定您不想使用默认的 Carla 材质（道路纹理等）。您将改用 RoadRunner 材料。<strong>仅当您不提供自己的</strong><a href="../tuto_M_manual_map_package/"><code>.json</code> 文件</a>时才需要此标志。<code>.json</code>文件中的任何值都将覆盖此标志。通过运行以下命令来使用此标志：</li>
</ul>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>import<span class="w">  </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">&quot;--no-carla-materials&quot;</span>
</code></pre></div>
<p>所有文件都将被导入并准备在虚幻编辑器中使用。地图包将在  <code>Unreal/CarlaUE4/Content</code> 中创建。将创建一个底图图块<mapName>，作为所有图块的流级别。基础图块将包含天空、天气和大地图参与者，并准备好在模拟中使用。</p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>目前不建议使用虚幻编辑器中为标准地图提供的自定义工具，例如道路画家、程序建筑等。</p>
</div>
<hr />
<h2 id="_3">在虚幻编辑器中处理大地图</h2>
<p>现在您已导入新地图，您将在内容浏览器中的默认命名 <code>map_package</code> 文件夹内找到该地图。如果您在导入命令中使用参数 <code>"--package=&lt;package_name&gt;"</code>，该文件夹将有一个备用名称。在此文件夹内，打开该<code>Maps</code>文件夹并打开该文件夹内的文件夹。在里面你会发现几个橙色的关卡文件。</p>
<p><img alt="export_large_map_fbx" src="../img/tuto_content_authoring_maps/tiles_content_browser.png" /></p>
<p>整个地图将有一个关卡文件，而从 RoadRunner 导出的每个图块将有一个关卡文件。要将建筑物和植被等资产添加到地图中，请双击要处理的图块的关卡文件（例如本例中<code>LargeMap_Tile_0_0</code>），以便将其加载到编辑器中。默认情况下，图块没有任何照明设置，因此您可能需要将视图模式从 更改<code>Lit</code>为<code>Unlit</code>才能在加载图块后看到它。现在，您可以按照 <a href="../tuto_content_authoring_maps/#importing-assets-and-adding-them-to-the-map">与标准地图相同的过程</a> 向地图添加详细信息，请确保保存对正在处理的图块所做的修改，然后加载下一个图块并重复该过程。您无法一次性处理整个地图，因此加载（通过双击）整个地图的关卡文件（后面不带后缀 的文件<code>_Tile_X_Y</code>）对于装饰地图将没有用处。</p>
<p><img alt="export_large_map_fbx" src="../img/tuto_content_authoring_maps/large_map_unreal.png" /></p>
<hr />
<h2 id="_4">加载整个地图并运行模拟</h2>
<p>如果您想加载地图并开始模拟进行实验，您应该加载整个地图的关卡文件。双击带有根地图名称的关卡文件（后面不带后缀的文件<code>_Tile_X_Y</code>）并等待其加载。对于非常大的地图，加载有时可能需要几秒钟甚至几分钟。加载后，单击虚幻编辑器工具栏中的播放选项。模拟现在将从您的新大地图开始。</p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>如果您是第一次从虚幻引擎编辑器运行模拟，建议在开始模拟之前先逐个加载每个图块（通过双击它们），直到加载完所有图块。这会在后台执行某些操作，例如烘焙网格距离场和图块的着色器。如果您一开始不逐一加载图块，这些操作可能会在运行时执行，这可能会导致虚幻引擎挂起或崩溃。</p>
</div>
<h2 id="_5">打包一张大地图</h2>
<p>要打包大地图以便可以在 Carla 独立包中使用，请遵循与标准地图相同的过程 - 运行以下命令：</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>package<span class="w"> </span><span class="nv">ARGS</span><span class="o">=</span><span class="s2">&quot;--packages=&lt;mapPackage&gt;&quot;</span>
</code></pre></div>
<p>这将创建一个压缩在<code>.tar.gz</code>文件中的独立包。Linux 下文件将保存在<code>Dist</code> 和 Windows下保存在 <code>/Build/UE4Carla/</code> 文件夹中。然后可以将它们分发和打包以在独立的 Carla 包中使用。</p>
<hr />
<p>如果您对大地图导入和打包过程有任何疑问，那么您可以在 <a href="https://github.com/carla-simulator/carla/discussions">论坛</a> 中提问。</p>
<div class="build-buttons">
<p>
<a href="https://github.com/carla-simulator/carla/discussions" target="_blank" class="btn btn-neutral" title="Go to the CARLA forum">
Carla 论坛</a>
</p>
</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
