<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>构建系统 - 人车模拟器</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u6784\u5efa\u7cfb\u7edf";
        var mkdocs_page_input_path = "build_system.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">构建系统</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/build_system.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">构建系统</h1>
<ul>
<li><a href="#setup"><strong>设置</strong></a>  </li>
<li><a href="#libcarla"><strong>LibCarla</strong></a>  </li>
<li><a href="#carlaue4_and_carla_plugin"><strong>CarlaUE4 和 Carla 插件</strong></a>  </li>
<li><a href="#pythonapi"><strong>PythonAPI</strong></a><ul>
<li><a href="#versions-0912">0.9.12+ 版本</a></li>
<li><a href="#versions_prior_to_0912">0.9.12 之前的版本</a></li>
</ul>
</li>
<li><a href="#faq"><strong>常见问题与解决方案</strong></a></li>
<li><a href="#quickstart"><strong>快速开始</strong></a> <blockquote>
<p><em>本文档是一个正在进行的工作，这里仅考虑 Linux 构建系统。</em></p>
</blockquote>
</li>
</ul>
<p>设置中最具挑战性的部分是编译所有依赖项和模块，使其与 a) 服务器端的虚幻引擎 和 b) 客户端的 Python 兼容。</p>
<p>目标是能够从单独的 Python 进程调用虚幻引擎的函数。</p>
<p><img alt="modules" src="../img/build_modules.jpg" /></p>
<p>在 Linux 中，我们使用 clang-8.0 和 C++14 标准编译 Carla 和所有依赖项。然而，我们根据代码的使用位置来链接不同的运行时 C++ 库，因为所有将与虚幻引擎链接的代码都需要使用 <code>libc++</code> 进行编译。</p>
<hr />
<h2 id="_2">设置 <span id="setup"></span></h2>
<p>命令</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup
</code></pre></div>
<p>获取并编译依赖项</p>
<ul>
<li>llvm-8 (libc++ and libc++abi)</li>
<li>rpclib-2.2.1 (twice, with libstdc++ and libc++)</li>
<li>boost-1.72.0 (headers and boost_python for libstdc++)</li>
<li>googletest-1.8.1 (with libc++)</li>
</ul>
<hr />
<h2 id="_3">依赖检查</h2>
<p>建议在构建前运行依赖检查脚本，确保环境无误</p>
<div class="highlight"><pre><span></span><code>./Util/CheckDependencies.sh
</code></pre></div>
<p>该脚本会检测：</p>
<ul>
<li>clang 和 clang++ 版本</li>
<li>Python 和 pip 版本</li>
<li>boost, llvm, rpclib 是否存在</li>
<li>Unreal Engine 路径是否配置正确 (UE4_ROOT 环境变量)</li>
</ul>
<h2 id="libcarla">LibCarla <span id="libcarla"></span></h2>
<p>使用 CMake 编译（最低版本需要 CMake 3.9）。</p>
<p>命令</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>LibCarla
</code></pre></div>
<p>两种配置：</p>
<table>
<thead>
<tr>
<th></th>
<th>服务器</th>
<th>客户端</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>单元测试</strong></td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td><strong>要求</strong></td>
<td>rpclib, gtest, boost</td>
<td>rpclib, boost</td>
</tr>
<tr>
<td><strong>标准运行时</strong></td>
<td>LLVM's <code>libc++</code></td>
<td>默认 <code>libstdc++</code></td>
</tr>
<tr>
<td><strong>输出</strong></td>
<td>头文件和<code>carla_server.lib</code></td>
<td><code>carla_server.lib</code></td>
</tr>
<tr>
<td><strong>需要</strong></td>
<td>Carla plugin</td>
<td>PythonAPI</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="carlaue4-carla">CarlaUE4 和 Carla 插件 <span id="carlaue4_and_carla_plugin"></span></h2>
<p>两者均使用虚幻引擎构建工具在同一步骤进行编译。它们需要 <code>UE4_ROOT</code> 环境变量。</p>
<p>命令</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>CarlaUE4Editor
</code></pre></div>
<p>要启动虚幻引擎的编辑器，请运行</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>launch
</code></pre></div>
<p>编译 0.9.15 时候出现<code>carla/Unreal/CarlaUE4/Plugins/CarlaTools/Source/CarlaTools/Private/Online/CustomFileDownloader.cpp(11): fatal rror C1083: 无法打开包括文件: “OSM2ODR.h”: No such file or directory</code></p>
<p>解决：将 Carla 0.9.14 版本中的 Build/osm2odr-visualstudio 文件夹复制到 0.9.15 版本中对应的 carla/Build/ 目录下。</p>
<hr />
<h2 id="pythonapi">PythonAPI <span id="pythonapi"></span></h2>
<h3 id="0912">0.9.12+ 版本 <span id="versions-0912"></span></h3>
<p>使用 Python 的 <code>setuptools</code> ("setup.py")  编译。 目前需要在机器上安装以下软件：Python, libpython-dev, 和
libboost-python-dev, pip&gt;=20.3, wheel, 和 auditwheel。</p>
<p>命令：</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>PythonAPI
</code></pre></div>
<p>创建两个文件，每个文件包含客户端库并对应于系统上支持的 Python 版本。一个文件是 <code>.whl</code> 文件，另一个文件是 <code>.egg</code> 文件。这允许选择两种不同的、互斥的方式来使用客户端库。</p>
<blockquote>
<p><strong>A. .whl 文件</strong></p>
<blockquote>
<p><code>.whl</code> 使用以下命令安装：</p>
<pre><code> pip install &lt;wheel_file&gt;.whl
</code></pre>
<p>无需像以前版本或 <code>.egg</code> 文件中那样直接在脚本中导入库路径 (请参阅 <a href="#versions-prior-to-0912">__0.9.12_之前的版本_</a>); <code>import carla</code> 就足够了。</p>
</blockquote>
<p><strong>B. .egg 文件</strong></p>
<blockquote>
<p>请参阅 <a href="#versions-prior-to-0912"><strong>0.9.12 之前的版本</strong></a> 了解更多详细信息。</p>
</blockquote>
</blockquote>
<h3 id="0912_1">0.9.12 之前的版本 <span id="versions_prior_to_0912"></span></h3>
<p>使用 Python 的 <code>setuptools</code> ("setup.py")编译。 目前需要在机器上安装以下软件： Python, libpython-dev, 和
libboost-python-dev。</p>
<p>命令</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>PythonAPI
</code></pre></div>
<p>它创造了两个 "egg" 包</p>
<ul>
<li><code>PythonAPI/dist/carla-X.X.X-py2.7-linux-x86_64.egg</code></li>
<li><code>PythonAPI/dist/carla-X.X.X-py3.7-linux-x86_64.egg</code></li>
</ul>
<p>通过将其添加到系统路径，可以将该包直接导入到 Python 脚本中。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="s1">&#39;PythonAPI/dist/carla-X.X.X-py</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">-linux-x86_64.egg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span>
                                                             <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">carla</span>

<span class="c1"># ...</span>
</code></pre></div>
<p>或者，可以使用 <code>easy_install</code> 安装</p>
<div class="highlight"><pre><span></span><code>easy_install2<span class="w"> </span>--user<span class="w"> </span>--no-deps<span class="w"> </span>PythonAPI/dist/carla-X.X.X-py2.7-linux-x86_64.egg
easy_install3<span class="w"> </span>--user<span class="w"> </span>--no-deps<span class="w"> </span>PythonAPI/dist/carla-X.X.X-py3.7-linux-x86_64.egg
</code></pre></div>
<h3 id="_4">常见问题与解决方案  <span id="faq"></span></h3>
<table>
<thead>
<tr>
<th>问题描述</th>
<th>解决方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>找不到clang-8</strong></td>
<td>手动安装：<code>sudo apt install clang-8</code></td>
</tr>
<tr>
<td><strong>Unreal Engine</strong></td>
<td>确保设置正确的UE4_ROOT，并确认UE4已正确编译</td>
</tr>
<tr>
<td><strong><code>ImportError: No module named carla</code></strong></td>
<td>检查 PythonAPI 是否正确编译并安装，检查 Python 版本对应关系</td>
</tr>
<tr>
<td><strong>C++ 编译找不到 libc++ 相关头文件</strong></td>
<td>确保 llvm-8 安装完整（特别是 libc++-dev，libc++abi-dev）</td>
</tr>
<tr>
<td><strong>PythonAPI make 失败（auditwheel 错误）</strong></td>
<td>升级 pip: <code>pip install --upgrade pip</code> 并重新安装 auditwheel</td>
</tr>
</tbody>
</table>
<h3 id="_5">快速开始  <span id="quickstart"></span></h3>
<p>快速构建系统跑通Carla，简化步骤</p>
<p>1.<strong>克隆仓库并初始化子模块</strong><br />
<code>bash
   git clone https://your.repo.url/carla.git
   cd carla
   git submodule update --init --recursive</code></p>
<p>2.<strong>安装系统依赖</strong><br />
<div class="highlight"><pre><span></span><code><span class="w">  </span>sudo<span class="w"> </span>apt<span class="w"> </span>update
<span class="w">  </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>clang-8<span class="w"> </span>cmake<span class="w"> </span>python3-dev<span class="w"> </span>python3-pip<span class="w"> </span><span class="se">\</span>
<span class="w">                    </span>libboost-python-dev<span class="w"> </span>llvm-8-dev<span class="w"> </span><span class="se">\</span>
<span class="w">                    </span>libpython3-dev
<span class="w">  </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span>wheel<span class="w"> </span>auditwheel
</code></pre></div>
3.<strong>下载组件</strong> 
<div class="highlight"><pre><span></span><code><span class="w">  </span>make<span class="w"> </span>setup<span class="w">            </span><span class="c1"># 下载并编译 llvm, rpclib, boost, gtest</span>
<span class="w">  </span>make<span class="w"> </span>LibCarla<span class="w">         </span><span class="c1"># 编译核心库</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span><span class="nv">UE4_ROOT</span><span class="o">=</span>/path/to/UnrealEngine
<span class="w">  </span>make<span class="w"> </span>CarlaUE4Editor<span class="w">   </span><span class="c1"># 编译 UE4 项目与插件</span>
<span class="w">  </span>make<span class="w"> </span>PythonAPI<span class="w">        </span><span class="c1"># 构建并打包 Python 客户端</span>
</code></pre></div>
4.<strong>验证结果</strong> 
<div class="highlight"><pre><span></span><code><span class="w"> </span>python3<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s"> import carla</span>
<span class="s"> client = carla.Client(&#39;localhost&#39;, 2000)</span>
<span class="s"> world = client.get_world()</span>
<span class="s"> print(&quot;World map:&quot;, world.get_map().name)</span>
<span class="s">EOF</span>
</code></pre></div></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
