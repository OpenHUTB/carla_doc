<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>通过 API 更改纹理 - 代理模拟器</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u901a\u8fc7 API \u66f4\u6539\u7eb9\u7406";
        var mkdocs_page_input_path = "tuto_G_texture_streaming.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 代理模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">代理模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">通过 API 更改纹理</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/tuto_G_texture_streaming.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="api">通过 API 更改纹理</h1>
<p>Carla API 可用于在运行时修改资源纹理。在本教程中，我们将学习如何选择资源，然后在 Carla 模拟运行时修改其纹理。</p>
<h2 id="_1">在虚幻编辑器中选择一个资源</h2>
<p>首先，我们需要加载虚幻编辑器并加载 Carla 地图，按照 Linux 或 Windows 的说明从源代码构建 Carla，然后构建并启动虚幻编辑器。让我们打开加载了 Town 10（默认城镇）的编辑器，然后选择要使用的建筑物：</p>
<p><img alt="select_building" src="../img/tuto_G_texture_streaming/building_selected.png" /></p>
<p>我们选择 <strong>BP_Apartment04_v05_Opt</strong> 进行纹理操作，名称可以在“世界大纲视图(World Outliner)”面板中看到。确保将鼠标悬停在世界大纲视图中的名称上并使用工具提示中定义的名称。内部名称可能与列表中显示的标题不同。在本例中，内部名称实际上是 <strong>BP_Apartment04_v05_Opt_2</strong> 。</p>
<p><img alt="tooltip" src="../img/tuto_G_texture_streaming/tooltip.png" /></p>
<h2 id="_2">导出纹理以供使用</h2>
<p>现在我们已经选择了建筑物，我们可以修改用于控制建筑物外观的纹理。选择建筑物后，在“细节”面板中，您将看到资产的一些详细信息，例如位置、旋转和缩放。单击“StaticMesh（继承）”以打开网格体属性，然后在面板的“静态网格体”部分中单击放大镜图标。这会将属于资源的材质和纹理置于内容浏览器中的焦点。在本例中，我们要检查 <strong>T_Apartment04_D_Opt</strong> 纹理。如果双击纹理，您可以在虚幻编辑器中检查它，但是，在本例中我们想要导出它，以便我们可以修改它。单击 <strong>T_Apartment04_D_Opt</strong> 并右键选择<em>资产操作 &gt; 导出</em>。以适当的格式保存文件（我们在这里选择 TGA 格式）。</p>
<p><img alt="texture_export" src="../img/tuto_G_texture_streaming/texture_export.png" /></p>
<p>在您喜欢的图像处理软件中打开导出的纹理，并根据需要编辑纹理。在下图中，上半部分可以看到原始纹理，下半部分显示修改后的纹理。</p>
<p><img alt="textures" src="../img/tuto_G_texture_streaming/textures.png" /></p>
<p>将修改后的纹理导出到适当的位置，然后打开代码编辑器运行一些 Python 来更新正在运行的 Carla 模拟中的纹理。</p>
<h2 id="api_1">通过API更新纹理</h2>
<p>如果尚未启动，请从命令行启动 Carla 模拟，或在虚幻编辑器中启动模拟。我们将使用 <a href="https://pillow.readthedocs.io/en/stable/"><strong>Python 图像库 (PIL)</strong></a> 从图像处理软件导出的图像文件中读取纹理。</p>
<h2 id="_3">连接到模拟器</h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">carla</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Connect to client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</code></pre></div>
<h2 id="_4">更新纹理</h2>
<p>加载修改后的图像后，实例化<a href="../python_api/#carla.TextureColor">carla.TextureColor</a>对象并填充加载图像中的像素数据。</p>
<p>使用 <a href="../python_api/#carla.World">carla.World</a> 对象的 <code>apply_color_texture_to_object(...)</code> 方法来更新纹理。您应该在 UE4 观察者视图中看到纹理更新。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Load the modified texture</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;BP_Apartment04_v05_modified.tga&#39;</span><span class="p">)</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Instantiate a carla.TextureColor object and populate</span>
<span class="c1"># the pixels with data from the modified image</span>
<span class="n">texture</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">TextureColor</span><span class="p">(</span><span class="n">width</span> <span class="p">,</span><span class="n">height</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">height</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getpixel</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">texture</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">carla</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>

<span class="c1"># Now apply the texture to the building asset</span>
<span class="n">world</span><span class="o">.</span><span class="n">apply_color_texture_to_object</span><span class="p">(</span><span class="s1">&#39;BP_Apartment04_v05_Opt_2&#39;</span><span class="p">,</span> <span class="n">carla</span><span class="o">.</span><span class="n">MaterialParameter</span><span class="o">.</span><span class="n">Diffuse</span><span class="p">,</span> <span class="n">texture</span><span class="p">)</span>
</code></pre></div>
<p><img alt="texture_change" src="../img/tuto_G_texture_streaming/texture_change.gif" /></p>
<h2 id="api_2">通过 API 查找对象名称</h2>
<p>要在不依赖虚幻编辑器的情况下查找对象，您还可以使用<code>world.get_names_of_all_objects()</code>查询对象名称。通过使用 Python 的内置<code>filter(...)</code>方法，您可以将目标对象归零。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Filter world objects for those with &#39;Apartment&#39; in the name</span>
<span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="s1">&#39;Apartment&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">,</span> <span class="n">world</span><span class="o">.</span><span class="n">get_names_of_all_objects</span><span class="p">()))</span>
</code></pre></div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
