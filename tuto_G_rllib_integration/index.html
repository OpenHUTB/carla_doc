<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>RLlib 集成 - 人车模拟</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "RLlib \u96c6\u6210";
        var mkdocs_page_input_path = "tuto_G_rllib_integration.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 人车模拟
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">人车模拟</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">RLlib 集成</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/doc/edit/master/docs/tuto_G_rllib_integration.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="rllib">RLlib 集成</h1>
<p>RLlib 集成带来了 <a href="https://github.com/ray-project/ray">Ray/RLlib</a> 库和 Carla 之间的支持，允许轻松使用 Carla 环境进行训练和推理。Ray 是一个开源框架，为构建分布式应用程序提供了简单、通用的 API。Ray 与 RLlib（一个可扩展的强化学习库）和 Tune（一个可扩展的超参数调整库）打包在一起。</p>
<p>RLlib 集成允许用户创建和使用 Carla 作为 Ray 的环境，并将该环境用于训练和推理目的。该集成可以在本地使用，也可以通过 AWS 在云中使用。</p>
<p>在本指南中，我们将概述在本地和 AWS 上运行 RLlib 集成所需的要求、集成存储库的结构、如何使用该库的概述，以及如何使用 Carla 设置 Ray 实验的示例一个环境。</p>
<ul>
<li><a href="#before_you_begin"><strong>在你开始之前</strong></a><ul>
<li><a href="#requirements_for_running_locally">本地运行的要求</a></li>
<li><a href="#requirements_for_running_on_aws_cloud">在 AWS 云上运行的要求</a></li>
</ul>
</li>
<li><a href="#rllib_repository_structure"><strong>RLlib 仓库结构</strong></a></li>
<li><a href="#creating_your_own_experiment"><strong>创建您自己的实验</strong></a><ul>
<li><a href="#1_the_experiment_class">实验类</a></li>
<li><a href="#2_the_environment_configuration">环境配置</a></li>
<li><a href="#3_the_training_and_inference_scripts">训练和推理脚本</a></li>
</ul>
</li>
<li><a href="#dqn_example"><strong>DQN 示例</strong></a></li>
<li><a href="#running_on_aws"><strong>在 AWS 上运行</strong></a><ul>
<li><a href="#configure_aws">配置 AWS</a></li>
<li><a href="#create_the_training_ami">创建训练 AMI</a></li>
<li><a href="#configure_the_cluster">配置集群</a></li>
<li><a href="#run_the_training">运行训练</a></li>
<li><a href="#running_the_dqn_example_on_aws">在 AWS 上运行 DQN 示例</a></li>
</ul>
</li>
</ul>
<hr />
<h2 id="_1">在你开始之前 <span id="before_you_begin"></span></h2>
<ul>
<li>从 <a href="https://github.com/carla-simulator/rllib-integration/tree/main">GitHub</a> 下载 RLlib 集成或直接克隆仓库：</li>
</ul>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/carla-simulator/rllib-integration.git
</code></pre></div>
<ul>
<li>要求会有所不同，具体取决于您是在本地运行还是在 AWS 上运行：</li>
</ul>
<blockquote>
<h6 id="_2">本地运行的要求 <span id="requirements_for_running_locally"></span></h6>
<blockquote>
<ul>
<li><a href="https://github.com/carla-simulator/carla/releases">安装 Carla 的软件包版本</a> 并导入 <a href="https://carla.readthedocs.io/en/latest/start_quickstart/#import-additional-assets">附加资源</a> 。<strong>推荐的版本是 Carla 0.9.11</strong> ，因为集成是使用此版本设计和测试的。其他版本可能兼容，但尚未经过充分测试，因此请自行决定使用这些版本。</li>
<li>导航到 RLlib 集成存储库的根文件夹并安装 Python 要求：</li>
</ul>
</blockquote>
</blockquote>
<pre><code>pip3 install -r requirements.txt
</code></pre>
<blockquote>
<blockquote>
<ul>
<li>通过运行以下命令设置环境变量以查找 Carla 包或添加<code>CARLA_ROOT=path/to/carla</code>到您的<code>.bashrc</code>文件中：</li>
</ul>
</blockquote>
</blockquote>
<pre><code>export CARLA_ROOT=path/to/carla
</code></pre>
<blockquote>
<h6 id="aws">在 AWS 云上运行的要求 <span id="requirements_for_running_on_aws_cloud"></span></h6>
<blockquote>
<ul>
<li>在 RLlib 集成存储库中找到的安装脚本中会自动满足在 AWS 上运行的要求。<a href="#running-on-aws">在“在 AWS 上运行”</a> 部分中查找更多详细信息。</li>
</ul>
</blockquote>
</blockquote>
<hr />
<h2 id="rllib_1">RLlib 存储库结构 <span id="rllib_repository_structure"></span></h2>
<p>存储库分为三个目录：</p>
<ul>
<li><code>rllib_integration</code> 包含与 Carla 相关的所有基础设施以及如何设置 Carla 服务器、客户端和参与者。这提供了所有训练和测试实验必须遵循的基本结构。</li>
<li><code>aws</code> 具有在 AWS 实例中运行所需的文件。<code>aws_helper.py</code>提供了多种可简化 EC2 实例管理的功能，包括实例创建以及发送和接收数据。</li>
<li>根目录中的 <code>dqn_example</code> 和 <code>dqn_*</code> 文件提供了一个易于理解的示例，说明如何使用 Carla 作为环境来设置 Ray 实验。 </li>
</ul>
<hr />
<h2 id="_3">创建您自己的实验 <span id="creating_your_own_experiment"></span></h2>
<p>本节概述了如何创建您自己的实验。更具体的示例请参见下一节<a href="#dqn-example">“DQN 示例”</a> 。</p>
<p>您将需要创建至少四个文件：</p>
<ul>
<li>实验类</li>
<li>环境配置</li>
<li>训练和推理脚本</li>
</ul>
<h4 id="1">1. 实验类 <span id="1_the_experiment_class"></span></h4>
<p>要使用 Carla 环境，您需要定义训练实验。Ray 要求环境返回一系列特定信息。您可以在 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/rllib_integration/carla_env.py"><code>rllib-integration/rllib_integration/carla_env.py</code></a> 中查看有关 Carla 环境的详细信息。</p>
<p>Ray 所需的信息取决于您的具体实验，因此所有实验都应继承自<a href="https://github.com/carla-simulator/rllib-integration/blob/main/rllib_integration/base_experiment.py#L41"><code>BaseExperiment</code></a>。此类包含您自己的实验需要覆盖的所有函数。这些都是与训练的行动、观察和奖励相关的功能。</p>
<h4 id="2">2. 环境配置 <span id="2_the_environment_configuration"></span></h4>
<p>实验应该通过<code>.yaml</code>文件进行配置。通过配置文件传递的任何设置都将覆盖默认设置。下面解释了不同默认设置的位置。</p>
<p>配置文件有三个主要用途：</p>
<ol>
<li>设置大部分 Carla 服务器和客户端设置，例如超时或地图质量。请参阅 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/rllib_integration/carla_core.py#L23">此处</a> 的默认值。 </li>
<li>设置特定于您的实验的变量，以及指定城镇条件以及自主车辆及其传感器的生成。默认设置可在 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/rllib_integration/base_experiment.py#L12">此处</a> 找到，并提供如何设置传感器的示例。</li>
<li>配置特定于 <a href="https://github.com/ray-project/ray/blob/master/rllib/agents/trainer.py">Ray 的训练</a> 设置。这些设置与所使用的特定训练器相关。如果您使用的是内置模型，则可以在此处应用其设置。 </li>
</ol>
<h4 id="3">3. 训练和推理脚本 <span id="3_the_training_and_inference_scripts"></span></h4>
<p>最后一步是创建您自己的训练和推理脚本。这部分完全由您决定，并且依赖于 Ray API。如果您想创建自己的特定模型，请查看 <a href="https://docs.ray.io/en/master/rllib-models.html#custom-models-implementing-your-own-forward-logic">Ray 的自定义模型文档</a> 。</p>
<hr />
<h2 id="dqn">DQN 示例 <span id="dqn_example"></span></h2>
<p>本节以上一节为基础，展示如何使用 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/rllib_integration/sensors/bird_view_manager.py">BirdView pseudosensor</a> 伪传感器和 Ray 的 <a href="https://github.com/ray-project/ray/blob/master/rllib/agents/dqn/dqn.py#L285">DQNTrainer</a> 进行 RLlib 集成的具体示例。</p>
<p>DQN示例的结构如下：</p>
<ul>
<li><strong>实验类</strong>: <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_example/dqn_experiment.py#L19"><code>DQNExperiment</code></a>，覆盖 <code>BaseExperiment</code> 类的方法。</li>
<li><strong>配置文件</strong>: <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_example/dqn_config.yaml"><code>dqn_example/dqn_config.yaml</code></a></li>
<li><strong>训练文件</strong>: <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_train.py"><code>dqn_train.py</code></a></li>
<li><strong>推理文件</strong>:<ul>
<li><strong>有 Ray</strong>: <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_inference_ray.py"><code>dqn_inference_ray.py</code></a> </li>
<li><strong>没有 Ray</strong>: <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_inference.py"><code>dqn_inference.py</code></a></li>
</ul>
</li>
</ul>
<p>要在本地运行该示例：</p>
<ol>
<li>
<p>安装 pytorch:</p>
<pre><code>pip3 install -r dqn_example/dqn_requirements.txt
</code></pre>
</li>
<li>
<p>运行训练文件：</p>
<pre><code>python3 dqn_train.py dqn_example/dqn_config.yaml --name dqn
</code></pre>
</li>
</ol>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>默认配置使用 1 个 GPU 和 12 个 CPU，因此如果您的本地计算机没有该容量，请减小 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_example/dqn_config.yaml">配置文件</a> 中的数字。</p>
<p>如果遇到内存不足问题，请考虑减少该<code>buffer_size</code>参数。</p>
</div>
<hr />
<h2 id="aws_1">在 AWS 上运行 <span id="running_on_aws"></span></h2>
<p>本节介绍如何使用 RLlib 集成在 AWS EC2 实例上自动运行训练和推理。为了处理实例的缩放，我们使用<a href="https://docs.ray.io/en/latest/cluster/index.html">Ray autoscaler API</a>。</p>
<h4 id="aws_2">配置 AWS <span id="configure_aws"></span></h4>
<p>您需要正确配置 boto3 环境。请点击 <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/configuration.html">此处</a> 了解更多信息。</p>
<h4 id="ami">创建训练 AMI <span id="create_the_training_ami"></span></h4>
<p>使用提供的 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/aws/aws_helper.py"><code>aws_helper.py</code></a> 脚本通过运行以下命令自动创建训练所需的映像，并传入基础映像的名称和 <code>install.sh</code> 在以下位置  <a href="https://github.com/carla-simulator/rllib-integration/blob/main/aws/install/install.sh"><code>rllib-integration/aws/install</code></a> 找到的安装脚本：</p>
<pre><code>python3 aws_helper.py create-image --name &lt;AMI-name&gt; --installation-scripts &lt;installation-scripts&gt; --instance-type &lt;instance-type&gt; --volume-size &lt;volume-size&gt;
</code></pre>
<h4 id="_4">配置集群 <span id="configure_the_cluster"></span></h4>
<p>创建图像后，将会输出带有图像信息的输出。要使用 Ray 自动缩放器，请使用输出中的信息更新 <a href="https://docs.ray.io/en/latest/cluster/config.html">autoscaler configuration file</a> 中的<code>&lt;ImageId&gt;</code> 和 <code>&lt;SecurityGroupIds&gt;</code> 设置。</p>
<h4 id="_5">运行训练 <span id="run_the_training"></span></h4>
<p>创建镜像后，您可以使用 Ray 的 API 在集群上运行训练：</p>
<ol>
<li>
<p>初始化集群：</p>
<pre><code>ray up &lt;autoscaler_configuration_file&gt;
</code></pre>
</li>
<li>
<p>（可选）如果集群初始化后本地代码被修改，请执行以下命令更新：</p>
<pre><code>ray rsync-up &lt;autoscaler_configuration_file&gt; &lt;path_to_local_folder&gt; &lt;path_to_remote_folder&gt;
</code></pre>
</li>
<li>
<p>运行训练：</p>
<pre><code>ray submit &lt;autoscaler_configuration_file&gt; &lt;training_file&gt;
</code></pre>
</li>
<li>
<p>（可选）监控集群状态：</p>
<pre><code>ray attach &lt;autoscaler_configuration_file&gt;
watch -n 1 ray status
</code></pre>
</li>
<li>
<p>关闭集群：</p>
<pre><code>ray down &lt;autoscaler_configuration_file&gt;
</code></pre>
</li>
</ol>
<h4 id="aws-dqn">在 AWS 上运行 DQN 示例 <span id="running_the_dqn_example_on_aws"></span></h4>
<p>要在 AWS 上运行 DQN 示例：</p>
<ol>
<li>
<p>通过将 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_example/dqn_autoscaler.yaml"><code>dqn_example/dqn_autoscaler.yaml</code></a> 配置传递给以下命令来创建映像：</p>
<pre><code>python3 aws_helper.py create-image --name &lt;AMI-name&gt; --installation-scripts install/install.sh --instance-type &lt;instance-type&gt; --volume-size &lt;volume-size&gt;
</code></pre>
</li>
<li>
<p>使用上一个命令 <a href="https://github.com/carla-simulator/rllib-integration/blob/main/dqn_example/dqn_autoscaler.yaml"><code>dqn_autoscaler.yaml</code></a> 提供的信息更新<code>&lt;ImageId&gt;</code>和<code>&lt;SecurityGroupIds&gt;</code>设置。</p>
</li>
<li>
<p>初始化集群：</p>
<pre><code>ray up dqn_example/dqn_autoscaler.yaml
</code></pre>
</li>
<li>
<p>（可选）使用本地更改更新远程文件：</p>
<pre><code>ray rsync-up dqn_example/dqn_autoscaler.yaml dqn_example .
ray rsync-up dqn_example/dqn_autoscaler.yaml rllib_integration .
</code></pre>
</li>
<li>
<p>运行训练：</p>
<pre><code>ray submit dqn_example/dqn_autoscaler.yaml dqn_train.py -- dqn_example/dqn_config.yaml --auto
</code></pre>
</li>
</ol>
<p>6.（可选）监控集群状态：</p>
<pre><code>    ray attach dqn_example/dqn_autoscaler.yaml
    watch -n 1 ray status
</code></pre>
<ol>
<li>关闭集群：<pre><code>ray down dqn_example/dqn_autoscaler.yaml
</code></pre>
</li>
</ol>
<hr />
<p>本指南概述了如何在 AWS 和本地计算机上安装和运行 RLlib 集成。如果您对本指南有任何疑问或遇到任何问题，请随时在 <a href="https://github.com/carla-simulator/carla/discussions/">论坛</a> 中发帖或在 <a href="https://github.com/carla-simulator/rllib-integration">GitHub</a> 上提出问题。</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
