<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Camera analysis - 代理模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Camera analysis";
        var mkdocs_page_input_path = "sensor/camera_analysis.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 代理模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">代理模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Camera analysis</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/sensor/camera_analysis.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="_1">自带语义分割传感器实现路径</h2>
<p>本文从 Carla 出发，深入UE内部，来理解 Carla 中的视觉传感器及真值系统的实现原理。</p>
<h3 id="1">1、知识铺垫</h3>
<p>Carla RGB 摄像头传感器代码分析讲了 Camera 之间的继承关系。下图表达它们的层次关系：</p>
<p><img alt="camera_inherit" src="../../img/sensor/camera_inherit.jpg" /></p>
<ul>
<li><strong>ASensor</strong> 完成 Carla 的抽象传感器功能；</li>
<li><strong>ASceneCaptureSensor</strong> 实现UE渲染接口，<code>UTextureRenderTarget2D</code> 和 <code>USceneCaptureComponent2D</code> 的加入，并且 <code>USceneCaptureComponent2D</code> 控制着后处理（<code>FPostProcessingSetting</code>）参数；</li>
<li><strong>AShaderBasedSensor</strong> 主要负责加入后处理材质(PostProcessing Material)，后处理材质也是一种着色器(shader)，对着色有影响，AShaderBasedSensor是抽象类，不是具体的传感器函数，所以只提供功能，供继承子类扩展着色器；</li>
<li><strong>ASceneCaptureCamera</strong>，<code>ASemanticSegmentationCamera</code>，<code>AOpticalFlowCamera</code>，<code>ASemanticSegmentationCamera</code> 等其他 camera 均继承自AShaderBasedSensor，它们的逻辑大多都很简单，就是使用 AShaderBasedSensor 提供的 AddPostProcessingMaterial 接口，添加后处理材质，根据不同的传感器类型，有不同的着色需求。</li>
</ul>
<h3 id="2ue">2、UE层面理解相机</h3>
<ul>
<li>后处理材质放置位置</li>
</ul>
<p>从代码中去看，拿 <a href="https://github.com/OpenHUTB/carla/blob/ue4-dev/Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.cpp">语义分割相机</a> 举例，该传感器用了两个后处理材质：物理畸变模型、GroundTruth标注。
<div class="highlight"><pre><span></span><code><span class="n">ASemanticSegmentationCamera</span><span class="o">::</span><span class="n">ASemanticSegmentationCamera</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// AddPostProcessingMaterial()在给定的路径上加载 UMaterialInstanceDynamic，并将其附加到具有权重的着色器列表中。</span>
<span class="w">  </span><span class="n">AddPostProcessingMaterial</span><span class="p">(</span>
<span class="w">      </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Material&#39;/Carla/PostProcessingMaterials/PhysicLensDistortion.PhysicLensDistortion&#39;&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">AddPostProcessingMaterial</span><span class="p">(</span>
<span class="w">      </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Material&#39;/Carla/PostProcessingMaterials/GTMaterial.GTMaterial&#39;&quot;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></p>
<p>从虚幻编辑器里面去找，该文件属于 Carla 插件带的材质，不属于场景内容文件，所以要在视图选项中选上<code>显示插件内容</code>，才能在左边的<code>内容浏览器</code>目录中看到<code>CARLA内容</code>。在<code>PostProcessingMaterials</code>路径下就可以看到<code>PhysicLensDistortion</code>和<code>GTMaterial</code>的材质文件。</p>
<p><img alt="camera_inherit" src="../../img/sensor/display_plugin_content.jpg" /></p>
<p>点开后可以看到该材质文件的蓝图逻辑：</p>
<p><img alt="material_bp" src="../../img/sensor/material_bp.jpg" /></p>
<ul>
<li>在虚幻编辑器里可视化相机</li>
</ul>
<p>参考 <a href="https://blog.csdn.net/lei_7103/article/details/106020942">UE4场景采集之场景采集2D</a> ，很推荐熟练掌握在虚幻编辑器中使用各种Component的方式，因为这样会比重新写代码，编译代码，验证问题整个流程快很多，很多时候我们调整的Component参数可以直接在Editor里面尝试，可视化效果，在传感器开发尤其重要。</p>
<p>下面用视频简单介绍一下 <code>UTextureRenderTarget2D</code> 和 <code>USceneCaptureComponent2D</code> 到底是什么：</p>
<p>视频里主要做了几个操作：</p>
<p>1.在<code>放置Actor</code>中搜索 <code>场景捕获2D(SceneCapture2D)</code> 拖入场景，会产生一个类似摄像机的物体；
<img alt="material_bp" src="../../img/sensor/1_scene_capture.jpg" /></p>
<p>2.在<code>内容浏览器</code>空白处右键，创建一个 <code>材质和纹理 -&gt; 渲染目标(TextureRenderTarget2D)</code>，创建后重命名为<code>RenderTexture2D</code>。
<img alt="material_bp" src="../../img/sensor/2_create_TextureRenderTarget2D.jpg" /></p>
<p>3.将画布渲染目标 <code>TextureRenderTarget2D</code> 指派给场景捕获2D <code>SceneCapture2D</code>
<img alt="material_bp" src="../../img/sensor/3_assign_to_SceneCapture2D.jpg" /></p>
<p>4.给画布渲染目标 <code>TextureRenderTarget2D</code> 创建材质：右键画布渲染目标，选择
<img alt="material_bp" src="../../img/sensor/4_create_material.jpg" /></p>
<p>5.双击打开内容浏览器中的<code>场景捕获2D</code>(RenderTexture2D)，选择不同的渲染输出内容（可以选法线、底色、LDR、HDR 等）可以看到不同的场景捕获效果。
<img alt="material_bp" src="../../img/sensor/5_select_capture_source.jpg" /></p>
<p>6.在 <code>后期处理体积</code> 里面，添加后处理材质，并选择从现有资产中添加</p>
<p>7.加入不同的后处理材质，查看效果</p>
<p>经过这些操作，大概就了解了它们分别是什么角色：<code>USceneCaptureComponent2D</code> 负责设置渲染的视角（FViewInfo）、传感器外参、后处理参数设置（FPostProcessSettings）、捕获源（Capture Source）等渲染需要的参数。
<code>UTextureRenderTarget2D</code> 负责记录渲染结果，<code>捕获源</code>里面是该场景捕捉器的渲染结果 Texture，然后通过一些取出 Buffer 的方式，将该渲染结果取出，然后通过 Carla 的一些传输数据方式，传给客户端，然后再解码二进制。</p>
<h3 id="3">3、语义分割的实现原理</h3>
<ul>
<li>语义分割的后处理材质蓝图</li>
</ul>
<p>双击打开材质<code>Carla内容/PostProcessingMaterials/GTMaterial</code>
<img alt="material_bp" src="../../img/sensor/GTMaterial.jpg" /></p>
<p>首先该材质里引入了两个概念：场景深度、自定义深度。<code>场景深度</code>就是用于渲染的 Z-Depth，光栅渲染判断前后关系用的，在GBuffer中也存在；<code>自定义深度</code>，<code>自定义深度模具</code>值（Custom Depth Stentil Value），Carla 拿来做语义分割的标记，以 Actor 为单位，可以用来区分不同物体，最后根据这个与 Carla 内部逻辑，对图像进行上色（参考 <a href="../../tuto_D_create_semantic_tags/">创建语义标签</a> ）。</p>
<p>比如，如路面是7，路线是6。</p>
<p><img alt="material_bp" src="../../img/sensor/semantic_tags.jpg" /></p>
<h3 id="_2">参考</h3>
<ul>
<li><a href="https://bbs.carla.org.cn/info/532d57cf2725474b8878a67282ef6e3f?csr=1">视觉传感器系列实现原理分析</a></li>
<li><a href="https://blog.csdn.net/weixin_74205939/article/details/140893454">UE场景捕获2d 简单监视器效果</a></li>
<li><a href="https://mazhengg.github.io/2019/03/29/%E4%B8%96%E7%95%8C%E3%80%81%E7%9B%B8%E6%9C%BA%E3%80%81%E5%9B%BE%E5%83%8F%E5%92%8C%E5%83%8F%E7%B4%A0%E5%9D%90%E6%A0%87%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2/">世界、相机、图像和像素坐标之间的转换</a> ：<a href="https://zhuanlan.zhihu.com/p/379269769">详细矩阵的参数信息</a> </li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
