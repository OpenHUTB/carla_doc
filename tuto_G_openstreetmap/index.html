<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>使用 OpenStreetMap 生成地图 - 代理模拟器</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u4f7f\u7528 OpenStreetMap \u751f\u6210\u5730\u56fe";
        var mkdocs_page_input_path = "tuto_G_openstreetmap.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 代理模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">代理模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">使用 OpenStreetMap 生成地图</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/tuto_G_openstreetmap.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="openstreetmap">使用 OpenStreetMap 生成地图</h1>
<p>在本指南中，您将学习：</p>
<ul>
<li>如何从 OpenStreetMaps 导出地图。</li>
<li>Carla 中可以使用的不同格式的地图以及每种格式的限制。</li>
<li>如何将本机<code>.osm</code>格式转换为<code>.xodr</code>。</li>
<li>如何在<code>.xodr</code>文件中包含交通灯信息。</li>
<li>如何在 Carla 模拟中运行最终地图。</li>
</ul>
<p><a href="https://www.openstreetmap.org">OpenStreetMap</a> 是由数千名贡献者开发的开放数据世界地图，并根据<a href="https://opendatacommons.org/licenses/odbl/">Open Data Commons Open Database License</a> 获得许可。地图的各个部分可以导出为 XML 格式的<code>.osm</code>文件。Carla 可以将此文件转换为 OpenDRIVE 格式并使用 <a href="#adv_opendrive.md">OpenDRIVE Standalone Mode</a> 导入它。</p>
<ul>
<li><a href="#export-a-map-with-openstreetmap"><strong>使用 OpenStreetMap 导出地图</strong></a></li>
<li><a href="#using-openstreetmaps-in-carla"><strong>在 Carla 中使用 OpenStreetMaps</strong></a></li>
<li><a href="#convert-openstreetmap-format-to-opendrive-format"><strong>将 OpenStreetMap 格式转换为 OpenDRIVE 格式</strong></a><ul>
<li><a href="#linux">Linux</a></li>
<li><a href="#windows">Windows</a></li>
<li><a href="#generate-traffic-lights">生成交通灯</a></li>
</ul>
</li>
<li><a href="#ingest-into-carla"><strong>导入 Carla</strong></a></li>
</ul>
<hr />
<h2 id="openstreetmap_1">使用 OpenStreetMap 导出地图 <span id="export-a-map-with-openstreetmap"></span></h2>
<p>本节介绍如何从 Open Street Map 导出所需的地图信息：</p>
<p><strong>1.</strong> 导航至 <a href="https://www.openstreetmap.org">Open Street Map 网站</a> 。您将在窗口右侧看到地图视图和一个面板，您可以在其中配置不同的地图图层、查询不同的要素、切换图例等。</p>
<p><strong>2.</strong> 搜索您想要的位置并放大到特定区域。</p>
<p><img alt="openstreetmap_view" src="../img/tuto_g_osm_web.jpg" /></p>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>如果您想使用大范围的地图，例如巴黎，您可以考虑使用 Carla 的 <a href="../large_map_overview/"><strong>大地图功能</strong> </a> 。</p>
</div>
<p><strong>3.</strong> 单击窗口左上角的“导出( <em>Export</em> )”以打开“导出(<em>Export</em>)”面板。</p>
<p><strong>4.</strong> 单击“<em>导出</em>”面板中的“_手动_选择不同区域”。</p>
<p><strong>5.</strong> 通过拖动视口中方形区域的角来选择自定义区域。</p>
<p><strong>6.</strong> 单击导出面板中的 <em>导出</em> 按钮，将所选区域的地图信息保存为<code>.osm</code>文件。</p>
<p><img alt="openstreetmap_area" src="../img/tuto_g_osm_area.jpg" /></p>
<hr />
<h2 id="carla-openstreetmaps">在 Carla 中使用 OpenStreetMaps <span id="using-openstreetmaps-in-carla"></span></h2>
<p>开放街道地图数据可以通过三种不同的方法在 Carla 中使用。您使用的方法取决于数据是否为原始格式，或者您是否使用以下部分中说明的转换方法来转换<code>.osm</code>文件。<code>.osm</code>保留文件是最受限制的方法，因为它不允许自定义设置。</p>
<p><strong>可用 <code>.xodr</code> 格式选项：</strong></p>
<ul>
<li>在您自己的脚本中生成地图。 <strong>该方法允许参数化。</strong></li>
<li>将文件作为参数传递给 Carla 的 <code>config.py</code>。 <strong>此方法不允许参数化。</strong></li>
</ul>
<p><strong>可用 <code>.osm</code> 格式选项：</strong></p>
<ul>
<li>将文件作为参数传递给 Carla 的 <code>config.py</code>。 <strong>此方法不允许参数化。</strong></li>
</ul>
<p>以下部分将提供有关上面列出的选项的更多详细信息。</p>
<hr />
<h2 id="openstreetmap-opendrive">将 OpenStreetMap 格式转换为 OpenDRIVE 格式 <span id="convert-openstreetmap-format-to-opendrive-format"></span></h2>
<p>本节演示如何使用 Python API 将我们在上一节中导出的 <code>.osm</code> 文件转换为<code>.xodr</code>格式，以便可以在 Carla 中使用。</p>
<p><a href="../python_api/#carla.Osm2OdrSettings">carla.Osm2OdrSettings</a>类用于配置转换设置，例如偏移值、交通灯生成、原点坐标等。可配置参数的完整列表可以在 Python API <a href="../python_api/#carla.Osm2OdrSettings">文档</a> 中找到。<a href="../python_api/#carla.Osm2Odr">carla.Osm2Odr</a> 类使用这些设置来解析<code>.osm</code>数据并以 <code>.xodr</code> 格式输出。</p>
<p>在 Windows 中，<code>.osm</code>文件必须编码为<code>UTF-8</code>. 这在 Linux 中是不必要的。以下是示例代码片段，显示如何根据您的操作系统执行文件转换：</p>
<h5 id="linux">Linux <span id="linux"></span></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 读取 .osm 数据</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;path/to/osm/file&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">osm_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># 定义想要的设置。在该案例中为默认值。values.</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2OdrSettings</span><span class="p">()</span>
<span class="c1"># 设置导出到 OpenDRIVE 的 OSM 道路类型。</span>
<span class="n">settings</span><span class="o">.</span><span class="n">set_osm_way_types</span><span class="p">([</span><span class="s2">&quot;motorway&quot;</span><span class="p">,</span> <span class="s2">&quot;motorway_link&quot;</span><span class="p">,</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span> <span class="s2">&quot;trunk_link&quot;</span><span class="p">,</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;secondary&quot;</span><span class="p">,</span> <span class="s2">&quot;secondary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;tertiary&quot;</span><span class="p">,</span> <span class="s2">&quot;tertiary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;unclassified&quot;</span><span class="p">,</span> <span class="s2">&quot;residential&quot;</span><span class="p">])</span>
<span class="c1"># 转为 .xodr</span>
<span class="n">xodr_data</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2Odr</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">osm_data</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

<span class="c1"># 保存为 opendrive 文件</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;path/to/output/file&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xodr_data</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<h5 id="windows">Windows <span id="windows"></span></h5>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io</span>

<span class="c1"># 读取 .osm 数据</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="n">osm_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># 定义想要的设置。在该案例中为默认值。</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2OdrSettings</span><span class="p">()</span>
<span class="c1"># 设置导出成 OpenDRIVE 的 OSM 道路类型</span>
<span class="n">settings</span><span class="o">.</span><span class="n">set_osm_way_types</span><span class="p">([</span><span class="s2">&quot;motorway&quot;</span><span class="p">,</span> <span class="s2">&quot;motorway_link&quot;</span><span class="p">,</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span> <span class="s2">&quot;trunk_link&quot;</span><span class="p">,</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;secondary&quot;</span><span class="p">,</span> <span class="s2">&quot;secondary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;tertiary&quot;</span><span class="p">,</span> <span class="s2">&quot;tertiary_link&quot;</span><span class="p">,</span> <span class="s2">&quot;unclassified&quot;</span><span class="p">,</span> <span class="s2">&quot;residential&quot;</span><span class="p">])</span>
<span class="c1"># 转为 .xodr</span>
<span class="n">xodr_data</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2Odr</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">osm_data</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

<span class="c1"># 保存成 opendrive 文件</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;path/to/output/file&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xodr_data</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<br></p>
<hr />
<h3 id="_1">生成交通灯 <span id="generate-traffic-lights"></span></h3>
<p>Open Street Map 数据可以定义哪些路口受交通灯控制。要在 Carla 中使用此交通灯数据，您需要在将<code>.osm</code>文件转换为<code>.xodr</code>格式之前通过 Python API 在 OSM 地图设置中启用它：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 定义想要的设置。在该案例中为默认值。</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2OdrSettings</span><span class="p">()</span>
<span class="c1"># 启用从 OSM 数据中生成交通灯</span>
<span class="n">settings</span><span class="o">.</span><span class="n">generate_traffic_lights</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># 转为 .xodr</span>
<span class="n">xodr_data</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Osm2Odr</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">osm_data</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</code></pre></div>
<p>交通灯数据质量可能因提取数据的区域而异。一些交通灯信息可能完全丢失。要克服这些限制，您可以使用 Python API 将所有路口配置为由交通灯控制：</p>
<div class="highlight"><pre><span></span><code><span class="n">settings</span><span class="o">.</span><span class="n">all_junctions_with_traffic_lights</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p>您还可以排除某些道路（例如高速公路链接）生成交通信号灯：</p>
<div class="highlight"><pre><span></span><code>settings.set_traffic_light_excluded_way_types([&quot;motorway_link&quot;])
</code></pre></div>
<hr />
<h2 id="carla">导入 Carla <span id="ingest-into-carla"></span></h2>
<p>本节介绍如何使用可用的不同选项，通过 <a href="../adv_opendrive/">OpenDRIVE 独立模式</a>将 Open Street Map 信息提取到 Carla 中。</p>
<p>有以下三个选项可供选择：</p>
<p><a href="#a-use-your-own-script"><strong>A)</strong></a> 使用您自己的自定义 Python 脚本中的转换 <code>.xodr</code> 文件 <strong>生成地图该方法允许参数化</strong>。 
<a href="#b-pass-xodr-to-configpy"><strong>B)</strong></a> 将转换后的<code>.xodr</code>文件作为参数传递给 Carla <code>config.py</code> 脚本。<strong>此方法不允许参数化。</strong>
<a href="#c-pass-osm-to-configpy"><strong>C)</strong></a> 将原始<code>.osm</code>文件作为参数传递给 Carla <code>config.py</code> 脚本。<strong>此方法不允许参数化。</strong></p>
<h6 id="a">A) 使用您自己的脚本</h6>
<p>生成新地图并阻止模拟，直到通过调用 <a href="../python_api/#carla.Client.generate_opendrive_world"><code>client.generate_opendrive_world()</code></a> 准备就绪。使用<a href="../python_api/#carla.OpendriveGenerationParameters">carla.OpendriveGenerationParameters</a>类配置网格生成。请参阅下面的示例：</p>
<div class="highlight"><pre><span></span><code><span class="n">vertex_distance</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># 以米为单位</span>
<span class="n">max_road_length</span> <span class="o">=</span> <span class="mf">500.0</span> <span class="c1"># 以米为单位</span>
<span class="n">wall_height</span> <span class="o">=</span> <span class="mf">0.0</span>      <span class="c1"># 以米为单位</span>
<span class="n">extra_width</span> <span class="o">=</span> <span class="mf">0.6</span>      <span class="c1"># 以米为单位</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">generate_opendrive_world</span><span class="p">(</span>
    <span class="n">xodr_xml</span><span class="p">,</span> <span class="n">carla</span><span class="o">.</span><span class="n">OpendriveGenerationParameters</span><span class="p">(</span>
        <span class="n">vertex_distance</span><span class="o">=</span><span class="n">vertex_distance</span><span class="p">,</span>
        <span class="n">max_road_length</span><span class="o">=</span><span class="n">max_road_length</span><span class="p">,</span>
        <span class="n">wall_height</span><span class="o">=</span><span class="n">wall_height</span><span class="p">,</span>
        <span class="n">additional_width</span><span class="o">=</span><span class="n">extra_width</span><span class="p">,</span>
        <span class="n">smooth_junctions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">enable_mesh_visibility</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</code></pre></div>
<div class="admonition 笔记">
<p class="admonition-title">笔记</p>
<p>强烈推荐<code>wall_height = 0.0</code>。OpenStreetMap 将相反方向的车道定义为不同的道路。如果生成墙壁，这将导致墙壁重叠和意外的碰撞。</p>
</div>
<h6 id="b-xodr-configpy">B) 将 <code>.xodr</code> 传递给 <code>config.py</code></h6>
<p>启动 Carla 服务器后，在单独的终端中运行以下命令来加载 Open Street Map：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PythonAPI/util

python3<span class="w"> </span>config.py<span class="w"> </span>-x<span class="o">=</span>/path/to/xodr/file
</code></pre></div>
<p>将使用 <a href="../python_api/#carla.OpendriveGenerationParameters">默认参数</a> 。</p>
<h6 id="c-osm-configpy">C) 将 <code>.osm</code> 传递给 <code>config.py</code></h6>
<p>启动 Carla 服务器后，在单独的终端中运行以下命令来加载 Open Street Map：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PythonAPI/util

python3<span class="w"> </span>config.py<span class="w"> </span>--osm-path<span class="o">=</span>/path/to/OSM/file
</code></pre></div>
<p>将使用<a href="../python_api/#carla.OpendriveGenerationParameters">默认参数</a>。 </p>
<p>无论使用哪种方法，地图都将被导入到 Carla 中，结果应类似于下图：</p>
<p><img alt="opendrive_meshissue" src="../img/tuto_g_osm_carla.jpg" />
<center> 使用 OpenStreetMap 生成 Carla 地图的结果。 </center></p>
<p><br></p>
<div class="admonition 警告">
<p class="admonition-title">警告</p>
<p>生成的道路在地图的边界处突然结束。当车辆无法找到下一个路径点时，这将导致交通管理器崩溃。为了避免这种情况，交通管理器中的 OSM 模式默认设置为True ( <a href="../python_api/#carlatrafficmanager"><code>set_osm_mode()</code></a> )。这将在必要时显示警告并销毁车辆。</p>
</div>
<hr />
<p>与此主题相关的任何问题和疑问都可以在 Carla 论坛中发布。</p>
<div class="build-buttons">
<p>
<a href="https://github.com/carla-simulator/carla/discussions/" target="_blank" class="btn btn-neutral" title="Go to the CARLA forum">
Carla 论坛</a>
</p>
</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
