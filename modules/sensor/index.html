<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>第一章：CARLA 碰撞事件传感器系统（sensor.other.collision） - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u7b2c\u4e00\u7ae0\uff1aCARLA \u78b0\u649e\u4e8b\u4ef6\u4f20\u611f\u5668\u7cfb\u7edf\uff08sensor.other.collision\uff09";
        var mkdocs_page_input_path = "modules/sensor.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">第一章：CARLA 碰撞事件传感器系统（sensor.other.collision）</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/sensor.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="carla-sensorothercollision">第一章：CARLA 碰撞事件传感器系统（sensor.other.collision）</h1>
<hr />
<h2 id="1">1 模块概览</h2>
<p>本章详细讲解 CARLA 模拟器中的一类简单传感器：<code>sensor.other.collision</code>，即碰撞事件传感器。该传感器不输出连续的数据流信息，而是在检测到实体碰撞时以事件形式即时触发。其设计初衷是为用户提供车辆与环境中其他对象之间物理交互的监控能力。</p>
<p>在自动驾驶仿真、强化学习安全评估或碰撞规避算法验证中，<code>sensor.other.collision</code> 提供了关键的反馈信号。通过对其数据结构、序列化机制与客户端回调触发流程的深入解析，可全面理解该传感器在 CARLA 感知系统中的运行机制及其工程实现。</p>
<hr />
<h2 id="2">2 传感器注册与调用原理</h2>
<p>CARLA 所有传感器，包括 <code>sensor.other.collision</code>，均基于统一的 Actor 注册与绑定框架。其创建与工作流程可分为以下几个核心阶段：</p>
<ul>
<li><strong>蓝图注册阶段</strong>：CARLA 所有传感器类型在 Unreal Engine 的蓝图系统中定义，供客户端调用。</li>
<li><strong>Actor 创建阶段</strong>：Python 客户端通过 <code>world.spawn_actor()</code> 创建 <code>"sensor.other.collision"</code> 实例。</li>
<li><strong>传感器通道建立</strong>：Actor 自动绑定底层的 <code>SensorData</code> 数据类型，用户通过 <code>.listen()</code> 注册事件处理函数。</li>
<li><strong>事件触发与传输机制</strong>：</li>
<li>服务端生成 <code>CollisionEvent</code> 事件（Bullet 引擎）</li>
<li>使用 <a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/s11n/CollisionEventSerializer.h"><code>CollisionEventSerializer</code></a> 编码为 <code>RawData</code></li>
<li>通过 RPC 网络发送</li>
<li>客户端使用 <code>Deserialize()</code> 解码为 <code>SensorData</code></li>
<li>注入回调函数中进行处理
     <img alt="flowchart.jpg" src="../../img/modules/flowchart.jpg" />
该流程构成事件捕捉 → 数据序列化 → 网络传输 → 解码还原 → 客户端处理的完整通路。</li>
</ul>
<hr />
<h2 id="3-collisionevent">3 数据结构：CollisionEvent</h2>
<p>定义文件：<a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/data/CollisionEvent.h"><code>carla/sensor/data/CollisionEvent.h</code></a></p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">CollisionEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">self_actor</span><span class="p">;</span>
<span class="w">  </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">other_actor</span><span class="p">;</span>
<span class="w">  </span><span class="n">geom</span><span class="o">::</span><span class="n">Vector3D</span><span class="w"> </span><span class="n">normal_impulse</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<ul>
<li><code>self_actor</code>：传感器附着实体（如车辆）</li>
<li><code>other_actor</code>：碰撞对象（如障碍物、NPC）</li>
<li><code>normal_impulse</code>：冲击力矢量，反映碰撞强度与方向</li>
</ul>
<hr />
<h2 id="4-collisioneventserializer">4 序列化器分析：CollisionEventSerializer</h2>
<p>定义文件：<br />
<a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/s11n/CollisionEventSerializer.h"><code>CollisionEventSerializer.h</code></a><br />
<a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/s11n/CollisionEventSerializer.cpp"><code>CollisionEventSerializer.cpp</code></a></p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Data</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">self_actor</span><span class="p">;</span>
<span class="w">  </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">other_actor</span><span class="p">;</span>
<span class="w">  </span><span class="n">geom</span><span class="o">::</span><span class="n">Vector3D</span><span class="w"> </span><span class="n">normal_impulse</span><span class="p">;</span>
<span class="w">  </span><span class="n">MSGPACK_DEFINE_ARRAY</span><span class="p">(</span><span class="n">self_actor</span><span class="p">,</span><span class="w"> </span><span class="n">other_actor</span><span class="p">,</span><span class="w"> </span><span class="n">normal_impulse</span><span class="p">)</span>
<span class="p">};</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">SensorT</span><span class="o">&gt;</span>
<span class="k">static</span><span class="w"> </span><span class="n">Buffer</span><span class="w"> </span><span class="n">Serialize</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SensorT</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">self_actor</span><span class="p">,</span>
<span class="w">    </span><span class="n">rpc</span><span class="o">::</span><span class="n">Actor</span><span class="w"> </span><span class="n">other_actor</span><span class="p">,</span>
<span class="w">    </span><span class="n">geom</span><span class="o">::</span><span class="n">Vector3D</span><span class="w"> </span><span class="n">normal_impulse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">MsgPack</span><span class="o">::</span><span class="n">Pack</span><span class="p">(</span><span class="n">Data</span><span class="p">{</span><span class="n">self_actor</span><span class="p">,</span><span class="w"> </span><span class="n">other_actor</span><span class="p">,</span><span class="w"> </span><span class="n">normal_impulse</span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">SharedPtr</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Deserialize</span><span class="p">(</span><span class="n">RawData</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SharedPtr</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">data</span><span class="o">::</span><span class="n">CollisionEvent</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="5-rawdata-sensordata">5 RawData 与 SensorData 概述</h2>
<p>数据结构定义：<br />
<a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/RawData.h"><code>RawData.h</code></a><br />
<a href="https://github.com/OpenHUTB/carla_cpp/blob/dev/LibCarla/source/carla/sensor/SensorData.h"><code>SensorData.h</code></a></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RawData</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">GetFrame</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="nf">GetTimestamp</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">rpc</span><span class="o">::</span><span class="n">Transform</span><span class="w"> </span><span class="o">&amp;</span><span class="nf">GetSensorTransform</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="nf">begin</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SensorData</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">EnableSharedFromThis</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">NonCopyable</span><span class="w"> </span><span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">  </span><span class="n">SensorData</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rpc</span><span class="o">::</span><span class="n">Transform</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sensor_transform</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<hr />
<h2 id="6-python-api">6 Python API 使用示例</h2>
<p>参考文件：<a href="https://github.com/OpenHUTB/carla_doc/blob/dev/src/examples/collision_sensor.py"><code>collision_sensor.py</code></a></p>
<div class="highlight"><pre><span></span><code>def on_collision(event):
    actor = event.other_actor
    impulse = event.normal_impulse
    print(f&quot;发生碰撞！对象类型：{actor.type_id}，冲击向量：{impulse}&quot;)
</code></pre></div>
<div class="highlight"><pre><span></span><code>blueprint_library = world.get_blueprint_library()
bp = blueprint_library.find(&#39;sensor.other.collision&#39;)
transform = carla.Transform(carla.Location(x=0, y=0, z=2.0))
sensor = world.spawn_actor(bp, transform, attach_to=vehicle)
sensor.listen(on_collision)
</code></pre></div>
<hr />
<h2 id="7">7 小结与拓展</h2>
<ul>
<li><code>sensor.other.collision</code> 是轻量、事件驱动的传感器</li>
<li>使用 <code>MsgPack + RawData</code> 组合，编码效率高</li>
<li>常用于：碰撞检测、事故分析、惩罚信号生成</li>
</ul>
<h3 id="_1">可拓展方向：</h3>
<ul>
<li>增加字段（如速度向量、碰撞位置）</li>
<li>结合图像、GNSS 数据实现回溯系统</li>
<li>与强化学习结合生成动态规避策略</li>
</ul>
<hr />
<h1 id="carla-sensorothernoop">第二章：CARLA 空传感器系统（sensor.other.noop）</h1>
<hr />
<h2 id="1_1">1 模块概览</h2>
<p>本章介绍 CARLA 模拟器中最为简化的一类传感器：<code>sensor.other.noop</code>，即“无操作传感器”（No-Operation Sensor）。顾名思义，该传感器不会向客户端发送任何数据，其存在的意义更多是作为客户端挂载传感器的占位符、功能测试器或新传感器开发的最小模板。</p>
<p><code>sensor.other.noop</code> 适用于以下场景：</p>
<ul>
<li>构建新型传感器时的起始模板；</li>
<li>用于网络与回调机制调试，无需实际数据；</li>
<li>占位传感器（需要绑定但暂时不产出数据）；</li>
<li>模拟传感器失败或无响应场景下的系统行为。</li>
</ul>
<p>其核心特征是：<strong>不参与数据流的任何阶段</strong>，服务端不会推送数据，客户端接收到数据则立即报错。</p>
<hr />
<h2 id="2_1">2 传感器注册与调用原理</h2>
<p><code>sensor.other.noop</code> 遵循 CARLA 所有传感器统一的注册、挂载、通信框架，其调用流程包括以下几个阶段：</p>
<ul>
<li><strong>蓝图注册阶段</strong>：该传感器在 Unreal Engine 蓝图系统中以 <code>"sensor.other.noop"</code> 注册，蓝图库中包含其类型定义。</li>
<li><strong>Actor 创建阶段</strong>：客户端通过 <code>world.spawn_actor()</code> 创建该传感器实例，传入 <code>"sensor.other.noop"</code> 字符串作为蓝图 ID，实例可附着至车辆或动态对象。</li>
<li><strong>传感器监听绑定</strong>：</li>
<li>可通过 <code>.listen()</code> 注册 Python 回调函数；</li>
<li>但由于此传感器不会生成任何事件，回调函数永远不会被实际调用；</li>
<li>若数据进入系统，将由序列化器直接拒绝并抛出异常。</li>
</ul>
<hr />
<h2 id="3-noopserializer">3 序列化器分析：NoopSerializer</h2>
<p>该序列化器专为“客户端不接收数据”的传感器设计，核心逻辑是禁止任何数据反序列化。</p>
<h3 id="31">3.1 接口定义</h3>
<div class="highlight"><pre><span></span><code><span class="c1">/// Dummy serializer that blocks all the data.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoopSerializer</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="p">[[</span><span class="n">noreturn</span><span class="p">]]</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">SharedPtr</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Deserialize</span><span class="p">(</span><span class="n">RawData</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>说明：</p>
<ul>
<li><code>[[noreturn]]</code> 是 C++11 标准修饰符，表示该函数永不返回；</li>
<li>调用该函数将抛出异常，标志该传感器设计为“不可反序列化”。</li>
</ul>
<h3 id="32">3.2 函数实现</h3>
<div class="highlight"><pre><span></span><code><span class="n">SharedPtr</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NoopSerializer</span><span class="o">::</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">RawData</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">throw_exception</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;NoopSerializer: Invalid data received.&quot;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>说明：</p>
<ul>
<li>使用 CARLA 提供的 <code>throw_exception</code> 工具函数；</li>
<li>一旦客户端尝试处理此类型数据，即触发中断错误；</li>
<li>该机制确保 <code>sensor.other.noop</code> 无法被误用。</li>
</ul>
<hr />
<h2 id="4">4 数据结构与传输机制</h2>
<p>该传感器不绑定任何结构化数据类型：</p>
<ul>
<li>不包含自定义数据结构（如 <code>NoopEvent</code>）；</li>
<li>不通过 <code>RawData</code> 传输任何内容；</li>
<li>无有效 <code>SensorData</code> 派生类实例生成；</li>
<li>虽然支持 <code>.listen()</code> 注册机制，但永不触发。</li>
</ul>
<p>因此，<code>sensor.other.noop</code> 是一种“存在但不发声”的传感器，仅用于挂载占位或调试目的。</p>
<hr />
<h2 id="5-python-api">5 Python API 使用示例</h2>
<p>虽然该传感器不传输数据，仍可正常在 Python 中创建与注册监听。</p>
<div class="highlight"><pre><span></span><code># 定义回调函数（注意：不会被调用）
def on_noop_event(event):
    print(&quot;此处不应出现任何输出&quot;)

# 获取蓝图库并查找蓝图
bp = world.get_blueprint_library().find(&#39;sensor.other.noop&#39;)

# 设置传感器相对位置
transform = carla.Transform(carla.Location(x=0, y=0, z=2.0))

# 创建传感器并附着至车辆
noop_sensor = world.spawn_actor(bp, transform, attach_to=vehicle)

# 注册监听函数（将不会触发）
noop_sensor.listen(on_noop_event)
</code></pre></div>
<p><strong>可选调试建议</strong>：</p>
<ul>
<li>可用日志验证传感器挂载成功；</li>
<li>可调用 <code>.destroy()</code> 观察销毁逻辑；</li>
<li>可组合多个传感器观察 <code>.listen()</code> 机制行为。</li>
</ul>
<hr />
<h2 id="6">6 小结与拓展</h2>
<ul>
<li><code>sensor.other.noop</code> 是 CARLA 中结构最简、用途最特殊的一类传感器；</li>
<li>其核心设计目的是：禁止数据流通，仅做占位和调试；</li>
<li>非常适合作为自定义传感器的开发模板或序列化链测试工具。</li>
</ul>
<h3 id="_2">拓展建议：</h3>
<ul>
<li>作为新事件传感器的起点模板；</li>
<li>用于测试 <code>.listen()</code> 和 <code>.destroy()</code> 回调流程；</li>
<li>模拟传感器故障、异常或丢包处理机制；</li>
<li>可组合图像、IMU 等实际传感器测试是否发生调用竞争或系统冲突。</li>
</ul>
<hr />
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
