<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Traffic Manager - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Traffic Manager";
        var mkdocs_page_input_path = "modules/trafficmanager.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Traffic Manager</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/trafficmanager.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="traffic-manager">Traffic Manager</h1>
<h2 id="traffic-manager_1">什么是 Traffic Manager？</h2>
<p>Traffic Manager（简称 TM）是 CARLA 模拟器中用于控制自动驾驶车辆行为的模块。它通过模拟真实的城市交通环境，生成符合交通规则的车辆行为，包括路径规划、避障、交通信号响应等。用户可以通过 TM 实现对车辆行为的细粒度控制，以满足特定的训练或测试需求。</p>
<h2 id="_1">架构概览</h2>
<p>TM 的架构由多个独立的阶段组成，每个阶段在不同的线程中运行，确保高效的并行处理。主要组件包括：</p>
<ul>
<li><strong>代理生命周期与状态管理（ALSM）</strong>：每帧扫描仿真环境中所有 Agent（如车辆和行人），记录其 ID、坐标、朝向、速度等信息。新增的车辆将被注册为 TM 控制对象，已销毁的车辆将被移除。</li>
</ul>
<p>ALSM 模块的核心是 <code>ALSM::Update()</code> 方法，它每帧执行以下任务：</p>
<ul>
<li>获取世界时间戳和参与者列表。</li>
<li>判断已注册和未注册的参与者是否已经销毁，并移除其状态（通过 <code>IdentifyDestroyedActors()</code> 和 <code>RemoveActor()</code> 实现）。</li>
<li>检查是否有新车辆或行人加入（<code>IdentifyNewActors()</code>），并注册新的对象到系统。</li>
<li>对于注册车辆，更新其状态、位置、速度、交通灯状态等，并按是否在“混合物理模式”中启用物理仿真（<code>UpdateRegisteredActorsData()</code> + <code>UpdateData()</code>）。</li>
<li>若某车辆长时间静止、非英雄角色且时间间隔满足条件，执行自动销毁。</li>
<li>若处于 OSM 模式，按需销毁“marked_for_removal”中的参与者。</li>
<li>更新所有未注册对象的状态并写入仿真状态系统（<code>UpdateUnregisteredActorsData()</code>）。</li>
<li>附加判断函数 <code>IsVehicleStuck()</code> 用于判断车辆是否卡住。</li>
</ul>
<p>ALSM 模块通过维护 <code>idle_time</code>、<code>hero_actors</code>、<code>unregistered_actors</code> 等状态表，结合定位、碰撞、交通灯、运动规划等阶段模块，形成了一个生命周期完整、响应实时的 Agent 管理系统。</p>
<p><strong>车辆注册表（Vehicle Registry）</strong>：是 Traffic Manager（TM）中用于管理所有被控制车辆的核心数据结构。该模块维护一个由车辆 ID 映射到车辆属性与控制参数的索引表，确保在整个仿真过程中 TM 能够高效、准确地读取和更新每辆车的状态。其主要职责包括：</p>
<ul>
<li><strong>车辆注册与注销</strong>：当新车辆被识别并纳入 TM 控制时，其 ID 和初始配置被写入车辆注册表；当车辆被销毁或移除时，其信息也从注册表中清除。</li>
<li><strong>行为参数存储与访问</strong>：每辆车都关联一组行为参数，例如期望速度、跟车距离、变道偏好、交通信号响应概率等。这些参数在运行时可通过接口动态修改，支持个性化行为建模。</li>
<li><strong>高效索引机制</strong>：通过哈希表维护车辆 ID 与车辆对象/状态的映射关系，提供常数时间复杂度的读写操作，保证在大规模仿真中依然具有良好的性能。</li>
<li><strong>线程安全支持</strong>：通过原子操作或加锁机制，确保在并发读取或更新过程中数据一致性，支持多线程环境下的 TM 控制循环。</li>
<li><strong>与阶段模块的数据同步</strong>：注册表中车辆的 ID 是后续各阶段（如定位、碰撞检测、运动规划）访问数据的入口，确保车辆状态在各处理阶段的一致性与连贯性。</li>
<li><strong>车辆状态快照支持</strong>：部分实现中，车辆注册表还可缓存车辆的静态信息（如尺寸、类型）和部分动态状态，供控制器或外部模块使用。</li>
</ul>
<p>示例行为配置接口（伪代码）：</p>
<div class="highlight"><pre><span></span><code><span class="n">vehicle_registry</span><span class="p">.</span><span class="n">SetDesiredSpeed</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="mf">15.0f</span><span class="p">);</span><span class="w">      </span><span class="c1">// 设置目标速度</span>
<span class="n">vehicle_registry</span><span class="p">.</span><span class="n">EnableAutoLaneChange</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// 启用自动变道</span>
<span class="n">vehicle_registry</span><span class="p">.</span><span class="n">SetIgnoreLightsProbability</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">);</span><span class="w"> </span><span class="c1">// 设置30%的概率忽视红灯</span>
</code></pre></div>
<p>总之，车辆注册表在 TM 中扮演类似“车辆数据库”的角色，是连接外部控制逻辑与内部状态维护的桥梁，其设计直接影响 Traffic Manager 的效率与行为灵活性。
- <strong>模拟状态缓存</strong>：为了提升性能，TM 并不会在每个阶段实时从仿真世界中提取状态，而是将所有车辆和行人的信息缓存下来，使得各计算阶段可以共享一致且高效的数据快照。
- <strong>控制循环（主调度器）</strong>：驱动 TM 的主循环机制，协调定位、碰撞检测、交通规则判断、运动控制等阶段，并在每一步完成后统一调度进入下一阶段，保证各线程的时序一致性。
- <strong>内存地图与网格路径</strong>：将仿真地图转换为更高效的拓扑结构，包括道路连接关系、车道几何等，并在该结构上生成稀疏网格路径（waypoints）供车辆导航。
- <strong>路径缓存与车辆轨迹（PBVT）</strong>：为每辆车维护一个未来若干秒的路径轨迹队列（Trajectory Buffer），其中的每个点都是基于当前位置规划出的可达路径，用于预测、避障和控制计算。
- <strong>PID 控制器</strong>：每辆车都通过其 PID 控制器根据期望路径点计算出实际控制命令（油门、刹车和方向盘），以最小化当前运动状态与路径目标之间的误差。
- <strong>命令数组控制器</strong>：在控制阶段结束后，所有车辆的控制指令被批量组织为一个控制命令数组，通过高效通道（如 client.apply_batch()）发送到 CARLA 服务器，实现高帧率控制。</p>
<h2 id="_2">控制循环的阶段</h2>
<ol>
<li>
<p><strong>定位阶段</strong>：根据每辆车当前的位置信息，查找其前方预定路径上的一组路点（Waypoints）。路径长度根据车速动态调整，确保路径点能够覆盖车辆数秒钟内的预期移动范围。该阶段还会处理路径重建请求，以适应新注册车辆或突发路径变更。</p>
</li>
<li>
<p><strong>碰撞检测阶段</strong>：分析当前路径点与其他动态对象（车辆、行人）的可能交叉情况，构建临时的局部避障图。若检测到潜在碰撞，会在车辆控制中插入速度限制、停车或绕行建议。</p>
</li>
<li>
<p><strong>交通灯阶段</strong>：识别路径中出现的红绿灯、停车标志、优先通行规则等信息。此阶段依据道路拓扑结构判断当前车道是否被交通信号所控制，并根据灯色状态决定是否停车或等待。</p>
</li>
<li>
<p><strong>运动规划阶段</strong>：使用 PID 控制器将车辆当前位置与路径点之间的差值转化为控制命令（油门、刹车、方向盘）。控制器不断调整以最小化路径误差，同时结合速度限制和行为参数（如期望速度、是否变道）进行动态调整。</p>
</li>
<li>
<p><strong>车灯控制阶段</strong>：根据运动规划的结果（如是否刹车、转向）设置车辆灯光状态。例如：当车辆计划左转时，激活左转向灯；减速时激活刹车灯；在夜间或低光照区域自动打开前照灯等。</p>
</li>
</ol>
<h2 id="traffic-manager_2">使用 Traffic Manager</h2>
<h3 id="_3">创建和配置</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">carla</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_world</span><span class="p">()</span>

<span class="c1"># 设置同步模式</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
<span class="n">settings</span><span class="o">.</span><span class="n">synchronous_mode</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">settings</span><span class="o">.</span><span class="n">fixed_delta_seconds</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">world</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

<span class="c1"># 获取 Traffic Manager 实例</span>
<span class="n">traffic_manager</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_trafficmanager</span><span class="p">()</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_synchronous_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="_4">控制车辆行为</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取车辆蓝图</span>
<span class="n">blueprint_library</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_blueprint_library</span><span class="p">()</span>
<span class="n">vehicle_bp</span> <span class="o">=</span> <span class="n">blueprint_library</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;vehicle.*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 获取地图上的生成点</span>
<span class="n">spawn_points</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_spawn_points</span><span class="p">()</span>

<span class="c1"># 生成车辆</span>
<span class="n">vehicle</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">spawn_actor</span><span class="p">(</span><span class="n">vehicle_bp</span><span class="p">,</span> <span class="n">spawn_points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># 启用自动驾驶</span>
<span class="n">vehicle</span><span class="o">.</span><span class="n">set_autopilot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 设置车辆行为参数</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">ignore_lights_percentage</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)</span>  <span class="c1"># 30% 的概率忽略红灯</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_desired_speed</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>         <span class="c1"># 设置期望速度为 20 m/s</span>
</code></pre></div>
<h2 id="_5">高级功能</h2>
<ul>
<li><strong>确定性模式</strong>：通过设置随机种子，确保每次模拟结果一致，便于测试和验证。</li>
<li><strong>混合物理模式</strong>：在车辆远离 Ego 车辆时，使用简化的物理模型，提高模拟效率。</li>
<li><strong>多 Traffic Manager 实例</strong>：支持在同一模拟中运行多个 TM 实例，分别控制不同的车辆组。</li>
<li><strong>同步模式</strong>：确保所有车辆在每个模拟步长中同步更新，适用于需要严格时间控制的场景。</li>
</ul>
<h2 id="_6">总结</h2>
<p>Traffic Manager 是 CARLA 模拟器中强大的工具，提供了对自动驾驶车辆行为的全面控制。通过合理配置 TM，可以模拟各种复杂的交通场景，满足自动驾驶系统的训练和测试需求。</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
