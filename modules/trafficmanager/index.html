<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Traffic Manager - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Traffic Manager";
        var mkdocs_page_input_path = "modules/trafficmanager.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Traffic Manager</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/trafficmanager.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="traffic-manager">Traffic Manager</h1>
<h2 id="traffic-manager_1">什么是 Traffic Manager？</h2>
<p>Traffic Manager（简称 TM）是 CARLA 模拟器中用于控制自动驾驶车辆行为的模块。它通过模拟真实的城市交通环境，生成符合交通规则的车辆行为，包括路径规划、避障、交通信号响应等。用户可以通过 TM 实现对车辆行为的细粒度控制，以满足特定的训练或测试需求。</p>
<h2 id="_1">架构概览</h2>
<p>TM 的架构由多个独立的阶段组成，每个阶段在不同的线程中运行，确保高效的并行处理。主要组件包括：</p>
<ul>
<li><strong>代理生命周期与状态管理（ALSM）</strong>：每帧扫描仿真环境中所有 Agent（如车辆和行人），记录其 ID、坐标、朝向、速度等信息。新增的车辆将被注册为 TM 控制对象，已销毁的车辆将被移除。</li>
</ul>
<p>ALSM 模块的核心是 <code>ALSM::Update()</code> 方法，它每帧执行以下任务：</p>
<ul>
<li>获取世界时间戳和参与者列表。</li>
<li>判断已注册和未注册的参与者是否已经销毁，并移除其状态（通过 <code>IdentifyDestroyedActors()</code> 和 <code>RemoveActor()</code> 实现）。</li>
<li>检查是否有新车辆或行人加入（<code>IdentifyNewActors()</code>），并注册新的对象到系统。</li>
<li>对于注册车辆，更新其状态、位置、速度、交通灯状态等，并按是否在“混合物理模式”中启用物理仿真（<code>UpdateRegisteredActorsData()</code> + <code>UpdateData()</code>）。</li>
<li>若某车辆长时间静止、非英雄角色且时间间隔满足条件，执行自动销毁。</li>
<li>若处于 OSM 模式，按需销毁“marked_for_removal”中的参与者。</li>
<li>更新所有未注册对象的状态并写入仿真状态系统（<code>UpdateUnregisteredActorsData()</code>）。</li>
<li>附加判断函数 <code>IsVehicleStuck()</code> 用于判断车辆是否卡住。</li>
</ul>
<p>ALSM 模块通过维护 <code>idle_time</code>、<code>hero_actors</code>、<code>unregistered_actors</code> 等状态表，结合定位、碰撞、交通灯、运动规划等阶段模块，形成了一个生命周期完整、响应实时的 Agent 管理系统。</p>
<p><strong>车辆注册表（Vehicle Registry）</strong>：是 Traffic Manager（TM）中用于管理所有被控制车辆的核心数据结构。该模块维护一个由车辆 ID 映射到车辆属性与控制参数的索引表，确保在整个仿真过程中 TM 能够高效、准确地读取和更新每辆车的状态。其主要职责包括：</p>
<ul>
<li><strong>车辆注册与注销</strong>：当新车辆被识别并纳入 TM 控制时，其 ID 和初始配置被写入车辆注册表；当车辆被销毁或移除时，其信息也从注册表中清除。</li>
<li><strong>行为参数存储与访问</strong>：每辆车都关联一组行为参数，例如期望速度、跟车距离、变道偏好、交通信号响应概率等。这些参数在运行时可通过接口动态修改，支持个性化行为建模。</li>
<li><strong>高效索引机制</strong>：通过哈希表维护车辆 ID 与车辆对象/状态的映射关系，提供常数时间复杂度的读写操作，保证在大规模仿真中依然具有良好的性能。</li>
<li><strong>线程安全支持</strong>：通过原子操作或加锁机制，确保在并发读取或更新过程中数据一致性，支持多线程环境下的 TM 控制循环。</li>
<li><strong>与阶段模块的数据同步</strong>：注册表中车辆的 ID 是后续各阶段（如定位、碰撞检测、运动规划）访问数据的入口，确保车辆状态在各处理阶段的一致性与连贯性。</li>
<li><strong>车辆状态快照支持</strong>：部分实现中，车辆注册表还可缓存车辆的静态信息（如尺寸、类型）和部分动态状态，供控制器或外部模块使用。</li>
</ul>
<p>示例行为配置接口（伪代码）：</p>
<div class="highlight"><pre><span></span><code><span class="n">vehicle_registry</span><span class="p">.</span><span class="n">SetDesiredSpeed</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="mf">15.0f</span><span class="p">);</span><span class="w">      </span><span class="c1">// 设置目标速度</span>
<span class="n">vehicle_registry</span><span class="p">.</span><span class="n">EnableAutoLaneChange</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// 启用自动变道</span>
<span class="n">vehicle_registry</span><span class="p">.</span><span class="n">SetIgnoreLightsProbability</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">);</span><span class="w"> </span><span class="c1">// 设置30%的概率忽视红灯</span>
</code></pre></div>
<p>总之，车辆注册表在 TM 中扮演类似“车辆数据库”的角色，是连接外部控制逻辑与内部状态维护的桥梁，其设计直接影响 Traffic Manager 的效率与行为灵活性。</p>
<p><strong>模拟状态缓存（Simulation State Cache）</strong>：该模块是 Traffic Manager 各阶段之间共享交通参与者状态的核心机制。为了避免每个模块重复从 CARLA 世界读取状态信息，模拟状态缓存提供了一种轻量、线程安全、时间一致的状态存取方式。其主要作用包括：</p>
<ul>
<li><strong>状态快照机制</strong>：每帧开始时，ALSM 或状态采集模块会遍历所有车辆与行人，提取其位置、朝向、速度、交通灯状态等动态数据，并记录为快照。该快照在当前帧内固定不变，供各阶段模块读取。</li>
<li><strong>静态属性记录</strong>：除了动态状态，系统还会记录每个对象的类型（如车辆或行人）、边界尺寸等静态属性，用于后续阶段的行为建模与碰撞预测。</li>
<li><strong>物理仿真模式支持</strong>：缓存中记录了每个参与者是否启用了物理仿真（EnablePhysics 标记），该信息由 ALSM 根据混合物理模式判断决定，供运动控制或轨迹预测模块使用。</li>
<li><strong>交通灯状态缓存</strong>：车辆是否处于红灯控制、是否正在红灯前停车等状态也被同步缓存，避免重复查询 Vehicle API，提升性能。</li>
<li><strong>接口丰富</strong>：提供高效接口用于：</li>
<li>获取车辆当前位置、速度、朝向（<code>GetLocation()</code>、<code>GetVelocity()</code>、<code>GetTransform()</code>）</li>
<li>判断是否启用物理（<code>IsPhysicsEnabled()</code>）</li>
<li>更新/添加参与者状态（<code>UpdateKinematicState()</code>、<code>AddActor()</code>）</li>
<li>获取交通灯状态（<code>GetTLS()</code>）</li>
</ul>
<p>示例接口使用（伪代码）：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state_cache</span><span class="p">.</span><span class="n">ContainsActor</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_cache</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_cache</span><span class="p">.</span><span class="n">GetVelocity</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">state_cache</span><span class="p">.</span><span class="n">IsPhysicsEnabled</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 使用估算速度进行运动规划</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>总体而言，模拟状态缓存作为 TM 的“感知中枢”，为系统提供高一致性、高并发的状态访问支持，是实现高性能并行仿真的关键基础模块。</p>
<p><strong>控制循环（主调度器）</strong>：主调度器是 Traffic Manager 的核心执行引擎，它以固定频率驱动各阶段模块协同工作，完成每一帧的交通逻辑处理流程。调度器以流水线方式组织模块调用，确保数据流与控制流的时序一致性，并协调多线程处理过程，提升整体仿真效率。其主要职责包括：</p>
<ul>
<li><strong>阶段调度机制</strong>：主调度器以帧为单位执行控制流程，每帧包含一系列固定顺序的阶段模块（如定位、碰撞检测、交通灯判断、运动控制、车灯控制等）。每个阶段均在独立线程运行，通过 barrier 或任务队列机制统一调度。</li>
<li><strong>模块执行顺序保障</strong>：确保每个阶段开始前，其依赖的上游阶段已经完成。例如必须先完成定位模块，后续阶段才能获取车辆的路径信息。</li>
<li><strong>状态同步与传递</strong>：调度器负责在阶段之间传递必要的车辆状态与路径缓存数据，如 TrajectoryBuffer、KinematicState 等，保证数据流的完整性。</li>
<li><strong>异常处理与故障恢复</strong>：在任意阶段出现异常（如车辆数据缺失、路径断裂等）时，主调度器会根据设定策略降级处理或跳过当前帧，以保证仿真连续性与稳定性。</li>
<li><strong>性能统计与帧控制</strong>：记录每阶段的执行耗时用于性能监控，并根据同步模式（sync mode）或固定步长设定统一推进仿真时间步长（delta time）。</li>
</ul>
<p>示例调度流程（伪代码）：</p>
<p><div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">each</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ALSM</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span><span class="w">                 </span><span class="c1">// 更新参与者生命周期与状态缓存</span>
<span class="w">    </span><span class="n">LocalizationStage</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span><span class="w">      </span><span class="c1">// 定位模块执行</span>
<span class="w">    </span><span class="n">CollisionStage</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span><span class="w">         </span><span class="c1">// 碰撞检测</span>
<span class="w">    </span><span class="n">TrafficLightStage</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span><span class="w">      </span><span class="c1">// 交通灯判断</span>
<span class="w">    </span><span class="n">MotionPlannerStage</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span><span class="w">     </span><span class="c1">// 路径跟踪与运动规划</span>
<span class="w">    </span><span class="n">VehicleLightStage</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span><span class="w">      </span><span class="c1">// 根据规划设置灯光</span>
<span class="w">    </span><span class="n">ApplyControlCommands</span><span class="p">();</span><span class="w">       </span><span class="c1">// 汇总控制命令，应用至服务器</span>
<span class="p">}</span>
</code></pre></div>
控制循环作为 Traffic Manager 的主心骨，串联起整个行为决策链条，其效率与鲁棒性直接决定了多车自动驾驶仿真的实时性与稳定性。</p>
<p><strong>内存地图与网格路径（Local Map &amp; Waypoint Grid）</strong>：该模块负责将 CARLA 原始地图数据转化为高效结构化的拓扑图与稀疏导航路径点（Waypoints），用于支持定位、路径规划与避障等模块的快速查询与插值计算。它是构建交通规则感知与路径跟踪基础的核心组件之一，主要功能包括：</p>
<ul>
<li><strong>地图解析与拓扑构建</strong>：读取 CARLA 世界地图并转换为图结构，节点表示车道中的关键位置，边表示车道的连接关系，形成有向图用于路径搜索与行为建模。</li>
<li><strong>路点稀疏采样与数据封装</strong>：使用固定间隔（例如 1 米）采样方式在道路中心线生成稀疏路点（SimpleWaypoint），每个路点对象包含：</li>
<li>三维位置与朝向（Transform）</li>
<li>所属车道与道路 ID</li>
<li>限速、车道宽度、导航标签（如是否为交叉口、是否可变道）</li>
<li>前向/后向邻接路点、相邻车道路点（左右变道）</li>
<li><strong>导航路径构建与裁剪</strong>：支持基于全局导航目标生成主路径（Global Route Plan）与局部路径（Local Trajectory），并根据车辆实时状态动态裁剪前向 N 秒或 N 米的路径段用于控制模块跟踪。</li>
<li><strong>交通语义融合</strong>：为路点附加交通灯、停车线、优先级等规则信息，在进行红灯判定、停车控制时使用，提升交通规则遵从性。</li>
<li><strong>变道与交叉口支持</strong>：</li>
<li>查询当前路点是否为交叉口 <code>CheckJunction()</code></li>
<li>判断左右车道是否存在 <code>GetLeftLane()</code>, <code>GetRightLane()</code></li>
<li>检查是否允许变道 <code>IsLaneChangeAllowed()</code></li>
<li><strong>效率与线程安全设计</strong>：路点以索引方式管理，支持高效空间查找（基于坐标 KD-Tree 或哈希表），同时接口可在多线程中并发调用，支持定位、轨迹生成和控制模块同时访问。</li>
</ul>
<p>示例调用逻辑（伪代码）：</p>
<div class="highlight"><pre><span></span><code><span class="n">SimpleWaypointPtr</span><span class="w"> </span><span class="n">current_wp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_map</span><span class="o">-&gt;</span><span class="n">GetWaypoint</span><span class="p">(</span><span class="n">vehicle_location</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SimpleWaypointPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">forward_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_wp</span><span class="o">-&gt;</span><span class="n">GetNextWaypointN</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">wp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">forward_path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">HasTrafficLight</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">light_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">GetBoundTrafficLight</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetState</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">light_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Red</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 触发停车或减速逻辑</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>路径缓存与车辆轨迹（PBVT, Path Buffer &amp; Vehicle Trajectory）</strong>：PBVT 是 Traffic Manager 中用于记录与更新每辆车未来运动轨迹的关键模块。它通过对局部路径的持续预测与缓存，为运动规划和避障模块提供决策支撑，确保系统在复杂场景中具备前瞻性和响应性。其主要功能包括：</p>
<ul>
<li><strong>轨迹缓冲区构建</strong>：为每辆车维护一个轨迹缓冲队列（Trajectory Buffer），该队列包含从当前位置出发、沿参考路径前向若干米或若干秒的路径点，通常为 2-4 秒时域。</li>
<li><strong>基于路点的路径预测</strong>：轨迹点通常来源于内存地图生成的稀疏网格路点（Waypoints），并结合当前速度和加速度动态裁剪路径长度。</li>
<li><strong>缓冲更新策略</strong>：</li>
<li>在车辆进入新位置或帧推进后，检测是否需要重建轨迹缓冲区。</li>
<li>如果路径偏差或交通规则变化（如交通灯、障碍物出现）导致路径失效，则触发轨迹重规划。</li>
<li><strong>轨迹点结构</strong>：每个轨迹点不仅包含位置坐标，还记录目标速度、限速信息、变道指令、是否避障等高阶信息，供运动控制模块直接使用。</li>
<li><strong>状态预判与多阶段使用</strong>：</li>
<li>碰撞检测阶段使用路径中的前向点进行障碍预测。</li>
<li>运动控制阶段基于轨迹点生成 PID 控制输入。</li>
<li>车灯控制模块判断是否需转向灯激活。</li>
<li><strong>线程安全实现</strong>：PBVT 模块支持并发访问，不同阶段可读取对应车辆的路径缓冲，同时支持局部重建。</li>
</ul>
<p>示例调用逻辑（伪代码）：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">trajectory_buffer</span><span class="p">.</span><span class="n">HasEnoughWaypoints</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">new_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">planner</span><span class="p">.</span><span class="n">GeneratePathFromWaypoint</span><span class="p">(</span><span class="n">current_wp</span><span class="p">);</span>
<span class="w">    </span><span class="n">trajectory_buffer</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span><span class="w"> </span><span class="n">new_path</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">auto</span><span class="w"> </span><span class="n">next_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trajectory_buffer</span><span class="p">.</span><span class="n">GetNextTarget</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">);</span>
<span class="n">motion_controller</span><span class="p">.</span><span class="n">Track</span><span class="p">(</span><span class="n">next_target</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><strong>PID 控制器</strong>：每辆车都通过其 PID 控制器根据期望路径点计算出实际控制命令（油门、刹车和方向盘），以最小化当前运动状态与路径目标之间的误差。</li>
<li><strong>命令数组控制器</strong>：在控制阶段结束后，所有车辆的控制指令被批量组织为一个控制命令数组，通过高效通道（如 client.apply_batch()）发送到 CARLA 服务器，实现高帧率控制。</li>
</ul>
<h2 id="_2">控制循环的阶段</h2>
<ol>
<li>
<p><strong>定位阶段</strong>：根据每辆车当前的位置信息，查找其前方预定路径上的一组路点（Waypoints）。路径长度根据车速动态调整，确保路径点能够覆盖车辆数秒钟内的预期移动范围。该阶段还会处理路径重建请求，以适应新注册车辆或突发路径变更。</p>
</li>
<li>
<p><strong>碰撞检测阶段</strong>：分析当前路径点与其他动态对象（车辆、行人）的可能交叉情况，构建临时的局部避障图。若检测到潜在碰撞，会在车辆控制中插入速度限制、停车或绕行建议。</p>
</li>
<li>
<p><strong>交通灯阶段</strong>：识别路径中出现的红绿灯、停车标志、优先通行规则等信息。此阶段依据道路拓扑结构判断当前车道是否被交通信号所控制，并根据灯色状态决定是否停车或等待。</p>
</li>
<li>
<p><strong>运动规划阶段</strong>：使用 PID 控制器将车辆当前位置与路径点之间的差值转化为控制命令（油门、刹车、方向盘）。控制器不断调整以最小化路径误差，同时结合速度限制和行为参数（如期望速度、是否变道）进行动态调整。</p>
</li>
<li>
<p><strong>车灯控制阶段</strong>：根据运动规划的结果（如是否刹车、转向）设置车辆灯光状态。例如：当车辆计划左转时，激活左转向灯；减速时激活刹车灯；在夜间或低光照区域自动打开前照灯等。</p>
</li>
</ol>
<h2 id="traffic-manager_2">使用 Traffic Manager</h2>
<h3 id="_3">创建和配置</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">carla</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_world</span><span class="p">()</span>

<span class="c1"># 设置同步模式</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
<span class="n">settings</span><span class="o">.</span><span class="n">synchronous_mode</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">settings</span><span class="o">.</span><span class="n">fixed_delta_seconds</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">world</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

<span class="c1"># 获取 Traffic Manager 实例</span>
<span class="n">traffic_manager</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_trafficmanager</span><span class="p">()</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_synchronous_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="_4">控制车辆行为</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取车辆蓝图</span>
<span class="n">blueprint_library</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_blueprint_library</span><span class="p">()</span>
<span class="n">vehicle_bp</span> <span class="o">=</span> <span class="n">blueprint_library</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;vehicle.*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 获取地图上的生成点</span>
<span class="n">spawn_points</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_spawn_points</span><span class="p">()</span>

<span class="c1"># 生成车辆</span>
<span class="n">vehicle</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">spawn_actor</span><span class="p">(</span><span class="n">vehicle_bp</span><span class="p">,</span> <span class="n">spawn_points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># 启用自动驾驶</span>
<span class="n">vehicle</span><span class="o">.</span><span class="n">set_autopilot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 设置车辆行为参数</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">ignore_lights_percentage</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)</span>  <span class="c1"># 30% 的概率忽略红灯</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_desired_speed</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>         <span class="c1"># 设置期望速度为 20 m/s</span>
</code></pre></div>
<h2 id="_5">高级功能</h2>
<ul>
<li><strong>确定性模式</strong>：通过设置随机种子，确保每次模拟结果一致，便于测试和验证。</li>
<li><strong>混合物理模式</strong>：在车辆远离 Ego 车辆时，使用简化的物理模型，提高模拟效率。</li>
<li><strong>多 Traffic Manager 实例</strong>：支持在同一模拟中运行多个 TM 实例，分别控制不同的车辆组。</li>
<li><strong>同步模式</strong>：确保所有车辆在每个模拟步长中同步更新，适用于需要严格时间控制的场景。</li>
</ul>
<h2 id="_6">总结</h2>
<p>Traffic Manager 是 CARLA 模拟器中强大的工具，提供了对自动驾驶车辆行为的全面控制。通过合理配置 TM，可以模拟各种复杂的交通场景，满足自动驾驶系统的训练和测试需求。</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
