<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CarlaUnreal 插件 Actor 模块说明文档 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CarlaUnreal \u63d2\u4ef6 Actor \u6a21\u5757\u8bf4\u660e\u6587\u6863";
        var mkdocs_page_input_path = "modules/Actor.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">CarlaUnreal 插件 Actor 模块说明文档</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/Actor.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="carlaunreal-actor">CarlaUnreal 插件 Actor 模块说明文档</h1>
<h1 id="_1">目录</h1>
<ul>
<li><a href="#概述">概述</a></li>
<li><a href="#核心类与功能">核心类与功能</a></li>
<li><a href="#1-factordata">1. FActorData</a><ul>
<li><a href="#主要功能">主要功能</a></li>
<li><a href="#关键方法">关键方法</a></li>
<li><a href="#派生类">派生类</a></li>
</ul>
</li>
<li><a href="#2-uactordispatcher">2. UActorDispatcher</a><ul>
<li><a href="#主要功能-1">主要功能</a></li>
<li><a href="#关键方法-1">关键方法</a></li>
</ul>
</li>
<li><a href="#3-factorregistry">3. FActorRegistry</a><ul>
<li><a href="#主要功能-2">主要功能</a></li>
<li><a href="#关键方法-2">关键方法</a></li>
</ul>
</li>
<li><a href="#代码结构与实现细节">代码结构与实现细节</a></li>
<li><a href="#数据记录与恢复">数据记录与恢复</a></li>
<li><a href="#actor-生成与管理">Actor 生成与管理</a></li>
<li><a href="#ros2-集成">ROS2 集成</a></li>
<li><a href="#错误处理">错误处理</a></li>
<li><a href="#使用场景">使用场景</a></li>
<li><a href="#仿真场景初始化">仿真场景初始化</a></li>
<li><a href="#状态保存与恢复">状态保存与恢复</a></li>
<li><a href="#动态管理">动态管理</a></li>
<li><a href="#传感器与数据流">传感器与数据流</a></li>
<li><a href="#交通模拟">交通模拟</a></li>
<li><a href="#注意事项">注意事项</a></li>
<li><a href="#物理模拟">物理模拟</a></li>
<li><a href="#id-管理">ID 管理</a></li>
<li><a href="#ros2-集成-1">ROS2 集成</a></li>
<li><a href="#边界框与标签">边界框与标签</a></li>
<li><a href="#未实现功能">未实现功能</a></li>
</ul>
<h2 id="_2">概述</h2>
<p>CarlaUnreal 插件中的 Actor 模块是 CARLA 模拟器中用于管理和操作参与者（Actor）的重要组件。参与者包括车辆、行人、交通信号灯、交通标志和传感器等，用于模拟真实的交通场景和环境交互。该模块提供了 Actor 的生成、注册、数据记录与恢复、状态管理（如休眠与唤醒）以及销毁等功能，广泛应用于 CARLA 的仿真逻辑中。</p>
<p>本模块基于 Unreal Engine 的 Actor 系统，结合 CARLA 的自定义逻辑，实现了对不同类型参与者的统一管理和高效操作。以下文档详细介绍了模块中的核心类、功能以及代码实现的关键点。</p>
<hr />
<h2 id="_3">核心类与功能</h2>
<h3 id="1-factordata">1. FActorData</h3>
<p><code>FActorData</code> 是 Actor 模块的基础数据类，用于记录 <strong>记录</strong>和<strong>恢复</strong>通用 Actor 的状态数据（如位置、旋转、速度等）。它是其他特定类型数据类的基类（如车辆、行人等）。</p>
<h4 id="_4">主要功能</h4>
<ul>
<li><strong>记录数据</strong>：记录 Actor 的位置、旋转、缩放、速度、角速度和物理模拟状态。</li>
<li><strong>恢复数据</strong>：根据记录的数据恢复 Actor 的状态。</li>
<li><strong>重生 Actor</strong>：根据存储的变换信息重新生成 Actor。</li>
<li><strong>获取局部变换</strong>：计算相对于当前地图原点的变换。</li>
</ul>
<h4 id="_5">关键方法</h4>
<ul>
<li><code>AActor* RespawnActor(UCarlaEpisode* CarlaEpisode, const FActorInfo&amp; Info)</code><br />
  重生一个 Actor，使用存储的变换信息并向上偏移 15 个单位以避免碰撞。</li>
<li><code>void RecordActorData(FCarlaActor* CarlaActor, UCarlaEpisode* CarlaEpisode)</code><br />
  记录 Actor 的位置、旋转、缩放、速度、角速度和物理状态。</li>
<li><code>void RestoreActorData(FCarlaActor* CarlaActor, UCarlaEpisode* CarlaEpisode)</code><br />
  恢复 Actor 的变换、速度、角速度和物理状态，针对车辆和行人进行特殊处理。</li>
<li><code>FTransform GetLocalTransform(UCarlaEpisode* CarlaEpisode) const</code><br />
  计算相对于当前地图原点的局部变换。</li>
</ul>
<h4 id="_6">派生类</h4>
<ul>
<li><strong>FVehicleData</strong>：扩展了 <code>FActorData</code>，用于记录和恢复车辆特定的数据，如物理控制、灯光状态和速度限制。</li>
<li><strong>FWalkerData</strong>：扩展了 <code>FActorData</code>，用于记录和恢复行人特定的控制数据和存活状态。</li>
<li><strong>FTrafficSignData</strong>：扩展了 <code>FActorData</code>，用于记录和恢复交通标志的模型和标识信息。</li>
<li><strong>FTrafficLightData</strong>：扩展了 <code>FActorData</code>，用于记录和恢复交通信号灯的状态和控制器信息。</li>
<li><strong>FActorSensorData</strong>：扩展了 <code>FActorData</code>，用于记录和恢复传感器的数据流。</li>
</ul>
<hr />
<h3 id="2-uactordispatcher">2. UActorDispatcher</h3>
<p><code>UActorDispatcher</code> 是 Actor 模块的核心调度类，负责 <strong>生成</strong>、<strong>注册</strong>、<strong>销毁</strong>和<strong>状态管理</strong>（休眠/唤醒）Actor。它通过绑定 Actor 定义和生成函数，管理 Actor 的生命周期。</p>
<h4 id="_7">主要功能</h4>
<ul>
<li><strong>绑定 Actor 定义</strong>：将 Actor 定义与生成函数关联，分配唯一 ID。</li>
<li><strong>生成 Actor</strong>：根据描述和变换生成 Actor，并注册到系统中。</li>
<li><strong>销毁 Actor</strong>：移除 Actor 及其控制器，清理注册信息。</li>
<li><strong>状态管理</strong>：将 Actor 设置为休眠或唤醒状态。</li>
<li><strong>ROS2 集成</strong>：支持将 Actor 注册到 ROS2 系统中，处理名称映射和回调。</li>
</ul>
<h4 id="_8">关键方法</h4>
<ul>
<li><code>void Bind(FActorDefinition Definition, SpawnFunctionType Functor)</code><br />
  绑定 Actor 定义和生成函数，分配唯一 ID。</li>
<li><code>void Bind(ACarlaActorFactory &amp;ActorFactory)</code><br />
  绑定 Actor 工厂中的所有定义。</li>
<li><code>TPair&lt;EActorSpawnResultStatus, FCarlaActor*&gt; SpawnActor(const FTransform &amp;Transform, FActorDescription Description, FCarlaActor::IdType DesiredId)</code><br />
  生成 Actor 并注册，返回生成状态和 Actor 指针。</li>
<li><code>AActor* ReSpawnActor(const FTransform &amp;Transform, FActorDescription Description)</code><br />
  重新生成 Actor，不进行注册。</li>
<li><code>bool DestroyActor(FCarlaActor::IdType ActorId)</code><br />
  销毁指定 ID 的 Actor 及其控制器。</li>
<li><code>FCarlaActor* RegisterActor(AActor &amp;Actor, FActorDescription Description, FActorRegistry::IdType DesiredId)</code><br />
  注册 Actor，绑定到指定 ID，并支持 ROS2 集成。</li>
<li><code>void PutActorToSleep(FCarlaActor::IdType Id, UCarlaEpisode* CarlaEpisode)</code><br />
  将 Actor 及其子 Actor 设置为休眠状态。</li>
<li><code>void WakeActorUp(FCarlaActor::IdType Id, UCarlaEpisode* CarlaEpisode)</code><br />
  唤醒指定 ID 的 Actor。</li>
<li><code>void OnActorDestroyed(AActor *Actor)</code><br />
  处理 Actor 销毁事件，清理注册和 ROS2 映射。</li>
</ul>
<hr />
<h3 id="3-factorregistry">3. FActorRegistry</h3>
<p><code>FActorRegistry</code> 是 Actor 模块的注册管理类，负责 <strong>注册</strong>、<strong>注销</strong>和<strong>查找</strong> Actor。它维护 Actor 的唯一 ID 和状态信息，确保数据一致性。</p>
<h4 id="_9">主要功能</h4>
<ul>
<li><strong>注册 Actor</strong>：为 Actor 分配唯一 ID，存储其信息并关联到系统中。</li>
<li><strong>注销 Actor</strong>：移除 Actor 的注册信息，清理映射。</li>
<li><strong>查找 Actor</strong>：根据 ID 或 Actor 指针查找注册的 Actor。</li>
<li><strong>状态管理</strong>：支持 Actor 的休眠和唤醒操作。</li>
<li><strong>类型判断</strong>：根据 Actor 类型返回对应的枚举值（车辆、行人、传感器等）。</li>
</ul>
<h4 id="_10">关键方法</h4>
<ul>
<li><code>FCarlaActor* Register(AActor &amp;Actor, FActorDescription Description, IdType DesiredId)</code><br />
  注册 Actor，分配或复用 ID，存储描述和状态信息。</li>
<li><code>void Deregister(IdType Id)</code><br />
  注销指定 ID 的 Actor，清理映射。</li>
<li><code>void Deregister(AActor *Actor)</code><br />
  根据 Actor 指针注销 Actor。</li>
<li><code>TSharedPtr&lt;FCarlaActor&gt; MakeCarlaActor(IdType Id, AActor &amp;Actor, FActorDescription Description, crp::ActorState InState)</code><br />
  创建 <code>FCarlaActor</code> 对象，初始化描述、标签和边界框。</li>
<li><code>void PutActorToSleep(FCarlaActor::IdType Id, UCarlaEpisode* CarlaEpisode)</code><br />
  将 Actor 及其子 Actor 设置为休眠状态，移除活跃映射。</li>
<li><code>FCarlaActor* FindCarlaActor(IdType Id)</code><br />
  根据 ID 查找注册的 Actor。</li>
<li><code>static FCarlaActor::ActorType GetActorType(const AActor *Actor)</code><br />
  判断 Actor 类型（车辆、行人、交通信号灯等）。</li>
</ul>
<hr />
<h2 id="_11">代码结构与实现细节</h2>
<h3 id="_12">数据记录与恢复</h3>
<ul>
<li><strong>通用数据</strong>：<code>FActorData</code> 及其派生类记录 Actor 的位置、旋转、速度等基本信息，确保状态一致性。</li>
<li><strong>特定数据</strong>：针对车辆（<code>FVehicleData</code>）、行人（<code>FWalkerData</code>）等类型，记录特定控制数据（如车辆灯光、行人控制）。</li>
<li><strong>恢复逻辑</strong>：恢复时根据 Actor 类型（如车辆、传感器）应用不同逻辑，确保物理状态和控制参数正确。</li>
</ul>
<h3 id="actor">Actor 生成与管理</h3>
<ul>
<li><strong>生成流程</strong>：<code>UActorDispatcher</code> 通过绑定的生成函数生成 Actor，并通过 <code>FActorRegistry</code> 注册到系统中。</li>
<li><strong>ID 分配</strong>：<code>FActorRegistry</code> 使用全局计数器 <code>ID_COUNTER</code> 分配唯一 ID，支持用户指定 ID。</li>
<li><strong>状态管理</strong>：休眠状态通过移除活跃映射实现，唤醒时重新注册 Actor。</li>
</ul>
<h3 id="ros2">ROS2 集成</h3>
<ul>
<li><strong>名称映射</strong>：Actor 注册时支持 ROS2 名称映射，处理车辆和非车辆的命名规则。</li>
<li><strong>回调支持</strong>：为特定角色（如 <code>hero</code> 或 <code>ego</code>）添加 ROS2 回调，处理实时数据交互。</li>
</ul>
<h3 id="_13">错误处理</h3>
<ul>
<li><strong>日志记录</strong>：使用 Unreal Engine 的日志系统（<code>UE_LOG</code>）记录生成、销毁和注册中的错误。</li>
<li><strong>状态检查</strong>：生成和注册过程中对 Actor 描述和 ID 进行验证，确保数据有效性。</li>
</ul>
<hr />
<h2 id="_14">使用场景</h2>
<ol>
<li><strong>仿真场景初始化</strong>：</li>
<li>使用 <code>UActorDispatcher::SpawnActor</code> 生成车辆、行人等 Actor，设置初始位置和状态，进行场景初始化。</li>
<li>通过 <code>FActorRegistry::Register</code> 注册 Actor，分配唯一 ID。</li>
<li><strong>状态保存与恢复</strong>：</li>
<li>使用 <code>FActorData::RecordActorData</code> 保存 Actor 状态。</li>
<li>使用 <code>FActorData::RestoreActorData</code> 恢复 Actor 状态，用于场景重置或回放。</li>
<li><strong>动态管理</strong>：</li>
<li>使用 <code>UActorDispatcher::PutActorToSleep</code> 和 <code>WakeActorUp</code> 动态管理 Actor 的活跃状态，优化性能。</li>
<li>使用 <code>UActorDispatcher::DestroyActor</code> 清理不再需要的 Actor。</li>
<li><strong>传感器与数据流</strong>：</li>
<li>使用 <code>FActorSensorData</code> 管理传感器数据流，支持实时数据传输和处理。</li>
<li><strong>交通模拟</strong>：</li>
<li>使用 <code>FTrafficLightData</code> 和 <code>FTrafficSignData</code> 管理交通信号灯和标志的状态，模拟真实交通规则。</li>
</ol>
<hr />
<h2 id="_15">注意事项</h2>
<ol>
<li><strong>物理模拟</strong>：</li>
<li>车辆和行人的物理模拟状态通过 <code>bSimulatePhysics</code> 控制，需确保正确设置以避免仿真异常。</li>
<li>恢复物理状态时，需针对不同 Actor 类型（如车辆、行人）应用特定逻辑。</li>
<li><strong>ID 管理</strong>：</li>
<li>确保 Actor ID 的唯一性，避免重复注册或冲突。</li>
<li>使用 <code>DesiredId</code> 时，需验证其未被占用。</li>
<li><strong>ROS2 集成</strong>：</li>
<li>启用 ROS2 时，需确保正确配置名称映射和回调，避免命名冲突或数据丢失。</li>
<li><strong>边界框与标签</strong>：</li>
<li>边界框通过 <code>UBoundingBoxCalculator</code> 计算，需确保 Actor 的几何信息正确。</li>
<li>语义标签通过 <code>ATagger</code> 获取，需避免无效标签（如 <code>None</code> 或 <code>Other</code>）。</li>
<li><strong>未实现功能</strong>：</li>
<li>部分代码（如行人死亡计时器）标记为 <code>TODO</code>，需后续完善。</li>
<li>子 Actor 的休眠逻辑可能需要进一步优化。</li>
</ol>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
