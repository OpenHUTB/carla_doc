<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>灯光模块(Lights)说明文档 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u706f\u5149\u6a21\u5757(Lights)\u8bf4\u660e\u6587\u6863";
        var mkdocs_page_input_path = "modules/Lights.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">灯光模块(Lights)说明文档</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/Lights.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lights">灯光模块(Lights)说明文档</h1>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#1-模块概述"><strong>1. 模块概述</strong></a><ul>
<li><a href="#11-UCarlaLightSubsystem介绍">1.1 UCarlaLightSubsystem介绍</a><ul>
<li><a href="#111-主要功能">1.1.1 主要功能</a></li>
</ul>
</li>
<li><a href="#12-ucarlalight介绍">1.2 UCarlaLight介绍</a><ul>
<li><a href="#121-主要功能">1.2.1 主要功能</a></li>
<li><a href="#122-组件核心功能">1.2.2 组件核心功能</a></li>
</ul>
</li>
<li><a href="#13-灯光模块">1.3 灯光模块</a></li>
</ul>
</li>
<li><a href="#2-模块关系总览"><strong>2. 模块关系总览</strong></a><ul>
<li><a href="#21-灯光模块(Light)与其他模块关系总览">2.1 灯光模块(Light)与其他模块关系总览</a></li>
<li><a href="#22-模块控制关系">2.2 模块控制关系</a><ul>
<li><a href="#221-交通信号控制流程">2.2.1 交通信号控制流程</a></li>
<li><a href="#222-天气影响灯光">2.2.2 天气影响灯光</a></li>
</ul>
</li>
<li><a href="#33-场景示例图">2.3 场景示例图</a></li>
</ul>
</li>
<li><a href="#3-技术实现"><strong>3. 技术实现</strong></a><ul>
<li><a href="#31-核心类函数">3.1 核心类函数</a></li>
<li><a href="#32-灯光注册与注销">3.2 灯光注册与注销</a></li>
<li><a href="#33-属性控制函数">3.3 属性控制函数</a></li>
<li><a href="#34-辅助功能">3.4 辅助功能</a></li>
</ul>
</li>
<li><a href="#4-关键成员变量"><strong>4. 关键成员变量</strong></a></li>
<li><a href="#5-使用场景"><strong>5. 使用场景</strong></a><ul>
<li><a href="#51-动态环境光照">5.1 动态环境光照</a></li>
<li><a href="#52-车辆信号灯同步">5.2 车辆信号灯同步</a></li>
<li><a href="#53-仿真事件回放">5.3 仿真事件回放</a></li>
</ul>
</li>
<li><a href="#6-注意事项"><strong>6. 注意事项</strong></a></li>
</ul>
<hr />
<h2 id="1">1. 模块概述 <a id="1-模块概述"></a></h2>
<h3 id="11-ucarlalightsubsystem">1.1 UCarlaLightSubsystem介绍 <a id="11-UCarlaLightSubsystem介绍"></a></h3>
<p><code>UCarlaLightSubsystem</code>是 carla 仿真平台中用于管理动态灯光的核心组件类，属于 carla 的虚幻引擎插件(CarlaUnreal)的一部分。这个子系统主要负责管理 carla 世界中的灯光（如交通灯、路灯等），并处理客户端与灯光状态的同步。<a href="https://openhutb.github.io/carla_cpp/d3/d13/CarlaLightSubsystem_8cpp_source.html">UCarlaLightSubsystem源代码</a></p>
<h4 id="111">1.1.1 主要功能 <a id="121-主要功能"></a></h4>
<ul>
<li><strong>灯光注册与注销</strong>：在模拟环境中，灯光（如交通灯、路灯等）是动态的资源。通过注册和注销机制，<code>UCarlaLightSubsystem</code>可以动态地管理这些灯光资源。当灯光被创建时，注册到子系统中，这样子系统就可以跟踪和管理它们；当灯光被销毁时，从子系统中注销，避免资源泄漏或无效引用。</li>
<li><strong>灯光状态同步</strong>：<code>GetLights</code> 和 <code>SetLights</code> 是实现这种双向通信的核心机制。它们确保了客户端能够获取最新的灯光信息，同时服务器可以动态调整灯光状态。</li>
<li><strong>日夜循环控制</strong>：通过控制昼夜变化，<code>CarlaLightSubsystem</code> 可以模拟真实世界中的光照条件，使自动驾驶系统能够在不同光照条件下进行测试和验证。</li>
<li><strong>脏标记机制</strong>：在多客户端的仿真环境中，频繁的同步操作可能会导致性能问题。通过脏标记机制，子系统可以记录哪些客户端需要更新，避免对所有客户端进行不必要的同步操作。</li>
</ul>
<h3 id="12-ucarlalight">1.2 UCarlaLight介绍 <a id="12-ucarlalight介绍"></a></h3>
<p><code>UCarlaLight</code>定义了一个 灯光组件，用于管理 carla 中的各类灯光（如交通灯、路灯等）。负责单个灯光的状态管理，并与 carla 的天气系统、RPC 通信、大型地图管理等模块交互。属于 carla 的虚幻引擎插件(CarlaUnreal)的一部分，为 carla 提供了高度可配置的、逼真的动态照明系统，是创建逼真昼夜循环和天气效果的关键组件。<a href="https://openhutb.github.io/carla_cpp/d9/d95/CarlaLight_8cpp_source.html">UCarlaLight源代码</a></p>
<h4 id="121">1.2.1 主要功能 <a id="121-主要功能"></a></h4>
<ul>
<li><strong>动态光照控制</strong>：实时调整光源强度、颜色和方向；支持昼夜循环的光照变化；天气相关光照效果（雨、雾、云等）。</li>
<li><strong>光源类型支持</strong>：定向光（模拟太阳/月亮）；点光源；聚光灯；天光（Skylight）。</li>
<li><strong>车辆专用灯光</strong>：车头灯、尾灯、刹车灯、转向灯；应急灯；车内照明。</li>
<li><strong>街道照明系统</strong>：路灯控制；交通信号灯；建筑外部照明。</li>
</ul>
<h4 id="122">1.2.2 组件核心功能 <a id="122-组件核心功能"></a></h4>
<p>在动态灯光组件中，核心功能包括：灯光属性控制、子系统集成、状态同步、事件记录。</p>
<ul>
<li><strong>灯光属性控制</strong>：动态调整灯光强度、颜色、开关状态及类型。</li>
<li><strong>子系统集成</strong>：与 <code>CarlaLightSubsystem</code> 交互实现全局灯光管理。</li>
<li><strong>状态同步</strong>：支持与 RPC 协议兼容的灯光状态序列化（<code>carla::rpc::LightState</code>）。</li>
<li><strong>事件记录</strong>：灯光状态变化时触发事件记录，支持仿真回放与调试。</li>
</ul>
<h3 id="13">1.3 灯光模块 <a id="13-灯光模块"></a></h3>
<p>灯光模块在 carla 中负责模拟现实世界中的各类光源（如交通灯、路灯、车辆灯等），并确保它们在虚拟环境中的行为符合物理规律和交通规则。
通过红绿灯管理车辆和行人的通行权；动态调整灯光颜色、强度以匹配昼夜或天气变化；为摄像头、激光雷达提供光照条件（如夜间低光、雨雾散射）；支持自动驾驶算法在不同终端获取一致的灯光状态。</p>
<h2 id="2">2. 模块控制关系<a id="2-模块控制关系"></a></h2>
<h3 id="21-light">2.1 灯光模块(Light)与其他模块关系总览<a id="21-灯光模块(Light)与其他模块关系总览"></a></h3>
<ul>
<li>展示灯光模块与其他核心模块的全局依赖关系，帮助 lights 在 carla 系统中的定位。快速了解模块间上下游关系，设计新功能时避免遗漏依赖。</li>
<li>核心枢纽：灯光模块直接控制交通信号，间接影响车辆、行人、传感器等模块。<blockquote>
<p><img alt="light model relationship" src="./img/Lights/light_model_relationship.png" /></p>
</blockquote>
</li>
</ul>
<h3 id="22">2.2 关键交互图<a id="22-关键交互图"></a></h3>
<h4 id="221">2.2.1 交通信号控制流程 <a id="221-交通信号控制流程"></a></h4>
<ul>
<li>描述信号灯状态变化时，系统如何协调车辆和行人的行为。例如，在测试场景中交通管理器强制设置红灯，灯光子系统通知所有车辆和行人，车辆触发刹车逻辑，行人停止移动。</li>
<li>应用场景：调试交通灯同步问题；验证自动驾驶算法对红灯的响应等。<blockquote>
<p><img alt="light model relationship" src="./img/Lights/light_model_relationship.png" /></p>
</blockquote>
</li>
<li>流程顺序：交通管理器 → 灯光模块 → 车辆/行人响应。</li>
</ul>
<h4 id="222">2.2.2 天气影响灯光 <a id="222-天气影响灯光"></a></h4>
<ul>
<li>展示天气变化如何通过灯光模块传递到自动驾驶系统。例如，天气系统发送暴雨事件；灯光模块降低路灯强度；传感器捕获低光照数据；自动驾驶 AI 决策降速。</li>
<li>应用场景：模拟极端天气下的传感器性能；测试车辆在低能见度下的行为。</li>
</ul>
<blockquote>
<p><img alt="light change" src="./img/lights/Light_change.png" /></p>
</blockquote>
<ul>
<li>数据流：天气事件 → 灯光强度调整 → 传感器数据 → 车辆控制。</li>
</ul>
<h3 id="23">2.3 场景示例图<a id="23-场景示例图"></a></h3>
<ul>
<li>场景：模拟暴雨天气下的交通系统响应。</li>
<li>天气系统触发能见度下降；交通管理器延长绿灯时间以缓解拥堵；传感器数据用于算法性能分析。<blockquote>
<p><img alt="data flow" src="./img/Lights/data_flow.png" /></p>
</blockquote>
</li>
</ul>
<h2 id="3">3. 技术实现<a id="3-技术实现"></a></h2>
<p><code>UCarlaLight</code>继承自虚幻引擎的 <code>ULightComponent</code> 类，并扩展了 carla 特有的功能。</p>
<h3 id="31">3.1 核心类函数<a id="31-核心类函数"></a></h3>
<p>继承自 <code>ULightComponent</code> 的类都必须通过这两个函数管理生命周期。批量处理入口 <code>BeginPlay()</code> 时合并提交所有灯光参数到渲染线程（减少每帧开销）。资源回收枢纽 <code>EndPlay()</code> 集中释放GPU资源（避免帧间卡顿）。
- <strong><code>BeginPlay()</code></strong>：替代构造函数（因UE禁止直接使用构造函数初始化游戏逻辑）。
- <strong><code>EndPlay()</code></strong>：替代析构函数（保证资源安全释放）。组件销毁时的资源清理函数，确保灯光从系统中安全移除。</p>
<h3 id="32">3.2 灯光注册与注销<a id="32-灯光注册与注销"></a></h3>
<h4 id="registerlight">RegisterLight()</h4>
<ul>
<li><strong>作用</strong>：将灯光注册到子系统和天气系统。</li>
<li><strong>关键逻辑</strong>：</li>
<li>通过 <code>GetWorld()-&gt;GetSubsystem&lt;UCarlaLightSubsystem&gt;()</code> 获取子系统实例。</li>
<li>调用 <code>CarlaLightSubsystem-&gt;RegisterLight(this)</code> 完成注册。</li>
<li>标记 <code>bRegistered = true</code> 防止重复注册。</li>
<li><strong>注销逻辑</strong>：在 <code>EndPlay()</code> 中调用 <code>CarlaLightSubsystem-&gt;UnregisterLight(this)</code>。</li>
</ul>
<h3 id="33">3.3 属性控制函数<a id="33-属性控制函数"></a></h3>
<table>
<thead>
<tr>
<th>函数名</th>
<th>参数</th>
<th>功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SetLightIntensity()</td>
<td><code>float Intensity</code></td>
<td>设置灯光强度并更新渲染效果。</td>
</tr>
<tr>
<td>SetLightColor()</td>
<td><code>FLinearColor Color</code></td>
<td>设置颜色并记录状态变化事件。</td>
</tr>
<tr>
<td>SetLightOn()</td>
<td><code>bool bOn</code></td>
<td>切换灯光开关状态并触发更新。</td>
</tr>
<tr>
<td>SetLightType()</td>
<td><code>ELightType Type</code></td>
<td>设置灯光类型（如车灯、路灯等）。</td>
</tr>
</tbody>
</table>
<h4 id="getlightstate-setlightstate">GetLightState() 与 SetLightState()</h4>
<ul>
<li><strong>作用</strong>：实现与 RPC 协议的状态双向同步。</li>
<li><strong>数据结构</strong>：
  <div class="highlight"><pre><span></span><code><span class="n">carla</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">LightState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">FVector</span><span class="w"> </span><span class="n">_location</span><span class="p">;</span><span class="w">      </span><span class="c1">// 世界坐标位置</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">_intensity</span><span class="p">;</span><span class="w">       </span><span class="c1">// 强度</span>
<span class="w">  </span><span class="n">LightGroup</span><span class="w"> </span><span class="n">_group</span><span class="p">;</span><span class="w">      </span><span class="c1">// 类型（枚举）</span>
<span class="w">  </span><span class="n">FLinearColor</span><span class="w"> </span><span class="n">_color</span><span class="p">;</span><span class="w">    </span><span class="c1">// 颜色</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">_active</span><span class="p">;</span><span class="w">           </span><span class="c1">// 是否开启</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">_id</span><span class="p">;</span><span class="w">                </span><span class="c1">// 唯一标识符</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<h3 id="34">3.4 辅助功能<a id="34-辅助功能"></a></h3>
<h4 id="getlocation">GetLocation()</h4>
<ul>
<li><strong>作用</strong>：获取灯光全局坐标（支持大型地图场景）。</li>
<li><strong>流程</strong>：</li>
<li>获取组件所属 Actor 的本地坐标。</li>
<li>通过 <code>ALargeMapManager</code> 将坐标转换为全局坐标系。</li>
</ul>
<h4 id="recordlightchange">RecordLightChange()</h4>
<ul>
<li><strong>作用</strong>：记录灯光状态变化事件（用于仿真回放）。</li>
<li><strong>触发条件</strong>：调用 <code>SetLightColor()</code> 或 <code>SetLightOn()</code>。</li>
<li><strong>依赖模块</strong>：通过 <code>UCarlaStatics::GetCurrentEpisode()</code> 获取记录器实例。</li>
</ul>
<h2 id="4">4. 关键成员变量<a id="4-关键成员变量"></a></h2>
<table>
<thead>
<tr>
<th>变量名</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>LightIntensity</td>
<td><code>float</code></td>
<td>当前灯光强度（默认值由引擎配置）</td>
</tr>
<tr>
<td>LightColor</td>
<td><code>FLinearColor</code></td>
<td>RGB 颜色值（线性空间）</td>
</tr>
<tr>
<td>bLightOn</td>
<td><code>bool</code></td>
<td>是否开启</td>
</tr>
<tr>
<td>LightType</td>
<td><code>ELightType</code></td>
<td>灯光分类（如车辆、环境光源等）</td>
</tr>
<tr>
<td>Id</td>
<td><code>int</code></td>
<td>唯一标识符（由子系统分配）</td>
</tr>
</tbody>
</table>
<h2 id="5">5. 使用场景<a id="5-使用场景"></a></h2>
<h3 id="51">5.1 动态环境光照<a id="51-动态环境光照"></a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 脚本控制路灯夜间自动开启</span>
<span class="n">LightComponent</span><span class="o">-&gt;</span><span class="n">SetLightOn</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="n">LightComponent</span><span class="o">-&gt;</span><span class="n">SetLightIntensity</span><span class="p">(</span><span class="mf">5000.0f</span><span class="p">);</span>
<span class="n">LightComponent</span><span class="o">-&gt;</span><span class="n">SetLightColor</span><span class="p">(</span><span class="n">FLinearColor</span><span class="p">(</span><span class="mf">0.9f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">));</span>
</code></pre></div>
<h3 id="52">5.2 车辆信号灯同步<a id="52-车辆信号灯同步"></a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 同步刹车灯状态到 RPC 协议</span>
<span class="n">carla</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">LightState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LightComponent</span><span class="o">-&gt;</span><span class="n">GetLightState</span><span class="p">();</span>
<span class="n">state</span><span class="p">.</span><span class="n">_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLinearColor</span><span class="o">::</span><span class="n">Red</span><span class="p">;</span>
<span class="n">state</span><span class="p">.</span><span class="n">_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bIsBraking</span><span class="p">;</span>
<span class="n">LightComponent</span><span class="o">-&gt;</span><span class="n">SetLightState</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</code></pre></div>
<h3 id="53">5.3 仿真事件回放<a id="53-仿真事件回放"></a></h3>
<p>在事件回放上通过调用 <code>RecordLightChange()</code> 记录状态变化时间点。</p>
<h2 id="6">6. 注意事项<a id="6-注意事项"></a></h2>
<ul>
<li><strong>子系统依赖</strong>：Actor 必须存在于已启用 <code>CarlaLightSubsystem</code> 的场景中。</li>
<li><strong>线程安全</strong>：避免在非游戏线程（如异步任务）中直接调用 <code>SetLightXxx</code> 函数。</li>
<li><strong>大型地图支持</strong>：使用 <code>GetLocation()</code> 而非直接获取 Actor 坐标以确保跨地图兼容性。</li>
</ul>
<hr />
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
