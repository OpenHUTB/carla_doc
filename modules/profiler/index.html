<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Profiler模块说明文档 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Profiler\u6a21\u5757\u8bf4\u660e\u6587\u6863";
        var mkdocs_page_input_path = "modules/profiler.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Profiler模块说明文档</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/profiler.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="profiler">Profiler模块说明文档</h1>
<h1 id="_1">目录</h1>
<ul>
<li><a href="#概述">概述</a></li>
<li><a href="#模块关系">模块关系</a></li>
<li><a href="#结构化设计">结构化设计</a></li>
<li><a href="#用户定制">用户定制</a></li>
<li><a href="#架构">架构</a></li>
<li><a href="#生命周期分析器">生命周期分析器</a><ul>
<li><a href="#生命周期分析器的内部结构">生命周期分析器的内部结构</a></li>
</ul>
</li>
<li><a href="#性能分析器">性能分析器</a><ul>
<li><a href="#性能分析器的内部结构">性能分析器的内部结构</a></li>
</ul>
</li>
<li><a href="#使用profiler">使用Profiler</a></li>
<li><a href="#生命周期分析器的使用">生命周期分析器的使用</a></li>
<li><a href="#性能分析器的使用">性能分析器的使用</a></li>
<li><a href="#性能分析示例">性能分析示例</a></li>
<li><a href="#性能数据输出">性能数据输出</a></li>
<li><a href="#性能优化建议">性能优化建议</a></li>
<li><a href="#profiler模块架构图">Profiler模块架构图</a></li>
<li><a href="#与其他模块的交互">与其他模块的交互</a></li>
<li><a href="#与python脚本的交互">与Python脚本的交互</a></li>
<li><a href="#与carla库的交互">与Carla库的交互</a></li>
<li><a href="#与虚幻插件的交互">与虚幻插件的交互</a></li>
<li><a href="#注意事项">注意事项</a></li>
</ul>
<h2 id="_2">概述</h2>
<p>Profiler模块是一个用于性能分析的工具，它可以帮助开发者了解代码的运行性能，包括对象的生命周期和性能数据的记录。该模块由两个主要部分组成：生命周期分析器（LifetimeProfiler）和性能分析器（Profiler）。通过使用Profiler模块，开发者可以轻松地监测和优化代码的性能。</p>
<h2 id="_3">模块关系</h2>
<p>Profiler模块位于LibCarla库中，与Python脚本、Carla库、虚幻插件等模块紧密相关。它通过Boost.Python与Python脚本交互，通过LibCarla客户端与服务器端通信，从而在整个项目中发挥性能分析的作用。</p>
<h2 id="_4">结构化设计</h2>
<p>Profiler模块的设计基于Carla的性能分析需求，提供了两种主要的分析功能：对象生命周期分析和性能数据记录。生命周期分析器用于跟踪对象的创建和销毁，而性能分析器则用于记录和输出性能数据，如执行时间、FPS等。</p>
<h2 id="_5">用户定制</h2>
<p>用户可以通过定义宏<code>LIBCARLA_ENABLE_PROFILER</code>和<code>LIBCARLA_ENABLE_LIFETIME_PROFILER</code>来控制是否启用性能分析功能。此外，用户还可以通过宏<code>LIBCARLA_INITIALIZE_LIFETIME_PROFILER</code>和<code>CARLA_PROFILE_SCOPE</code>、<code>CARLA_PROFILE_FPS</code>来方便地初始化和使用性能分析工具。</p>
<h2 id="_6">架构</h2>
<h3 id="_7">生命周期分析器</h3>
<p>生命周期分析器由<code>LifetimeProfiler</code>类和<code>LifetimeProfiled</code>类组成。<code>LifetimeProfiler</code>类负责注册和注销对象，并记录对象的生命周期信息。<code>LifetimeProfiled</code>类是一个基类，用于在对象的构造和析构时自动注册和注销对象。</p>
<h4 id="_8">生命周期分析器的内部结构</h4>
<ul>
<li><strong>LifetimeProfiler类</strong>：管理对象的注册和注销，记录未析构对象的信息。</li>
<li><strong>LifetimeProfiled类</strong>：在构造和析构时调用<code>LifetimeProfiler</code>的方法，实现对象的自动注册和注销。</li>
</ul>
<h3 id="_9">性能分析器</h3>
<p>性能分析器由<code>StaticProfiler</code>类、<code>ProfilerData</code>类和<code>ScopedProfiler</code>类组成。<code>StaticProfiler</code>类负责将性能数据写入文件，<code>ProfilerData</code>类用于存储和计算性能数据，<code>ScopedProfiler</code>类则用于在代码块的作用域内自动记录性能数据。</p>
<h4 id="_10">性能分析器的内部结构</h4>
<ul>
<li><strong>StaticProfiler类</strong>：管理性能数据的文件输出，提供写入CSV格式数据的方法。</li>
<li><strong>ProfilerData类</strong>：存储性能数据，包括名称、是否打印FPS、调用次数、总时间、最大时间和最小时间。</li>
<li><strong>ScopedProfiler类</strong>：在构造时启动计时器，在析构时停止计时器并更新性能数据。</li>
</ul>
<h2 id="profiler_1">使用Profiler</h2>
<h3 id="_11">生命周期分析器的使用</h3>
<p>要使用生命周期分析器，只需在类中继承<code>LifetimeProfiled</code>类，并在构造函数中调用<code>LIBCARLA_INITIALIZE_LIFETIME_PROFILER</code>宏。例如：
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyObject</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">carla</span><span class="o">::</span><span class="n">profiler</span><span class="o">::</span><span class="n">LifetimeProfiled</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">MyObject</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LifetimeProfiled</span><span class="p">(</span><span class="s">&quot;MyObject&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div></p>
<h3 id="_12">性能分析器的使用</h3>
<p>性能分析器可以通过<code>CARLA_PROFILE_SCOPE</code>和<code>CARLA_PROFILE_FPS</code>宏来使用。<code>CARLA_PROFILE_SCOPE</code>用于记录代码块的执行时间，<code>CARLA_PROFILE_FPS</code>用于记录帧率信息。例如：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">MyFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CARLA_PROFILE_SCOPE</span><span class="p">(</span><span class="s">&quot;MyFunction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;profiler_name&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_13">性能分析示例</h2>
<p>以下是一个使用Profiler模块进行性能分析的示例代码：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;carla/profiler/LifetimeProfiled.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;carla/profiler/Profiler.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyObject</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">carla</span><span class="o">::</span><span class="n">profiler</span><span class="o">::</span><span class="n">LifetimeProfiled</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">MyObject</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LifetimeProfiled</span><span class="p">(</span><span class="s">&quot;MyObject&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">DoWork</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CARLA_PROFILE_SCOPE</span><span class="p">(</span><span class="s">&quot;DoWork&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;profiler_name&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 执行一些工作</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MyObject</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<span class="w">    </span><span class="n">obj</span><span class="p">.</span><span class="n">DoWork</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_14">性能数据输出</h2>
<p>性能数据将被输出到指定的CSV文件中，格式如下：</p>
<div class="highlight"><pre><span></span><code># LibCarla Profiler 0.9.13 (debug)
# context, average, maximum, minimum, units, times
MyFunction, 1.23, 2.34, 0.56, ms, 100
DoWork, 0.78, 1.23, 0.34, ms, 200
</code></pre></div>
<h2 id="_15">性能优化建议</h2>
<ul>
<li><strong>减少不必要的对象创建和销毁</strong>：通过重用对象或使用对象池来减少生命周期分析器的负担。</li>
<li><strong>优化热点函数</strong>：使用性能分析器识别耗时较长的函数，并进行优化。</li>
<li><strong>调整性能分析器的采样频率</strong>：根据需要调整性能分析器的采样频率，以平衡性能开销和数据精度。</li>
</ul>
<h2 id="profiler_2">Profiler模块架构图</h2>
<pre class="mermaid"><code>graph TD
    A[Carla] --&gt; B[profiler]
    B --&gt; C[LifetimeProfiler]
    B --&gt; D[StaticProfiler]
    C --&gt; E[LifetimeProfiled]
    D --&gt; F[ProfilerData]
    D --&gt; G[ScopedProfiler]
    F --&gt; H[StopWatch]
    G --&gt; H</code></pre>
<h2 id="_16">与其他模块的交互</h2>
<h3 id="python">与Python脚本的交互</h3>
<p>Profiler模块通过Boost.Python与Python脚本交互，使得Python脚本能够调用C++中的性能分析功能。例如，Python脚本可以通过导入Carla库来使用Profiler模块：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">carla</span>

<span class="k">def</span> <span class="nf">my_function</span><span class="p">():</span>
    <span class="c1"># 使用Profiler模块进行性能分析</span>
    <span class="k">pass</span>
</code></pre></div>
<h3 id="carla">与Carla库的交互</h3>
<p>Profiler模块与Carla库紧密集成，为Carla库中的各类功能提供性能分析支持。例如，在使用Carla的交通管理器（Traffic Manager）时，可以利用Profiler模块来分析其性能：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;carla/trafficmanager/TrafficManager.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;carla/profiler/Profiler.h&quot;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">analyze_traffic_manager_performance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CARLA_PROFILE_SCOPE</span><span class="p">(</span><span class="s">&quot;TrafficManager&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;performance&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 调用Traffic Manager的相关功能</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_17">与虚幻插件的交互</h3>
<p>Profiler模块通过LibCarla客户端与虚幻插件（CarlaUnreal）进行通信，从而在整个项目中实现性能分析。例如，在虚幻插件中可以调用Profiler模块来分析游戏的性能：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Carla/Game/CarlaEngine.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;carla/profiler/Profiler.h&quot;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">UCarlaEngine::AnalyzePerformance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CARLA_PROFILE_SCOPE</span><span class="p">(</span><span class="s">&quot;CarlaEngine&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;performance&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 分析CarlaEngine的性能</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_18">注意事项</h2>
<ul>
<li>在管理时钟的脚本完成之前禁用同步模式，以防止服务器阻塞。</li>
<li>在多客户端或多重模拟中，确保Profiler的正确配置和使用，以避免性能分析数据的混乱。</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
