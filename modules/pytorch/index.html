<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CARLA–PyTorch JIT 轮子动力学推理模块 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CARLA\u2013PyTorch JIT \u8f6e\u5b50\u52a8\u529b\u5b66\u63a8\u7406\u6a21\u5757";
        var mkdocs_page_input_path = "modules/pytorch.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">CARLA–PyTorch JIT 轮子动力学推理模块</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/pytorch.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="carlapytorch-jit">CARLA–PyTorch JIT 轮子动力学推理模块</h1>
<blockquote>
<p>该文档详细说明了代码中各模块的功能与调用流程，方便开发者快速理解与使用。</p>
</blockquote>
<hr />
<h2 id="_1">目录</h2>
<ul>
<li><a href="#1-项目概述">1. 项目概述</a></li>
<li><a href="#2-依赖与头文件">2. 依赖与头文件</a></li>
<li><a href="#3-全局辅助函数">3. 全局辅助函数</a></li>
<li><a href="#4-carlalearning-命名空间">4. carla::learning 命名空间</a></li>
<li><a href="#5-NeuralModelImpl-结构体">5. NeuralModelImpl 结构体</a></li>
<li><a href="#6-NeuralModel-类接口">6. NeuralModel 类接口</a></li>
<li><a href="#7-整体调用流程">7. 整体调用流程</a></li>
</ul>
<h2 id="1">1. 项目概述</h2>
<p>本模块在 <strong>CARLA 仿真环境</strong> 中实现了 <strong>轮子动力学计算</strong> 与 <strong>PyTorch JIT 模型推理</strong> 之间的无缝桥接。通过这一模块，开发者可以在真实感强的仿真环境中使用深度学习模型对轮子的物理行为进行推理，并对其进行动态调整。这一桥梁的搭建为复杂的自动驾驶仿真提供了更高效的计算与推理能力。</p>
<p><img alt="该模块的各个函数关系图" src="../../img/carla_learning_pytorch_structure.svg" /></p>
<p>该模块功能如下：</p>
<ol>
<li>
<p><strong>将 C++ 原始数据封装成 PyTorch 张量</strong>：将 CARLA 仿真中的轮子动力学数据转化为 PyTorch 张量，方便模型处理。</p>
</li>
<li>
<p><strong>调用 TorchScript 模型进行推理</strong>：加载并使用已训练的 TorchScript 模型执行前向推理，计算轮子物理行为。</p>
</li>
<li><strong>从输出张量中提取结果</strong>：从推理结果中获取粒子力和轮子力，并填充到 WheelOutput 中。</li>
<li><strong>支持多种推理模式</strong>：提供 CPU、动态推理及 CUDA 加速模式，适应不同硬件环境和计算需求。</li>
</ol>
<hr />
<h2 id="2">2. 依赖与头文件</h2>
<ul>
<li><strong>源码参考</strong> <a href="https://openhutb.github.io/carla_cpp/db/dd0/pytorch_8h_source.html">pytorch.h 源码</a></li>
<li><strong>torch/torch.h / torch/script.h</strong>：PyTorch C++ API 与 JIT 接口</li>
<li><strong>torchscatter &amp; torchcluster</strong>：验证扩展库的 CUDA 支持</li>
<li><strong>tensorexpr_fuser</strong>：控制 JIT Fuse 优化</li>
<li><strong>CUDACachingAllocator</strong>：用于显式清理 CUDA 缓存</li>
</ul>
<hr />
<h2 id="3">3. 全局辅助函数</h2>
<h3 id="31-add_mark">3.1 add_mark</h3>
<ul>
<li><strong>作用</strong>：空壳函数，用于在代码中插入标记，便于日志或调试</li>
<li>
<p><strong>参数</strong>：<code>text</code> — 标记文本，不作实际处理</p>
</li>
<li>
<p><strong>源码链接</strong>：更多细节请参考 <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L20">pytorch.cpp </a></p>
</li>
</ul>
<h2 id="4-carlalearning">4. carla::learning 命名空间</h2>
<p>该命名空间封装了与轮子动力学及模型推理相关的核心函数。</p>
<h3 id="41-test_learning">4.1 test_learning</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L27">pytorch.cpp 源码</a></li>
<li>
<p><strong>功能</strong>：打印 torchcluster 和 torchscatter 的 CUDA 版本，验证环境</p>
</li>
<li>
<p><strong>示例输出</strong>：</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cuda version X.Y
</code></pre></div>
<h3 id="42-getwheeltensorinputs">4.2 GetWheelTensorInputs</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L37">pytorch.cpp 源码</a></li>
<li><strong>输入</strong>：WheelInput 结构体，包含：</li>
<li>particles_positions (float*)</li>
<li>particles_velocities (float*)</li>
<li>wheel_positions (float[3])</li>
<li>wheel_orientation (float[4])</li>
<li>wheel_linear_velocity (float[3])</li>
<li>wheel_angular_velocity (float[3])</li>
<li>num_particles (int)</li>
<li><strong>处理</strong>：</li>
<li>使用 <code>torch::from_blob</code> 将原始指针包装成 at::Tensor（不复制数据）</li>
<li>构造 std::vector<a href="">torch::jit::IValue</a>，按顺序存放所有张量</li>
<li><strong>输出</strong>：Value 元组，用于 Module::forward()</li>
</ul>
<h3 id="43-getwheeltensoroutput">4.3 GetWheelTensorOutput</h3>
<ul>
<li><strong>源码参考</strong>:<a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L74">pytorch.cpp 源码</a></li>
<li><strong>输入</strong>：</li>
<li>particle_forces：形状 [num_particles, 3] 张量</li>
<li>wheel_forces：长度 6 张量（力 xyz + 扭矩 xyz）</li>
<li><strong>处理</strong>：</li>
<li>从 <code>wheel_forces.data_ptr&lt;float&gt;()</code> 读取 6 个值，赋给 WheelOutput 对应字段</li>
<li>遍历 <code>particle_forces.data_ptr&lt;float&gt;()</code>，按 xyz 顺序填充 WheelOutput::_particle_forces 向量</li>
<li><strong>输出</strong>：填充后的 WheelOutput 结构体</li>
</ul>
<h3 id="44-getwheeltensoroutputdynamic">4.4 GetWheelTensorOutputDynamic</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L107">pytorch.cpp 源码</a></li>
<li><strong>功能</strong>：与 GetWheelTensorOutput 相同，用于“动态”推理后的后处理</li>
</ul>
<hr />
<h2 id="5-neuralmodelimpl">5. NeuralModelImpl 结构体</h2>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L133">pytorch.cpp 源码</a></li>
<li><strong>成员变量</strong>：</li>
<li>module：已加载的 TorchScript 模型</li>
<li>particles_*_tensors：可选的缓存张量队列（当前未深入使用）</li>
<li><strong>成员函数</strong>：</li>
<li>GetWheelTensorInputsCUDA：CUDA 版本的 GetWheelTensorInputs</li>
</ul>
<h3 id="51-getwheeltensorinputscuda">5.1 GetWheelTensorInputsCUDA</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L150">pytorch.cpp 源码</a></li>
<li><strong>功能</strong>：与 GetWheelTensorInputs 相同，但创建后立即 <code>.cuda()</code> 并附加 wheel_idx 信息</li>
<li><strong>用途</strong>：并行推理时区分不同车轮</li>
</ul>
<hr />
<h2 id="6-neuralmodel">6. NeuralModel 类接口</h2>
<p>该类对外暴露模型加载、输入设置、推理和结果获取接口。</p>
<p><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L187">pytorch.cpp 源码</a></p>
<h3 id="61">6.1 构造与析构</h3>
<div class="highlight"><pre><span></span><code>NeuralModel::NeuralModel()
NeuralModel::~NeuralModel()
</code></pre></div>
<ul>
<li><strong>功能</strong>：使用 <code>std::make_unique&lt;NeuralModelImpl&gt;()</code> 初始化内部实现；自动释放</li>
</ul>
<h3 id="62-loadmodel">6.2 LoadModel</h3>
<div class="highlight"><pre><span></span><code>void NeuralModel::LoadModel(char* filename, int device)
</code></pre></div>
<ul>
<li><strong>功能</strong>：</li>
<li><code>torch::jit::setTensorExprFuserEnabled(false)</code> 关闭 TensorExpr Fuse</li>
<li><code>Model-&gt;module = torch::jit::load(filename)</code> 加载模型</li>
<li>（可选）将模型转移到 <code>cuda:device</code></li>
<li><strong>异常处理</strong>：捕获并打印 c10::Error</li>
</ul>
<h3 id="63-setinputs">6.3 SetInputs</h3>
<div class="highlight"><pre><span></span><code>void NeuralModel::SetInputs(Inputs input)
</code></pre></div>
<ul>
<li><strong>功能</strong>：保存传入的 Inputs（包含四个 WheelInput、操作指令、地形类型、verbose 标志）</li>
</ul>
<h3 id="64-forward">6.4 推理：Forward</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L219">pytorch.cpp 源码</a></li>
<li><strong>流程</strong>：</li>
<li>调用 GetWheelTensorInputs 构建四组车轮张量</li>
<li>驾驶命令（steering, throttle, braking）及 optional terrain_type、verbose</li>
<li>执行 <code>module.forward(TorchInputs)</code></li>
<li>拆解输出元组为 8 个张量，调用 GetWheelTensorOutput 填充 _output</li>
</ul>
<h3 id="65-forwarddynamic">6.5 动态推理：ForwardDynamic</h3>
<ul>
<li><strong>区别</strong>：使用 GetWheelTensorOutputDynamic，并在末尾调用 <code>CUDACachingAllocator::emptyCache()</code> 清理 CUDA 缓存</li>
</ul>
<h3 id="66-cuda-forwardcudatensors">6.6 CUDA 推理：ForwardCUDATensors</h3>
<ul>
<li><strong>区别</strong>：</li>
<li>使用 GetWheelTensorInputsCUDA 将所有张量 <code>.cuda()</code></li>
<li>驾驶指令等也 <code>.cuda()</code></li>
<li>其余逻辑同 Forward</li>
</ul>
<h3 id="67-getoutputs">6.7 结果获取：GetOutputs</h3>
<ul>
<li><strong>源码参考</strong>: <a href="https://openhutb.github.io/carla_cpp/dd/d8c/pytorch_8cpp_source.html#L246">pytorch.cpp 源码</a></li>
<li><strong>功能</strong>：返回内部 _output，包含四个 WheelOutput</li>
</ul>
<h2 id="7">7. 整体流程</h2>
<p>该模块调用流程图如下：</p>
<p><img alt="该模块的各个函数关系图" src="../../img/neural_model_flow.svg" /></p>
<ol>
<li><strong>初始化与加载</strong></li>
</ol>
<div class="highlight"><pre><span></span><code>NeuralModel model;
model.LoadModel(&quot;mymodel.pt&quot;, /*device=*/0);
</code></pre></div>
<ol>
<li><strong>设置输入</strong></li>
</ol>
<div class="highlight"><pre><span></span><code>Inputs inp = /* 构造 WheelInput + 操作指令 */;
model.SetInputs(inp);
</code></pre></div>
<ol>
<li><strong>选择推理模式</strong></li>
</ol>
<div class="highlight"><pre><span></span><code>model.Forward();                // CPU 模式
// 或
model.ForwardDynamic();         // 动态 + 缓存清理
// 或
model.ForwardCUDATensors();     // 全 CUDA 模式
</code></pre></div>
<ol>
<li><strong>获取输出</strong></li>
</ol>
<div class="highlight"><pre><span></span><code>auto &amp;outs = model.GetOutputs();
// outs.wheel0 ... outs.wheel3
</code></pre></div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
