<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>FCarlaServer 类说明文档 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "FCarlaServer \u7c7b\u8bf4\u660e\u6587\u6863";
        var mkdocs_page_input_path = "modules/Server.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">FCarlaServer 类说明文档</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/modules/Server.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="fcarlaserver">FCarlaServer 类说明文档</h1>
<p><code>FCarlaServer</code> 是 CARLA 模拟器中用于处理服务器相关功能的类。它负责管理 RPC 服务器、流服务器以及多 GPU 路由器的启动、运行和停止。该类还提供了与 CARLA 模拟场景（Episode）的交互功能，包括场景的加载、卸载、Actor 的生成与销毁、传感器数据的传输等。</p>
<h2 id="_1">类成员函数</h2>
<h3 id="_2">构造函数与析构函数</h3>
<ul>
<li><strong>FCarlaServer()</strong></li>
<li>
<p>默认构造函数，用于创建 <code>FCarlaServer</code> 类的对象实例。</p>
</li>
<li>
<p><strong>~FCarlaServer()</strong></p>
</li>
<li>析构函数，用于在对象销毁时进行资源清理、释放等相关操作，比如关闭网络连接、释放内存等。</li>
<li>释放以下资源：  <ul>
<li>关闭 RPC 服务器、流服务器及多 GPU 路由器。  </li>
<li>清理当前 <code>UCarlaEpisode</code> 实例及关联的 Actor 数据。</li>
</ul>
</li>
</ul>
<h3 id="_3">服务器启动与停止</h3>
<ul>
<li><strong>FDataMultiStream Start(uint16_t RPCPort, uint16_t StreamingPort, uint16_t SecondaryPort)</strong></li>
<li>启动服务器相关功能，传入 RPC 端口号（RPCPort）、流数据端口号（StreamingPort）以及备用端口号（SecondaryPort），返回一个多数据流对象（FDataMultiStream），可能用于后续的多种数据传输交互场景。</li>
<li><strong>参数说明</strong>：  <ul>
<li><code>RPCPort</code>: RPC 服务端口（默认范围 2000-3000）。  </li>
<li><code>StreamingPort</code>: 流数据端口（需与客户端配置一致）。  </li>
<li><code>SecondaryPort</code>: 多 GPU 路由器端口（仅多 GPU 环境需配置）。  </li>
</ul>
</li>
<li>
<p><strong>返回值</strong>：<code>FDataMultiStream</code> 对象，用于管理多路数据流（如传感器数据、控制指令）。</p>
</li>
<li>
<p><strong>void Stop()</strong></p>
</li>
<li>停止服务器运行，释放相关资源，关闭各种连接等，将服务器置于停止状态。</li>
</ul>
<h3 id="_4">场景管理</h3>
<ul>
<li><strong>void NotifyBeginEpisode(UCarlaEpisode &amp;Episode)</strong></li>
<li>
<p>通知服务器开始一个 CARLA Episode（可能是一个模拟场景、任务等的阶段），传入对应的 <code>UCarlaEpisode</code> 对象引用，以便服务器知晓相关信息进行对应处理。</p>
</li>
<li>
<p><strong>void NotifyEndEpisode()</strong></p>
</li>
<li>通知服务器结束当前的 CARLA Episode，让服务器进行相应的清理、收尾等操作。</li>
</ul>
<h3 id="_5">服务器运行</h3>
<ul>
<li><strong>void AsyncRun(uint32 NumberOfWorkerThreads)</strong></li>
<li>
<p>以异步方式运行服务器，传入工作线程数量（NumberOfWorkerThreads）参数，可让服务器利用多线程来高效处理各种任务，比如数据接收、处理和发送等。</p>
</li>
<li>
<p><strong>void RunSome(uint32 Milliseconds)</strong></p>
</li>
<li>
<p>运行服务器一段时间，传入时间（以毫秒为单位，Milliseconds）参数，在指定时长内执行服务器相关的逻辑，比如处理数据、更新状态等。</p>
</li>
<li>
<p><strong>void Tick()</strong></p>
</li>
<li>执行服务器的一次“滴答”操作，通常用于周期性地更新服务器状态、处理数据等，类似于游戏循环里的每一帧更新逻辑。</li>
<li><strong>功能</strong>：执行单次服务器状态更新，包括：  <ul>
<li>处理客户端 RPC 请求。  </li>
<li>更新 <code>UCarlaEpisode</code> 中的 Actor 状态。  </li>
<li>推送传感器数据到流服务器。</li>
<li></li>
</ul>
</li>
<li><strong>bool TickCueReceived()</strong></li>
<li>检查是否接收到了“滴答”提示（Tick Cue），返回布尔值表示是否收到，可用于判断是否需要进行下一步相关操作等。</li>
</ul>
<h3 id="_6">数据流管理</h3>
<ul>
<li><strong>FDataStream OpenStream() const</strong></li>
<li>打开一个数据流，返回一个数据流转对象（FDataStream），用于后续的数据读取、写入等操作，可能是针对特定的数据传输通道进行操作。</li>
</ul>
<h3 id="gpu">多 GPU 路由器与流服务器</h3>
<ul>
<li><strong>std::shared_ptr<carla::multigpu::Router> GetSecondaryServer()</strong></li>
<li>
<p>获取指向多 GPU 路由器（multigpu::Router）的共享指针，这个路由器可能用于在多 GPU 环境下对数据等进行路由转发、调度等功能，返回的是智能指针便于内存管理。</p>
</li>
<li>
<p><strong>carla::streaming::Server &amp;GetStreamingServer()</strong></p>
</li>
<li>获取流服务器（streaming::Server）的引用，以便能直接操作流服务器对象，比如配置服务器参数、获取服务器状态信息等。</li>
</ul>
<h2 id="fpimpl">内部类 FPimpl</h2>
<p><code>FCarlaServer</code> 类内部定义了一个名为 <code>FPimpl</code> 的私有内部类，通常这种方式用于实现“编译防火墙”（Pimpl，即“Pointer to implementation”），将类的实现细节隐藏在内部类中，对外只暴露接口。</p>
<ul>
<li><strong>关键成员</strong>：  </li>
<li><code>StreamingServer</code>: 管理传感器数据流（如摄像头、激光雷达）。  </li>
<li><code>SecondaryServer</code>: 多 GPU 环境下的数据路由控制器。  </li>
<li><code>BindActions()</code>: 绑定 RPC 操作到具体实现（如 <code>SpawnActor</code>、<code>DestroyActor</code>）。</li>
</ul>
<h3 id="fpimpl_1">FPimpl 类成员</h3>
<ul>
<li><strong>FPimpl(uint16_t RPCPort, uint16_t StreamingPort, uint16_t SecondaryPort)</strong></li>
<li>
<p>构造函数，初始化 RPC 服务器、流服务器和多 GPU 路由器。</p>
</li>
<li>
<p><strong>std::shared_ptr<carla::multigpu::Router> GetSecondaryServer()</strong></p>
</li>
<li>
<p>获取多 GPU 路由器的共享指针。</p>
</li>
<li>
<p><strong>carla::streaming::Server StreamingServer</strong></p>
</li>
<li>
<p>流服务器对象，用于处理传感器数据的传输。</p>
</li>
<li>
<p><strong>carla::streaming::Stream BroadcastStream</strong></p>
</li>
<li>
<p>广播流对象，用于向多个客户端广播数据。</p>
</li>
<li>
<p><strong>std::shared_ptr<carla::multigpu::Router> SecondaryServer</strong></p>
</li>
<li>
<p>多 GPU 路由器对象，用于在多 GPU 环境下进行数据路由。</p>
</li>
<li>
<p><strong>UCarlaEpisode *Episode</strong></p>
</li>
<li>
<p>当前 CARLA Episode 的指针，用于管理模拟场景。</p>
</li>
<li>
<p><strong>std::atomic_size_t TickCuesReceived</strong></p>
</li>
<li>用于记录接收到的“滴答”提示数量。</li>
</ul>
<h3 id="fpimpl_2">FPimpl 类私有函数</h3>
<ul>
<li><strong>void BindActions()</strong></li>
<li>绑定 RPC 服务器的各种操作，包括场景加载、Actor 生成与销毁、传感器数据管理等。</li>
</ul>
<h2 id="_7">辅助宏</h2>
<ul>
<li><strong>BIND_SYNC(name)</strong></li>
<li>
<p>用于同步绑定 RPC 函数（阻塞式调用，适用于简单操作）。</p>
</li>
<li>
<p><strong>BIND_ASYNC(name)</strong></p>
</li>
<li>
<p>用于异步绑定 RPC 函数（非阻塞式调用，适用于耗时操作）。</p>
</li>
<li>
<p><strong>REQUIRE_CARLA_EPISODE()</strong></p>
</li>
<li>
<p>确保当前有一个有效的 CARLA Episode 正在运行。</p>
</li>
<li>
<p><strong>RESPOND_ERROR(str)</strong></p>
</li>
<li>
<p>记录错误消息并返回一个 <code>ResponseError</code> 对象。</p>
</li>
<li>
<p><strong>RESPOND_ERROR_FSTRING(fstr)</strong></p>
</li>
<li>
<p>记录由 <code>FString</code> 表示的错误消息并返回一个 <code>ResponseError</code> 对象。</p>
</li>
<li>
<p><strong>CARLA_ENSURE_GAME_THREAD()</strong></p>
</li>
<li>确保代码在游戏线程中执行。</li>
</ul>
<h1 id="carla">Carla 服务器响应状态说明文档</h1>
<h2 id="_8">版权信息</h2>
<p>Copyright (c) 2020 Computer Vision Center (CVC) at the Universitat Autonoma de Barcelona (UAB).
本作品在 MIT 许可证下发布，许可证副本见 <a href="https://opensource.org/licenses/MIT">The MIT License</a>。</p>
<h2 id="ecarlaserverresponse">枚举类型 ECarlaServerResponse</h2>
<p>该枚举类型用于表示 Carla 服务器的响应状态，具体枚举值及其含义如下：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Success</td>
<td>操作成功</td>
</tr>
<tr>
<td>ActorNotFound</td>
<td>找不到指定的 actor</td>
</tr>
<tr>
<td>ComponentNotFound</td>
<td>找不到指定的组件</td>
</tr>
<tr>
<td>ActorTypeMismatch</td>
<td>actor 类型不匹配</td>
</tr>
<tr>
<td>FunctionNotSupported</td>
<td>不支持的函数调用</td>
</tr>
<tr>
<td>NullActor</td>
<td>空的 actor</td>
</tr>
<tr>
<td>MissingActor</td>
<td>缺少 actor</td>
</tr>
<tr>
<td>NotAVehicle</td>
<td>不是车辆类型的 actor</td>
</tr>
<tr>
<td>WalkerDead</td>
<td>行人已死亡</td>
</tr>
<tr>
<td>NotAWalker</td>
<td>不是行人类型的 actor</td>
</tr>
<tr>
<td>WalkerIncompatibleController</td>
<td>行人控制器不兼容</td>
</tr>
<tr>
<td>AutoPilotNotSupported</td>
<td>自动驾驶不支持</td>
</tr>
<tr>
<td>CarSimPluginNotEnabled</td>
<td>车辆模拟插件未启用</td>
</tr>
<tr>
<td>NotATrafficLight</td>
<td>不是交通信号灯</td>
</tr>
<tr>
<td>FunctionNotAvailableWhenDormant</td>
<td>当处于休眠状态时函数不可用</td>
</tr>
</tbody>
</table>
<h2 id="carlagetstringerror">函数 CarlaGetStringError</h2>
<p>该函数用于根据给定的 ECarlaServerResponse 枚举值返回对应的错误描述字符串。
- <strong>功能</strong>：将错误码转换为可读的错误消息（本地化支持）。
- </p>
<h3 id="_9">函数原型</h3>
<p><code>cpp
FString CarlaGetStringError(ECarlaServerResponse Response);
- **示例**：</code>cpp
  ECarlaServerResponse ErrorCode = ECarlaServerResponse::ActorNotFound;
  FString ErrorMsg = CarlaGetStringError(ErrorCode); // 返回 "Actor not found"</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
