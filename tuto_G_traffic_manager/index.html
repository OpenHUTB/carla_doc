<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>交通管理器 - 人车模拟器</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u4ea4\u901a\u7ba1\u7406\u5668";
        var mkdocs_page_input_path = "tuto_G_traffic_manager.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">交通管理器</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/tuto_G_traffic_manager.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">交通管理器</h1>
<p>当我们训练神经网络来控制自动驾驶车辆时，自动驾驶代理必须应对的关键挑战之一是其他道路使用者。除了识别和导航道路网络拓扑以及维护车道规则的任务之外，自动驾驶代理还必须识别其他车辆并预测对其计划行动方案的影响。Carla 的交通管理器能够管理通过模拟导航的车辆群，并为感兴趣的车辆（即我们正在训练或控制的车辆）设置障碍和挑战。在 Carla 文献中，我们将这种车辆称为“自我车辆”以示区别。</p>
<p>交通管理器管理地图内非玩家参与者车辆的行为和生命周期，用车辆填充模拟，其行为与其他道路使用者在真实道路网络上的行为相同。在本教程中，我们将介绍交通管理器的一些功能以及如何在模拟中使用它来创建和控制非玩家参与者。</p>
<h2 id="_2">设置模拟器并初始化交通管理器</h2>
<p>首先，我们将初始化交通管理器并创建一些随机分布在城市周围的流量。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">carla</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># 客户端连接并获取时间对象</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">carla</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_world</span><span class="p">()</span>

<span class="c1"># 以同步模式启动模拟器</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
<span class="n">settings</span><span class="o">.</span><span class="n">synchronous_mode</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Enables synchronous mode</span>
<span class="n">settings</span><span class="o">.</span><span class="n">fixed_delta_seconds</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">world</span><span class="o">.</span><span class="n">apply_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

<span class="c1"># 以同步模式启动交通管理器</span>
<span class="n">traffic_manager</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_trafficmanager</span><span class="p">()</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_synchronous_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 如果有必要设置一个种子，以便能够重现行为</span>
<span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_random_device_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 启动观察者以便能开到所做的事</span>
<span class="n">spectator</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_spectator</span><span class="p">()</span>
</code></pre></div>
<h2 id="_3">生成车辆</h2>
<p>当我们创建交通管理器车辆时，它们需要一个生成的地图位置。我们可以使用自己选择的地图坐标自行定义这些。然而，为了解决这个问题，每个 Carla 地图都有一组预定义的生成点，均匀分布在整个道路网络中。我们可以使用这些生成点来生成我们的车辆。</p>
<div class="highlight"><pre><span></span><code><span class="n">spawn_points</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_spawn_points</span><span class="p">()</span>
</code></pre></div>
<p>我们可以使用 Carla 的调试功能来查看生成点在哪里。运行以下代码，然后飞过地图并检查生成点的位置。当我们想要选择更具体的点用于生成或引导车辆时，这会派上用场。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在地图上以数字绘制生成点的位置</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spawn_point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">):</span>
    <span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_point</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 在同步模式下，我们需要运行模拟来飞行观察则会</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
</code></pre></div>
<p>现在让我们生成一些车辆。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 从蓝图库中选择一些模型</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dodge&#39;</span><span class="p">,</span> <span class="s1">&#39;audi&#39;</span><span class="p">,</span> <span class="s1">&#39;model3&#39;</span><span class="p">,</span> <span class="s1">&#39;mini&#39;</span><span class="p">,</span> <span class="s1">&#39;mustang&#39;</span><span class="p">,</span> <span class="s1">&#39;lincoln&#39;</span><span class="p">,</span> <span class="s1">&#39;prius&#39;</span><span class="p">,</span> <span class="s1">&#39;nissan&#39;</span><span class="p">,</span> <span class="s1">&#39;crown&#39;</span><span class="p">,</span> <span class="s1">&#39;impala&#39;</span><span class="p">]</span>
<span class="n">blueprints</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">get_blueprint_library</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;*vehicle*&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">model</span> <span class="ow">in</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">):</span>
        <span class="n">blueprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>

<span class="c1"># 设置车辆的最大数目并准备我们生成的一个列表</span>
<span class="n">max_vehicles</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">max_vehicles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">max_vehicles</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">)])</span>
<span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 对生成点进行随机采样并生成一些车辆。</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spawn_point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">,</span> <span class="n">max_vehicles</span><span class="p">)):</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">try_spawn_actor</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">blueprints</span><span class="p">),</span> <span class="n">spawn_point</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

<span class="c1"># 运行模拟以便我们能查看观察者的结果</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
</code></pre></div>
<p>如果您现在与观察者一起飞过地图，您应该会看到静止的车辆占据地图中的道路。</p>
<h2 id="_4">使用交通管理器控制车辆</h2>
<p>现在我们可以让交通管理器控制我们的车辆并让模拟运行。一旦交通管理器控制了车辆，它们就会在道路上自主移动，遵循道路网络的特征，如车道和红绿灯，并避免与其他车辆发生碰撞。</p>
<p>交通管理器具有许多功能，允许修改每辆车的特定行为。在下面的例子中，我们为每辆车设置了忽略红绿灯的随机概率，因此有些车辆会倾向于忽略红绿灯，而另一些车辆则会遵守红绿灯。可以设置多种不同的行为，有关详细信息，请参阅 Python API 参考。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 解析所生成车辆的列表并通过set_autopilot()将控制权交给交通管理器</span>
<span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">vehicles</span><span class="p">:</span>
    <span class="n">vehicle</span><span class="o">.</span><span class="n">set_autopilot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Randomly set the probability that a vehicle will ignore traffic lights</span>
    <span class="n">traffic_manager</span><span class="o">.</span><span class="n">ignore_lights_percentage</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
</code></pre></div>
<p>如果您现在与观察者一起飞过地图，您将看到车辆在地图上自动行驶。</p>
<p><img alt="intersection_traffic" src="../img/tuto_G_traffic_manager/traffic.gif" /></p>
<h2 id="_5">指定车辆行驶路线</h2>
<p>在前面的步骤中，我们了解了如何在地图中生成一组车辆，然后将它们的控制权交给交通管理器，以创建一个充满移动交通的繁忙城镇。交通管理器具有更深入的功能，可以更紧密地控制车辆的行为。</p>
<p>我们现在将使用<code>traffic_manager.set_path()</code>功能引导交通管理器车辆沿着特定路径行驶。在这种情况下，我们将创建两条汇聚的交通流，它们将在市中心汇聚并造成拥堵。</p>
<p>首先，我们将选择一些路径点来构建我们的路径。生成点是方便的路径点，与之前一样，我们可以使用 Carla 的调试工具在地图上绘制生成点的位置。通过与观察者一起飞过地图，我们可以选择要用于路径的生成点的索引。该函数使用指定为 <a href="../python_api/#carla.Location">carla.Locations</a> 的坐标列表。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在地图上使用数字绘制生成点的位置</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spawn_point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">):</span>
    <span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_point</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 在同步模式下，我们需要运行模拟使观察者飞过场景</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
</code></pre></div>
<p>我们选择生成点和路径点来在城镇内创建两条汇聚的交通流，从而造成拥堵，这可能是向自动驾驶代理展示的一个有趣的场景。</p>
<div class="highlight"><pre><span></span><code><span class="n">spawn_points</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_spawn_points</span><span class="p">()</span>

<span class="c1"># 路线 1</span>
<span class="n">spawn_point_1</span> <span class="o">=</span>  <span class="n">spawn_points</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="c1"># 从所选择的生成点中创建路线 1</span>
<span class="n">route_1_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">129</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">147</span><span class="p">]</span>
<span class="n">route_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">route_1_indices</span><span class="p">:</span>
    <span class="n">route_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

<span class="c1"># 路线 2</span>
<span class="n">spawn_point_2</span> <span class="o">=</span>  <span class="n">spawn_points</span><span class="p">[</span><span class="mi">149</span><span class="p">]</span>
<span class="c1"># 从所选择的生成点中创建路线 2</span>
<span class="n">route_2_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">route_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">route_2_indices</span><span class="p">:</span>
    <span class="n">route_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

<span class="c1"># 现在让我们在地图上打印出它们，以便我们能看到我们的路径</span>
<span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_point_1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;Spawn point 1&#39;</span><span class="p">,</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">carla</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_point_2</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;Spawn point 2&#39;</span><span class="p">,</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">carla</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">route_1_indices</span><span class="p">:</span>
    <span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span>
    <span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">carla</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">route_2_indices</span><span class="p">:</span>
    <span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span>
    <span class="n">world</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">draw_string</span><span class="p">(</span><span class="n">spawn_points</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">life_time</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">carla</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
</code></pre></div>
<p><img alt="routes" src="../img/tuto_G_traffic_manager/set_paths.png" /></p>
<p>现在我们已经选择了生成点和路径点，现在我们可以开始生成交通并将生成的车辆设置为遵循我们的路径点列表。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在生成时间之间设置延迟以创建空隙</span>
<span class="n">spawn_delay</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">spawn_delay</span>

<span class="c1"># 设置最大车辆（为更低的硬件设置更小的值）</span>
<span class="n">max_vehicles</span> <span class="o">=</span> <span class="mi">200</span>
<span class="c1"># 在生成点之间轮流</span>
<span class="n">alt</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">spawn_points</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_spawn_points</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">world</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>

    <span class="n">n_vehicles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">get_actors</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;*vehicle*&#39;</span><span class="p">))</span>
    <span class="n">vehicle_bp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">blueprints</span><span class="p">)</span>

    <span class="c1"># 仅在延迟之后生成车辆</span>
    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="n">spawn_delay</span> <span class="ow">and</span> <span class="n">n_vehicles</span> <span class="o">&lt;</span> <span class="n">max_vehicles</span><span class="p">:</span>
        <span class="c1"># Alternate spawn points</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="n">vehicle</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">try_spawn_actor</span><span class="p">(</span><span class="n">vehicle_bp</span><span class="p">,</span> <span class="n">spawn_point_1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vehicle</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">try_spawn_actor</span><span class="p">(</span><span class="n">vehicle_bp</span><span class="p">,</span> <span class="n">spawn_point_2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vehicle</span><span class="p">:</span> <span class="c1"># 如果车辆成功生成</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">set_autopilot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 将车辆的控制全交给交通管理器</span>

            <span class="c1"># 设置交通管理器车辆控制的参数，我们不想变道</span>
            <span class="n">traffic_manager</span><span class="o">.</span><span class="n">update_vehicle_lights</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">traffic_manager</span><span class="o">.</span><span class="n">random_left_lanechange_percentage</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">traffic_manager</span><span class="o">.</span><span class="n">random_right_lanechange_percentage</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">traffic_manager</span><span class="o">.</span><span class="n">auto_lane_change</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># 在生成点之间轮流</span>
            <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
                <span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">route_1</span><span class="p">)</span>
                <span class="n">alt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">traffic_manager</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">route_2</span><span class="p">)</span>
                <span class="n">alt</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">vehicle</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">spawn_delay</span>
</code></pre></div>
<p>通过上面的代码，我们在交通管理器 <code>set_path()</code> 功能的引导下创建了来自地图两侧的两个汇聚的流量流。这导致市中心道路拥堵。这种技术可以更大规模地用于模拟自动驾驶车辆的多种棘手情况，例如繁忙的环岛或高速公路交叉口。</p>
<p><img alt="converging_paths" src="../img/tuto_G_traffic_manager/converging_paths.gif" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../js/umlconvert.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
