<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>交通管理器 - 交通仿真文档</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u4ea4\u901a\u7ba1\u7406\u5668";
        var mkdocs_page_input_path = "tuto_G_traffic_manager.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> 交通仿真文档
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="#_1">入门</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_2">主题</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_3">交通</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_4">行人</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_5">高级概念</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_6">自定义地图</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_7">自定义开发</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_8">基准测试</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_9">生态系统</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_10">源代码编译</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_11">贡献</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_12">其他</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="#_13">参考</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">交通仿真文档</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">交通管理器</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/carla_doc/edit/master/docs/tuto_G_traffic_manager.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">交通管理器</h1>
<p>当我们训练神经网络来控制自动驾驶车辆时，自动驾驶代理必须应对的关键挑战之一是其他道路使用者。除了识别和导航道路网络拓扑以及维护车道规则的任务之外，自动驾驶代理还必须识别其他车辆并预测对其计划行动方案的影响。Carla 的交通管理器能够管理通过仿真导航的车辆群，并为感兴趣的车辆（即我们正在训练或控制的车辆）设置障碍和挑战。在 Carla 文献中，我们将这种车辆称为“自我车辆”以示区别。</p>
<p>交通管理器管理地图内非玩家角色车辆的行为和生命周期，用车辆填充仿真，其行为与其他道路使用者在真实道路网络上的行为相同。在本教程中，我们将介绍交通管理器的一些功能以及如何在仿真中使用它来创建和控制非玩家角色。</p>
<h2 id="_2">设置仿真器并初始化交通管理器</h2>
<p>首先，我们将初始化交通管理器并创建一些随机分布在城市周围的流量。</p>
<pre><code class="language-py">import carla
import random

# Connect to the client and retrieve the world object
client = carla.Client('localhost', 2000)
world = client.get_world()

# Set up the simulator in synchronous mode
settings = world.get_settings()
settings.synchronous_mode = True # Enables synchronous mode
settings.fixed_delta_seconds = 0.05
world.apply_settings(settings)

# Set up the TM in synchronous mode
traffic_manager = client.get_trafficmanager()
traffic_manager.set_synchronous_mode(True)

# Set a seed so behaviour can be repeated if necessary
traffic_manager.set_random_device_seed(0)
random.seed(0)

# We will aslo set up the spectator so we can see what we do
spectator = world.get_spectator()

</code></pre>
<h2 id="_3">生成车辆</h2>
<p>当我们创建交通管理器车辆时，它们需要一个生成的地图位置。我们可以使用自己选择的地图坐标自行定义这些。然而，为了解决这个问题，每个 Carla 地图都有一组预定义的生成点，均匀分布在整个道路网络中。我们可以使用这些生成点来生成我们的车辆。</p>
<pre><code class="language-py">spawn_points = world.get_map().get_spawn_points()
</code></pre>
<p>我们可以使用 Carla 的调试功能来查看生成点在哪里。运行以下代码，然后飞过地图并检查生成点的位置。当我们想要选择更具体的点用于生成或引导车辆时，这会派上用场。</p>
<pre><code class="language-py"># 在地图上以数字绘制生成点的位置
for i, spawn_point in enumerate(spawn_points):
    world.debug.draw_string(spawn_point.location, str(i), life_time=10)

# 在同步模式下，我们需要运行仿真来飞行观察则会
while True:
    world.tick()
</code></pre>
<p>现在让我们生成一些车辆。</p>
<pre><code class="language-py"># 从蓝图库中选择一些模型
models = ['dodge', 'audi', 'model3', 'mini', 'mustang', 'lincoln', 'prius', 'nissan', 'crown', 'impala']
blueprints = []
for vehicle in world.get_blueprint_library().filter('*vehicle*'):
    if any(model in vehicle.id for model in models):
        blueprints.append(vehicle)

# 设置车辆的最大数目并准备我们生成的一个列表
max_vehicles = 50
max_vehicles = min([max_vehicles, len(spawn_points)])
vehicles = []

# 对生成点进行随机采样并生成一些车辆。
for i, spawn_point in enumerate(random.sample(spawn_points, max_vehicles)):
    temp = world.try_spawn_actor(random.choice(blueprints), spawn_point)
    if temp is not None:
        vehicles.append(temp)

# 运行仿真以便我们能查看观察者的结果
while True:
    world.tick()


</code></pre>
<p>如果您现在与观察者一起飞过地图，您应该会看到静止的车辆占据地图中的道路。</p>
<h2 id="_4">使用交通管理器控制车辆</h2>
<p>现在我们可以让交通管理器控制我们的车辆并让仿真运行。一旦交通管理器控制了车辆，它们就会在道路上自主移动，遵循道路网络的特征，如车道和红绿灯，并避免与其他车辆发生碰撞。</p>
<p>交通管理器具有许多功能，允许修改每辆车的特定行为。在下面的例子中，我们为每辆车设置了忽略红绿灯的随机概率，因此有些车辆会倾向于忽略红绿灯，而另一些车辆则会遵守红绿灯。可以设置多种不同的行为，有关详细信息，请参阅 Python API 参考。</p>
<pre><code class="language-py"># 解析所生成车辆的列表并通过set_autopilot()将控制权交给交通管理器
for vehicle in vehicles:
    vehicle.set_autopilot(True)
    # Randomly set the probability that a vehicle will ignore traffic lights
    traffic_manager.ignore_lights_percentage(vehicle, random.randint(0,50))

while True:
    world.tick()

</code></pre>
<p>如果您现在与观察者一起飞过地图，您将看到车辆在地图上自动行驶。</p>
<p><img alt="intersection_traffic" src="../img/tuto_G_traffic_manager/traffic.gif" /></p>
<h2 id="_5">指定车辆行驶路线</h2>
<p>在前面的步骤中，我们了解了如何在地图中生成一组车辆，然后将它们的控制权交给交通管理器，以创建一个充满移动交通的繁忙城镇。交通管理器具有更深入的功能，可以更紧密地控制车辆的行为。</p>
<p>我们现在将使用<code>traffic_manager.set_path()</code>功能引导交通管理器车辆沿着特定路径行驶。在这种情况下，我们将创建两条汇聚的交通流，它们将在市中心汇聚并造成拥堵。</p>
<p>首先，我们将选择一些路径点来构建我们的路径。生成点是方便的路径点，与之前一样，我们可以使用 Carla 的调试工具在地图上绘制生成点的位置。通过与观察者一起飞过地图，我们可以选择要用于路径的生成点的索引。该函数使用指定为 <a href="../python_api/#carla.Location">carla.Locations</a> 的坐标列表。</p>
<pre><code class="language-py"># 在地图上使用数字绘制生成点的位置
for i, spawn_point in enumerate(spawn_points):
    world.debug.draw_string(spawn_point.location, str(i), life_time=10)

# 在同步模式下，我们需要运行仿真使观察者飞过场景
while True:
    world.tick()
</code></pre>
<p>我们选择生成点和路径点来在城镇内创建两条汇聚的交通流，从而造成拥堵，这可能是向自动驾驶代理展示的一个有趣的场景。</p>
<pre><code class="language-py">spawn_points = world.get_map().get_spawn_points()

# 路线 1
spawn_point_1 =  spawn_points[32]
# 从所选择的生成点中创建路线 1
route_1_indices = [129, 28, 124, 33, 97, 119, 58, 154, 147]
route_1 = []
for ind in route_1_indices:
    route_1.append(spawn_points[ind].location)

# 路线 2
spawn_point_2 =  spawn_points[149]
# 从所选择的生成点中创建路线 2
route_2_indices = [21, 76, 38, 34, 90, 3]
route_2 = []
for ind in route_2_indices:
    route_2.append(spawn_points[ind].location)

# 现在让我们在地图上打印出它们，以便我们能看到我们的路径
world.debug.draw_string(spawn_point_1.location, 'Spawn point 1', life_time=30, color=carla.Color(255,0,0))
world.debug.draw_string(spawn_point_2.location, 'Spawn point 2', life_time=30, color=carla.Color(0,0,255))

for ind in route_1_indices:
    spawn_points[ind].location
    world.debug.draw_string(spawn_points[ind].location, str(ind), life_time=60, color=carla.Color(255,0,0))

for ind in route_2_indices:
    spawn_points[ind].location
    world.debug.draw_string(spawn_points[ind].location, str(ind), life_time=60, color=carla.Color(0,0,255))

while True:
    world.tick()

</code></pre>
<p><img alt="routes" src="../img/tuto_G_traffic_manager/set_paths.png" /></p>
<p>现在我们已经选择了生成点和路径点，现在我们可以开始生成交通并将生成的车辆设置为遵循我们的路径点列表。</p>
<pre><code class="language-py">
# 在生成时间之间设置延迟以创建空隙
spawn_delay = 20
counter = spawn_delay

# 设置最大车辆（为更低的硬件设置更小的值）
max_vehicles = 200
# 在生成点之间轮流
alt = False

spawn_points = world.get_map().get_spawn_points()
while True:
    world.tick()

    n_vehicles = len(world.get_actors().filter('*vehicle*'))
    vehicle_bp = random.choice(blueprints)

    # 仅在延迟之后生成车辆
    if counter == spawn_delay and n_vehicles &lt; max_vehicles:
        # Alternate spawn points
        if alt:
            vehicle = world.try_spawn_actor(vehicle_bp, spawn_point_1)
        else:
            vehicle = world.try_spawn_actor(vehicle_bp, spawn_point_2)

        if vehicle: # 如果车辆成功生成
            vehicle.set_autopilot(True) # 将车辆的控制全交给交通管理器

            # 设置交通管理器车辆控制的参数，我们不想变道
            traffic_manager.update_vehicle_lights(vehicle, True)
            traffic_manager.random_left_lanechange_percentage(vehicle, 0)
            traffic_manager.random_right_lanechange_percentage(vehicle, 0)
            traffic_manager.auto_lane_change(vehicle, False)

            # 在生成点之间轮流
            if alt:
                traffic_manager.set_path(vehicle, route_1)
                alt = False
            else:
                traffic_manager.set_path(vehicle, route_2)
                alt = True

            vehicle = None

        counter -= 1
    elif counter &gt; 0:
        counter -= 1
    elif counter == 0:
        counter = spawn_delay

</code></pre>
<p>通过上面的代码，我们在交通管理器 <code>set_path()</code> 功能的引导下创建了来自地图两侧的两个汇聚的流量流。这导致市中心道路拥堵。这种技术可以更大规模地用于仿真自动驾驶车辆的多种棘手情况，例如繁忙的环岛或高速公路交叉口。</p>
<p><img alt="converging_paths" src="../img/tuto_G_traffic_manager/converging_paths.gif" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/carla_doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../extra.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
