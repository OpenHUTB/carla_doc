<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>路线规划 - 人车模拟器</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u8def\u7ebf\u89c4\u5212";
        var mkdocs_page_input_path = "course/motion_planning.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟器
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟器</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">路线规划</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/doc/edit/master/docs/course/motion_planning.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">路线规划</h1>
<p>此示例在 <strong>Carla</strong> 模拟环境中，使用 <strong>RRT</strong> 路径规划和 <strong>PID</strong> 控制进行自动驾驶车辆的路径跟踪， <strong>RRT</strong> 算法能够在复杂的环境中快速找到从起点到终点的路径，同时避开障碍物； <strong>PID</strong> 控制器根据路径的曲率和车辆的位置调整油门、刹车和方向盘，确保车辆能够按照规划的路径行驶。</p>
<h4 id="_2"><strong>环境要求</strong></h4>
<ul>
<li>
<p>Python 3.7</p>
</li>
<li>
<p>CARLA 模拟环境</p>
</li>
<li>
<p>安装必要的Python库</p>
</li>
<li>
<p><a href="https://github.com/OpenHUTB/doc/blob/master/src/course/Motion_Planning/main_v4_VO.py">main_v4_VO</a></p>
</li>
<li>
<p><a href="https://pan.baidu.com/s/15T1hGoWJ70tVmsTX7-zcSw?pwd=hutb"><strong>湖工商场景</strong></a><strong>(WindowsNoEditor)</strong></p>
</li>
</ul>
<p><img alt="" src="../../img/traffic_course_img/planning.gif" /></p>
<h2 id="carla">导入CARLA模块</h2>
<p>​   导入CARLA模块，并添加必要的路径。</p>
<div class="highlight"><pre><span></span><code>try:
    sys.path.append(glob.glob(&#39;../carla/dist/carla-*%d.%d-%s.egg&#39; % (
        sys.version_info.major,
        sys.version_info.minor,
        &#39;win-amd64&#39; if os.name == &#39;nt&#39; else &#39;linux-x86_64&#39;))[0])
    import carla
except IndexError:
    pass
</code></pre></div>
<h2 id="rednerobject">RednerObject  类</h2>
<p>该类主要用于报错和传递 <strong>pygame</strong> 对象</p>
<div class="highlight"><pre><span></span><code>class RenderObject(object):
    def __init__(self, width, height):
        init_image = np.random.randint(0, 255, (height, width, 3), dtype=&#39;uint8&#39;)
        self.surface = pygame.surfarray.make_surface(init_image.swapaxes(0, 1))
</code></pre></div>
<h2 id="pygame_callback">pygame_callback 函数</h2>
<p>​   相机传感器回调函数，将相机原始数据转换为2D RGB图像，并应用于 <strong>Pygame</strong> 。</p>
<div class="highlight"><pre><span></span><code>def pygame_callback(data, obj):
    img = np.reshape(np.copy(data.raw_data), (data.height, data.width, 4))
    img = img[:, :, :3]
    img = img[:, :, ::-1]
    obj.surface = pygame.surfarray.make_surface(img.swapaxes(0, 1))
</code></pre></div>
<h2 id="carla_world">CARLA_world 类</h2>
<p>该类用于连接 <strong>Carla</strong> 服务器，设置同步模式，并管理车辆和相机。</p>
<div class="highlight"><pre><span></span><code>class CARLA_world:
    def __init__(self):
        self.client = carla.Client(&#39;localhost&#39;, 2000)
        self.client.set_timeout(120.0)
        self.carla_world = self.client.get_world()
        self.map = self.carla_world.get_map()

        print(&quot;WORLD READY&quot;)

        settings = self.carla_world.get_settings()
        settings.synchronous_mode = True
        settings.fixed_delta_seconds = 0.02
        self.carla_world.apply_settings(settings)

        self.spectator = self.carla_world.get_spectator()

        self.vehicles = []
        self.ego_vehicle = None
</code></pre></div>
<h2 id="_3">主程序</h2>
<h3 id="carla_1">初始化 <strong>Carla</strong> 世界对象</h3>
<p>创建 <strong>Carla</strong> 世界实例，设置车辆的生成点，生成自车和障碍车辆。</p>
<div class="highlight"><pre><span></span><code>CARLA_world = CARLA_world()
spawn_points = CARLA_world.map.get_spawn_points()
target_speed = 3.0
v_obs = 3.0
spawn_point1 = carla.Transform(carla.Location(x=428, y=-51.9, z=0.3), carla.Rotation(yaw=89))
blueprint_library = CARLA_world.carla_world.get_blueprint_library()
bp1 = blueprint_library.filter(&quot;model3&quot;)[0]
vehicle1 = CARLA_world.carla_world.spawn_actor(bp1, spawn_point1)
CARLA_world.vehicles.append(vehicle1)

spawn_point3 = carla.Transform(carla.Location(x=404, y=-14, z=0.3), carla.Rotation(yaw=0))
bp3 = blueprint_library.filter(&quot;model3&quot;)[0]
CARLA_world.ego_vehicle = CARLA_world.carla_world.spawn_actor(bp3, spawn_point3)
</code></pre></div>
<h3 id="_4">初始化相机</h3>
<p>​   将相机附加到自车上，并设置回调函数处理相机图像。</p>
<div class="highlight"><pre><span></span><code>camera_init_trans = carla.Transform(carla.Location(x=-10, y=-4, z=3), carla.Rotation(pitch=-20))
camera_bp = CARLA_world.carla_world.get_blueprint_library().find(&#39;sensor.camera.rgb&#39;)
camera_bp.set_attribute(&#39;image_size_x&#39;, str(VIEW_WIDTH))
camera_bp.set_attribute(&#39;image_size_y&#39;, str(VIEW_HEIGHT))
camera_bp.set_attribute(&#39;fov&#39;, str(VIEW_FOV))
camera = CARLA_world.carla_world.spawn_actor(camera_bp, camera_init_trans, attach_to=CARLA_world.ego_vehicle)
renderObject = RenderObject(VIEW_WIDTH, VIEW_HEIGHT)
camera.listen(lambda image: pygame_callback(image, renderObject))
</code></pre></div>
<h3 id="pygame">初始化 Pygame</h3>
<p>​   初始化Pygame窗口，并设置相应标题。</p>
<div class="highlight"><pre><span></span><code>pygame.init()
gameDisplay = pygame.display.set_mode((VIEW_WIDTH, VIEW_HEIGHT), pygame.HWSURFACE | pygame.DOUBLEBUF)
pygame.display.set_caption(&quot;Camera View&quot;)
</code></pre></div>
<h3 id="_5">轨迹规划和控制</h3>
<p>​   使用RRT算法进行轨迹规划，并通过PID控制器进行车辆路径跟踪。</p>
<div class="highlight"><pre><span></span><code>goal = CARLA_world.map.get_waypoint(carla.Location(x=444, y=-14), project_to_road=True)
CARLA_world.carla_world.tick()
trans = CARLA_world.vehicles[0].get_transform()
v_obs = 7.8
obstacles = [trans, v_obs]
RRT_planner = RRT_VO(CARLA_world, goal, obstacles)
RRT_planner.RRT_star(n_pts=1000)
path = RRT_planner.path

path_x = []
path_y = []
trans = CARLA_world.ego_vehicle.get_transform()
thetai = trans.rotation.yaw * math.pi / 180
final_theta = thetai

for i in range(len(path) - 1):
    if i == len(path) - 2:
        thetaf = final_theta
    else:
        x1, y1 = path[i + 1].x, path[i + 1].y
        x2, y2 = path[i + 2].x, path[i + 2].y
        thetaf = math.atan2((y2 - y1), (x2 - x1))

    primitive = motion_primitive(thetai, thetaf, path[i].x,
                                 path[i + 1].x, path[i].y,
                                 path[i + 1].y)
    primitive.cubic_T_Matrix()
    primitive.trajectory()

    pos_x, pos_y = primitive.get_path(0.05)
    path_x += pos_x
    path_y += pos_y
    thetai = thetaf
</code></pre></div>
<h3 id="_6">循环移动</h3>
<p>​   在 <strong>Pygame</strong> 窗口中显示相机视角，并根据RRT规划的路径控制车辆移动。</p>
<div class="highlight"><pre><span></span><code>controller = VehiclePIDController(CARLA_world.ego_vehicle, [1.0, 0.05, 0.1], [0.5, 0.05, 0.1])
controller_obs = VehiclePIDController(CARLA_world.vehicles[0], [1.0, 0.05, 0.1], [0.5, 0.05, 0.1])
actual_x = []
actual_y = []
ti = time.time()
for i in range(len(path_x) - 1):
    trans = CARLA_world.ego_vehicle.get_transform()
    loc_x, loc_y = trans.location.x, trans.location.y
    w_x, w_y = path_x[i], path_y[i]
    w_x2, w_y2 = path_x[i + 1], path_y[i + 1]
    phi = math.atan2((w_y2 - w_y), (w_x2 - w_x))

    physics = CARLA_world.ego_vehicle.get_physics_control()
    wheels = physics.wheels
    wheel_F_x = (wheels[0].position.x + wheels[1].position.x) / 200
    wheel_F_y = (wheels[0].position.y + wheels[1].position.y) / 200

    while ((wheel_F_x - w_x2) ** 2 + (wheel_F_y - w_y2) ** 2) ** 0.5 &gt;= 0.5:
        control = controller.run_step(RRT_planner.v * 3.6 / 3)
        control_obs = controller_obs.run_step(v_obs * 3.6 / 3)

        p1 = np.array([w_x, w_y])
        p2 = np.array([w_x2, w_y2])
        p3 = np.array([wheel_F_x, wheel_F_y])
        trans = CARLA_world.ego_vehicle.get_transform()
        yaw = trans.rotation.yaw
        phi = math.atan2((w_y2 - w_y), (w_x2 - w_x)) - yaw * (math.pi / 180)
        d = np.cross(p2 - p1, p3 - p1) / np.linalg.norm(p2 - p1)

        kp = 3
        ks = 0.2
        Vel = CARLA_world.ego_vehicle.get_velocity()
        v = math.sqrt(Vel.x ** 2 + Vel.y ** 2)
        control.steer = (-math.atan2(kp * d,
</code></pre></div>
<p>​   轨迹如下：图中蓝色的曲线表示车辆从起点到终点的行驶路径。从图中可以看出，车辆先是沿着x轴向右行驶，然后检测到障碍物后开始向左下方转弯，最后到达终点。</p>
<p><img alt="" src="../../img/traffic_course_img/6.png" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
