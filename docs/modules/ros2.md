# CARLA 仿真平台 ROS2 模块说明文档

## 一、模块简介

CARLA 仿真平台中的 `ros2` 模块是连接 CARLA 仿真环境与 ROS 2 系统的重要桥梁。通过该模块，可以实现在仿真过程中从 ROS 2 系统接收控制指令、向 ROS 2 发布仿真数据（如传感器信息、车辆状态等），从而将 CARLA 与现实中的机器人或自动驾驶系统无缝衔接。

该模块基于 C++ 开发，主要负责：

- 初始化 ROS 2 节点；
- 注册并管理话题的发布者与订阅者；
- 在仿真循环中实时与 ROS 2 网络交互；
- 提供结构化的数据回调接口，以实现灵活的扩展。

---

## 二、核心功能

1. **ROS 2 节点初始化与生命周期管理**  
   模块中封装了完整的 ROS 2 启动、运行与关闭流程，确保仿真过程与 ROS 2 网络始终同步。

2. **数据发布机制**  
   支持向 ROS 2 发布车辆状态、传感器数据、变换信息等多种消息类型，支持标准话题命名规范。

3. **指令订阅机制**  
   支持从 ROS 2 接收控制指令（如速度、转向、刹车等），并将其应用于 CARLA 中的实体。

4. **仿真周期处理**  
   通过 `Tick()` 函数在每一帧中自动处理消息的发布与接收，实现高频率数据同步。

5. **数据结构封装与扩展性设计**  
   使用 `ROS2CallbackData` 等结构体统一封装 ROS 消息数据，方便在回调函数中对实体进行访问与操作。

---

## 三、主要类与结构说明

### 1. ROS2 类（核心接口）

定义文件：`ROS2.h`  
实现文件：`ROS2.cpp`

该类是模块的核心，负责 ROS 2 节点的生命周期管理与数据交互逻辑。

主要方法说明：

- `Init()`  
  初始化 ROS 2 节点，注册所有的发布者与订阅者。

- `Tick()`  
  每帧调用一次，用于处理订阅回调及发布当前帧仿真数据。

- `Shutdown()`  
  仿真结束时调用，关闭 ROS 2 节点并释放资源。

### 2. ROS2CallbackData 结构体

定义文件：`ROS2CallbackData.h`

该结构体用于封装 ROS 2 的回调上下文数据，如接收到的消息、目标实体的指针、消息时间戳等。

示例定义：

```cpp
struct ROS2CallbackData {
    carla::SharedPtr<carla::client::Actor> actor;
    rclcpp::Time time;
    geometry_msgs::msg::TransformStamped transform;
};
```
---

# 四、常用参数说明

模块支持通过参数进行行为配置，以下是常见参数项说明：

| 参数名       | 功能说明                   | 示例值                       |
| ------------ | -------------------------- | ---------------------------- |
| node_name    | 设置 ROS 2 节点的名称      | "carla_ros2_node"            |
| publish_rate | 控制数据发布的频率（单位：Hz） | 20                           |
| topics       | 指定发布和订阅的 ROS 话题名称 | "/carla/ego_vehicle/cmd"     |

用户可通过启动参数或配置文件进行动态设置，以适配不同仿真需求。

# 五、开发与使用建议

为了更高效稳定地使用 ros2 模块，建议在开发过程中注意以下事项：

- 推荐使用 MultiThreadedExecutor 支持高频多线程 ROS 消息处理；
- 在仿真主循环中始终调用 Tick() 方法，以确保 ROS 消息同步；
- 所有访问到的实体（Actor）在回调中应检查有效性，避免空指针异常；
- 话题命名应符合 ROS 2 命名规范，方便系统集成与可视化；
- 若需扩展支持新的消息类型或控制逻辑，可基于 ROS2CallbackData 添加自定义字段与处理函数；
- 为保证性能和可维护性，建议每类功能独立注册发布者/订阅者，避免接口混用。
