<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CARLA Docker 开发环境 (Ubuntu 22.04) - 人车模拟</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CARLA Docker \u5f00\u53d1\u73af\u5883 (Ubuntu 22.04)";
        var mkdocs_page_input_path = "build/build_docker_ubuntu22.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> 人车模拟
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">人车模拟</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">CARLA Docker 开发环境 (Ubuntu 22.04)</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/OpenHUTB/doc/edit/master/docs/build/build_docker_ubuntu22.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="carla-docker-ubuntu-2204">CARLA Docker 开发环境 (Ubuntu 22.04)</h1>
<p>此存储库提供了 <strong>2 种</strong> 不同的基于 Docker 的方法，用于在 <strong>Ubuntu Jammy（22.04）</strong> 上构建和运行 <strong>CARLA（版本 UE4）</strong>：</p>
<ol>
<li><strong>整体(Monolithic)</strong>  </li>
<li>将虚幻引擎 (UE4) 和 CARLA 捆绑到单个 Docker 镜像中。  </li>
<li>需要漫长的构建过程并产生较大的最终图像（通常 100+ GB）。  </li>
<li>
<p>创建一个完全独立的环境，所有内容都在 Docker 内部编译。</p>
</li>
<li>
<p><strong>轻量级 Devcontainer</strong></p>
</li>
<li>仅安装编译和运行 CARLA 所需的依赖项（加上 NVIDIA 支持）。 </li>
<li>需要将现有的 <strong>UE4</strong> 构建从主机安装到容器中（请参阅 <a href="#build-ue4-prerequisite-for-lightweight--devcontainer">为 Devcontainer 选项构建 UE4</a> ）。 </li>
<li>构建速度更快，但依赖于本地编译的虚幻引擎文件夹。</li>
</ol>
<p>在<strong>整体</strong>和<strong>轻量级</strong>之间的选择主要取决于磁盘空间、构建时间以及您是否喜欢完全独立的环境（整体）或重用本地编译的虚幻引擎（轻量级）的设置。</p>
<hr />
<h2 id="_1">概述</h2>
<p><code>Scripts/</code> 目录中的两个主要脚本负责管理 Docker 容器的构建和启动：</p>
<ol>
<li><strong><code>run_container.sh</code></strong>  </li>
<li>通过 <code>--monolith</code>（或 <code>-m</code>）参数检测<strong>整体</strong>或<strong>轻量级</strong>模式。</li>
<li>
<p>如果存在 <code>--monolith</code> ，则使用 <code>carla-ue4.dockerfile</code>（整体）。否则，默认为 <code>carla.dockerfile</code>（轻量级）。</p>
</li>
<li>
<p><strong><code>build_image.sh</code></strong>  </p>
</li>
<li>一般由<code>run_container.sh</code>间接调用。</li>
<li>检查是否提供了 <code>--monolith</code> 并选择相应的 Dockerfile。 </li>
<li>处理在单片模式下克隆和构建虚幻引擎所需的 Epic 凭证（来自 <code>.env</code> 文件）。 </li>
</ol>
<hr />
<h2 id="utildocker-dockerfiles"><code>Util/Docker/</code> 中的容器文件(Dockerfiles)</h2>
<h3 id="carladockerfile-devcontainer"><code>carla.dockerfile</code> (轻量级开发容器 Devcontainer)</h3>
<ul>
<li>仅安装 CARLA 依赖项以及 NVIDIA GPU 支持。  </li>
<li><strong>不包括</strong>虚幻引擎；相反，必须通过 <code>UE4_ROOT</code> 从主机安装预编译的 UE4 文件夹（符合 Carla 的要求）。 </li>
<li>非常适合已经拥有兼容 Carla 的 UE4 构建并希望使用更小的镜像进行更快构建的开发人员。 </li>
</ul>
<h3 id="carla-ue4dockerfile"><code>carla-ue4.dockerfile</code> (整体)</h3>
<ul>
<li>从 Epic 的私有 GitHub 克隆虚幻引擎（需要有效的 Epic 凭证）。如果您尚未设置，<strong>请先按照 <a href="https://www.unrealengine.com/en-US/ue4-on-github">本指南</a> 操作</strong> 。</li>
<li>在单个 Docker 镜像中编译 UE4 和 CARLA，该镜像可能超过 100 GB 并且需要数小时才能构建。  </li>
<li>该镜像<strong>保留了</strong> <code>Dist/</code> 目录，与 <code>CarlaLegacy.Dockefile</code> 相比，您无需使用 <code>docker_tools.py</code> 等额外脚本即可运行或提取打包的 CARLA 二进制文件。虽然这会使最终镜像体积较大，但现代硬件通常拥有足够的资源（例如更大的 SSD、更多的 RAM）来处理这种规模。此外，它还消除了反复重建或依赖外部工具的需要。</li>
</ul>
<p>您可以使用简单的 Docker 命令序列从整体镜像中提取 CARLA 包（将 <code>0.9.15.2</code> 替换为您的 CARLA 版本）：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>temp_container<span class="w"> </span>carla-0.9.15.2-ue4-jammy-dev
docker<span class="w"> </span>cp<span class="w"> </span>temp_container:/workspaces/carla-0.9.15.2/Dist/CARLA_<span class="k">$(</span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>carla-0.9.15.2-ue4-jammy-dev<span class="w"> </span>ls<span class="w"> </span>/workspaces/carla-0.9.15.2/Dist<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>CARLA_<span class="k">)</span>.tar.gz<span class="w"> </span>.
docker<span class="w"> </span>rm<span class="w"> </span>temp_container
</code></pre></div>
<p>如果担心磁盘使用情况并且不需要最终打包的工件，则可以注释掉 <code>carla-ue4.dockerfile</code> 中的 <code>make build.utils</code> 和 <code>make package</code>，或者切换到轻量级方法。</p>
<hr />
<h2 id="ue4-devcontainer">构建 UE4 (轻量级开发容器 Devcontainer 的先决条件)</h2>
<blockquote>
<p>注意: 在尝试克隆之前，请确保您的 GitHub 帐户已链接到 Epic 的 UnrealEngine 存储库。</p>
</blockquote>
<p>如果您计划使用<strong>轻量级</strong>方法，则需要在主机上安装一个符合 CARLA 要求（通常为 UE4.26）的<strong>已编译</strong>虚幻引擎文件夹。您有以下两个选项：</p>
<h3 id="1">选项 1：本地构建</h3>
<p>关注 CARLA 官方文档：<a href="https://carla.readthedocs.io/en/latest/build_linux/#:~:text=wheel%20auditwheel%3D%3D4.0.0-,Unreal%20Engine,-Starting%20with%20version">Unreal Engine - Linux Build</a></p>
<h3 id="2-ue4">选项 2: 在构建容器中构建 UE4</h3>
<p>以下步骤概述了在 Docker 容器内构建 UE4 的常规工作流程。有关详细说明，请参阅克隆存储库中的 <code>Engine/Documentation/Docker/run_with_docker.md</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 克隆自定义 CarlaUnrealEngine 存储库的示例</span>
git<span class="w"> </span>clone<span class="w"> </span>git@github.com:wambitz/CarlaUnrealEngine.git<span class="w"> </span>CarlaUE4

<span class="nb">cd</span><span class="w"> </span>CarlaUE4
Scripts/run_container.sh

<span class="c1"># 在容器内遵循官方 UE4.26 构建步骤：</span>
./Setup.sh
./GenerateProjectFiles.sh
make

<span class="c1"># 退出容器</span>
<span class="nb">exit</span>
</code></pre></div>
<p>这些命令会生成所需的虚幻引擎二进制文件，并将其永久存储在您的主机上。您稍后可以在 CARLA 开发容器中重复使用它们。要验证编译是否成功，请在容器内部（或可选地在容器外部）运行以下命令：</p>
<h2 id="enginebinarieslinuxue4editor"><div class="highlight"><pre><span></span><code>Engine/Binaries/Linux/UE4Editor
</code></pre></div></h2>
<h2 id="_2">脚本使用</h2>
<h3 id="1_1">1. 轻量级模式</h3>
<p>此模式依赖于<strong>本地编译</strong>的虚幻引擎文件夹。您需要将该文件夹挂载到用于构建 CARLA 的容器中。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1) 将 UE4_ROOT 设置为主机上现有的 UE4 文件夹：</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">UE4_ROOT</span><span class="o">=</span>/absolute/path/to/UnrealEngine_4.26

<span class="c1"># 2) 不使用 --monolith 标志运行容器：</span>
./Scripts/run_container.sh

<span class="c1"># 3) 进入容器后，照常构建 CARLA：</span>
./Update.sh
make<span class="w"> </span>PythonAPI
make<span class="w"> </span>CarlaUE4Editor

<span class="c1"># 可选择构建以供分发：</span>
make<span class="w"> </span>build.utils
make<span class="w"> </span>package
</code></pre></div>
<ul>
<li><strong>结果</strong>：  </li>
<li>使用 <strong><code>carla.dockerfile</code></strong> (轻量级)。  </li>
<li>将主机的 <code>$UE4_ROOT</code> 文件夹挂载到容器内的 <code>/opt/UE4.26</code> 中。 </li>
<li>需要在主机上安装已完全编译的 UE4。更多详情，请参阅 <a href="#build-ue4-prerequisite-for-lightweight--devcontainer">为 Devcontainer 选项构建 UE4</a> 。 </li>
</ul>
<h3 id="2">2. 整体模式</h3>
<p>在这种模式下，Docker 克隆并构建虚幻引擎，然后在同一镜像中编译 CARLA。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1) 在 repo 根目录下使用您的 Epic 凭证创建一个 .env 文件：</span>
<span class="c1">#    EPIC_USER=YourGitHubUsername</span>
<span class="c1">#    EPIC_PASS=YourGitHubToken</span>

<span class="c1"># 2) 使用 --monolith 标志运行容器：</span>
./Scripts/run_container.sh<span class="w"> </span>--monolith
</code></pre></div>
<ul>
<li><strong>结果</strong>：  </li>
<li>使用 <strong><code>carla-ue4-monolith.dockerfile</code></strong>。  </li>
<li>在一个 Docker 镜像中构建 UE4 和 CARLA（通常超过 200 GB）。 </li>
<li>在大多数硬件上需要花费大量时间（数小时）。</li>
</ul>
<hr />
<h2 id="devcontainer-carla">使用 Devcontainer 进行 CARLA 服务器/客户端开发</h2>
<p>您可以使用 <strong>Visual Studio Code devcontainer</strong>，并采用轻量级方法。此设置会将主机目录（包括 UE4）挂载到 Docker 环境中。请注意，整体镜像不太适合开发容器，因为它会将所有内容存储在镜像中。</p>
<p>在您的 CARLA 存储库中创建 <code>.devcontainer/devcontainer.json</code>：</p>
<div class="highlight"><pre><span></span><code>{
    &quot;name&quot;: &quot;CARLA UE4 Dev (jammy)&quot;,
    &quot;image&quot;: &quot;carla-ue4-jammy-dev&quot;,

    &quot;initializeCommand&quot;: &quot;./Scripts/build_image.sh&quot;,

    // We do NOT need to set &quot;remoteUser&quot; if the Dockerfile&#39;s default user is already correct
    // but you can if you want to be explicit. Also &quot;updateRemoteUserUID&quot; can be false, since
    // our Dockerfile already set the user to our exact UID/GID.
    &quot;updateRemoteUserUID&quot;: false,

    &quot;customizations&quot;: {
      &quot;vscode&quot;: {
        &quot;settings&quot;: {
          &quot;terminal.integrated.shell.linux&quot;: &quot;bash&quot;
        },
        &quot;extensions&quot;: [
          &quot;ms-vscode.cpptools&quot;
        ]
      }
    },

    &quot;postStartCommand&quot;: &quot;bash&quot;,

    // NOTE1: DO NOT pass --user here (we want the Dockerfile default user, not an override)
    // NOTE2: Make sure /usr/share/vulkan/icd.d/nvidia_icd.json exist in the host
    // NOTE3: Ensure UE4_ROOT environment variable is defined in host
    &quot;runArgs&quot;: [
      &quot;--rm&quot;,
      &quot;--name&quot;, &quot;carla-ue4-jammy-devcontainer&quot;,
      &quot;--hostname&quot;, &quot;carla-devcontainer&quot;,
      &quot;--env&quot;, &quot;DISPLAY=${localEnv:DISPLAY}&quot;,
      &quot;--volume&quot;, &quot;/tmp/.X11-unix:/tmp/.X11-unix&quot;,
      &quot;--volume&quot;, &quot;/usr/share/vulkan/icd.d/nvidia_icd.json:/usr/share/vulkan/icd.d/nvidia_icd.json&quot;,
      &quot;--volume&quot;, &quot;${localEnv:UE4_ROOT}:/opt/UE4.26&quot;,
      &quot;--gpus&quot;, &quot;all&quot;
    ]
}
</code></pre></div>
<h3 id="devcontainer">重要的 Devcontainer 说明</h3>
<ol>
<li><strong>GPU 访问</strong>: 安装并配置 <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html">NVIDIA Container Toolkit</a> 。</li>
<li><strong>X11 转发</strong>: 确保 <code>/tmp/.X11-unix</code> 可访问并且主机上的 <code>DISPLAY</code> 设置正确。 </li>
<li><strong>UE4_ROOT 环境变量</strong>: 必须在您的主机上定义，以便 devcontainer 可以挂载 UE4 目录。</li>
<li><strong>Vulkan 支持</strong>: <code>/usr/share/vulkan/icd.d/nvidia_icd.json</code> 必须存在于您的主机中，以便 devcontainer 可以挂载 vulkan 配置。</li>
</ol>
<hr />
<h2 id="_3">提示和注意事项</h2>
<ul>
<li>
<p><strong>NVIDIA GPU</strong><br />
  对于硬件加速，请安装 <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html">NVIDIA Container Toolkit</a>.</p>
</li>
<li>
<p><strong>磁盘空间</strong><br />
  完整镜像可能超过 <strong>200 GB</strong>（例如，某些版本约为 221 GB）。在选择此方案之前，请确保您有足够的空间。</p>
</li>
<li>
<p><strong>构建时间</strong>  </p>
</li>
<li>完整模式：在高端工作站（例如，Intel Core i9-14900KF、64 GB RAM、RTX 4090）上大约需要 2 小时。  </li>
<li>
<p>轻量级模式：由于重用了本地 UE4 构建，因此速度更快。</p>
</li>
<li>
<p><strong>卷</strong><br />
  对于轻量级模式，<code>$UE4_ROOT</code> 必须指向已完全编译的 UE4。如果错误或缺失，构建将失败。</p>
</li>
<li>
<p><strong>Epic 凭证</strong><br />
  在单片模式下，将 <code>EPIC_USER</code> 和 <code>EPIC_PASS</code> 存储在项目根目录中的 <code>.env</code> 文件中。</p>
</li>
<li>
<p><strong>在主机上运行二进制文件</strong><br />
  在容器中构建后，<strong>请勿</strong>在主机上运行 <code>make launch</code> 或 <code>make launch-only</code>，因为内部容器路径（例如，<code>/opt/UE4.26</code>）与您的主机环境不匹配。<br />
  如果您需要主机访问 CARLA 二进制文件，请首先构建一个发行包（<code>make build.utils &amp;&amp; make package</code>），然后从主机上的 <code>Dist/</code> 中的结果文件运行它们。</p>
</li>
<li>
<p><strong>挂载目录</strong><br />
  如果您使用的是 VS Code devcontainers，请避免修改 <code>/workspaces</code>，因为这可能会强制重新构建。容器的内部路径通常与主机不同，因此直接在主机上启动会出现问题。</p>
</li>
<li>
<p><strong><code>Dist</code> 文件夹处理</strong><br />
   整体模式保留 <code>Dist</code> 以便直接使用。如果您需要较小的镜像，请删除或调整 <code>make build.utils</code> 和 <code>make package</code>。 </p>
</li>
</ul>
<hr />
<h2 id="_4">已知问题</h2>
<ol>
<li>
<p><strong><code>./Update.sh</code> 中的输出被截断</strong><br />
   有时，CARLA 存储库中的 <code>./Update.sh</code> 可能会截断日志。一种解决方法是将输出重定向到文件并对其进行尾部处理。</p>
</li>
<li>
<p><strong>音频支持</strong><br />
   ALSA 或 PulseAudio 未预先配置，因此音频功能可能默认不起作用。</p>
</li>
<li>
<p><strong>UE4Editor 重新构建</strong><br />
   在某些情况下，一旦打开 <code>UE4Editor</code>（内置于 UE4.26）或使用其构建 CARLA，它可能会拒绝再次打开，除非重新构建。可能会出现缺少插件的错误，这种情况在本地（非 Docker）设置中也会出现。解决方法是使用容器或开发容器从存储库重新构建，或者仔细调整配置文件。</p>
</li>
</ol>
<hr />
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/OpenHUTB/doc" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
